!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("three"),require("lodash"),require("html2canvas"),require("3d-tiles-renderer")):"function"==typeof define&&define.amd?define(["three","lodash","html2canvas","3d-tiles-renderer"],t):(e="undefined"!=typeof globalThis?globalThis:e||self)["gl-layers"]=t(e.THREE,e._,e.html2canvas,e._3dTilesRenderer)}(this,(function(e,t,n,r){"use strict";function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function a(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var o=a(e),s=i(t),l=i(n);function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function c(e,t,n,r,i,a,o){try{var s=e[a](o),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,i)}function h(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var a=e.apply(t,n);function o(e){c(a,r,i,o,s,"next",e)}function s(e){c(a,r,i,o,s,"throw",e)}o(void 0)}))}}function d(e,t,n){return t=y(t),M(e,x()?Reflect.construct(t,n||[],y(e).constructor):t.apply(e,n))}function f(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function p(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,C(r.key),r)}}function v(e,t,n){return t&&p(e.prototype,t),n&&p(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function m(e,t,n){return(t=C(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function g(){return g="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,n){var r=function(e,t){for(;!{}.hasOwnProperty.call(e,t)&&null!==(e=y(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}},g.apply(null,arguments)}function y(e){return y=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},y(e)}function _(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&T(e,t)}function x(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(x=function(){return!!e})()}function w(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function b(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?w(Object(n),!0).forEach((function(t){m(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):w(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function M(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function A(){A=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,i=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",l=a.toStringTag||"@@toStringTag";function u(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,n){return e[t]=n}}function c(e,t,n,r){var a=t&&t.prototype instanceof g?t:g,o=Object.create(a.prototype),s=new P(r||[]);return i(o,"_invoke",{value:k(e,n,s)}),o}function h(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=c;var d="suspendedStart",f="suspendedYield",p="executing",v="completed",m={};function g(){}function y(){}function _(){}var x={};u(x,o,(function(){return this}));var w=Object.getPrototypeOf,b=w&&w(w(E([])));b&&b!==n&&r.call(b,o)&&(x=b);var M=_.prototype=g.prototype=Object.create(x);function T(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function S(e,t){function n(i,a,o,s){var l=h(e[i],e,a);if("throw"!==l.type){var u=l.arg,c=u.value;return c&&"object"==typeof c&&r.call(c,"__await")?t.resolve(c.__await).then((function(e){n("next",e,o,s)}),(function(e){n("throw",e,o,s)})):t.resolve(c).then((function(e){u.value=e,o(u)}),(function(e){return n("throw",e,o,s)}))}s(l.arg)}var a;i(this,"_invoke",{value:function(e,r){function i(){return new t((function(t,i){n(e,r,t,i)}))}return a=a?a.then(i,i):i()}})}function k(t,n,r){var i=d;return function(a,o){if(i===p)throw Error("Generator is already running");if(i===v){if("throw"===a)throw o;return{value:e,done:!0}}for(r.method=a,r.arg=o;;){var s=r.delegate;if(s){var l=C(s,r);if(l){if(l===m)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===d)throw i=v,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=p;var u=h(t,n,r);if("normal"===u.type){if(i=r.done?v:f,u.arg===m)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(i=v,r.method="throw",r.arg=u.arg)}}}function C(t,n){var r=n.method,i=t.iterator[r];if(i===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,C(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var a=h(i,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,m;var o=a.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,m):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function R(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function L(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function P(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(R,this),this.reset(!0)}function E(t){if(t||""===t){var n=t[o];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,a=function n(){for(;++i<t.length;)if(r.call(t,i))return n.value=t[i],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError(typeof t+" is not iterable")}return y.prototype=_,i(M,"constructor",{value:_,configurable:!0}),i(_,"constructor",{value:y,configurable:!0}),y.displayName=u(_,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,u(e,l,"GeneratorFunction")),e.prototype=Object.create(M),e},t.awrap=function(e){return{__await:e}},T(S.prototype),u(S.prototype,s,(function(){return this})),t.AsyncIterator=S,t.async=function(e,n,r,i,a){void 0===a&&(a=Promise);var o=new S(c(e,n,r,i),a);return t.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},T(M),u(M,l,"Generator"),u(M,o,(function(){return this})),u(M,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=E,P.prototype={constructor:P,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(L),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function i(r,i){return s.type="throw",s.arg=t,n.next=r,i&&(n.method="next",n.arg=e),!!i}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],s=o.completion;if("root"===o.tryLoc)return i("end");if(o.tryLoc<=this.prev){var l=r.call(o,"catchLoc"),u=r.call(o,"finallyLoc");if(l&&u){if(this.prev<o.catchLoc)return i(o.catchLoc,!0);if(this.prev<o.finallyLoc)return i(o.finallyLoc)}else if(l){if(this.prev<o.catchLoc)return i(o.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return i(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var a=i;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var o=a?a.completion:{};return o.type=e,o.arg=t,a?(this.method="next",this.next=a.finallyLoc,m):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),L(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;L(n)}return i}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:E(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),m}},t}function T(e,t){return T=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},T(e,t)}function S(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,a,o,s=[],l=!0,u=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=a.call(n)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){u=!0,i=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(u)throw i}}return s}}(e,t)||L(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function k(e){return function(e){if(Array.isArray(e))return u(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||L(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function C(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function R(e){return R="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},R(e)}function L(e,t){if(e){if("string"==typeof e)return u(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?u(e,t):void 0}}var P=function(){return v((function e(){f(this,e),m(this,"eventMap",{})}),[{key:"addEventListener",value:function(e,t){return this.eventMap[e]||(this.eventMap[e]=[]),this.eventMap[e].push(t),this}},{key:"on",value:function(e,t){return this.addEventListener(e,t),this}},{key:"removeEventListener",value:function(e,t){if(!this.eventMap[e])return this;var n=this.eventMap[e].findIndex((function(e){return e===t}));return n>-1&&this.eventMap[e].splice(n,1),this}},{key:"off",value:function(e,t){return this.removeEventListener(e,t),this}},{key:"handleEvent",value:function(e,t){for(var n=this.eventMap[e]||[],r=0;r<n.length;r++)"function"==typeof n[r]&&n[r].apply(n[r],[t,this]);return this}}])}(),E=0,I=null,O=function(e){function t(e){var n,r;if(f(this,t),m(r=d(this,t),"id",null),m(r,"title",""),m(r,"_canvas",null),m(r,"composer",null),m(r,"_conf",{renderOption:{antialias:!1,precision:"highp"},alone:!0,zIndex:120,visible:!0}),m(r,"_zooms",[3,22]),m(r,"_isAnimate",!0),m(r,"_center",null),m(r,"_raycaster",null),m(r,"_interactAble",!1),m(r,"_visible",!0),m(r,"_baseURL","."),m(r,"_pickEvent",null),m(r,"_intensity",.3),r._conf=s.default.merge(r._conf,e),void 0===e.map||null==e.map||"function"!=typeof e.map.getContainer)throw Error("config.map invalid");if(r.map=e.map,r.container=e.container||e.map.getContainer(),!r.container)throw Error("config.container invalid");if(r._interactAble=null!==(n=e.interact)&&void 0!==n&&n,r.customCoords=r.map.customCoords,r.layer=null,delete r._conf.data,r.id=e.id||(new Date).getTime().toString(),r.title=e.title||"",e.zooms&&(r._zooms=e.zooms),void 0!==e.animate&&(r._isAnimate=e.animate),e.center)r.updateCenter(e.center),r._center=e.center;else{var i=r.map.getCenter(),a=i.lng,o=i.lat;r.updateCenter([a,o]),r._center=[a,o]}return r.reviseVisible(),"number"==typeof e.intensity&&(r._intensity=e.intensity),void 0!==e.baseURL&&(r._baseURL=e.baseURL),e.pickEvent||(r._pickEvent=e.pickEvent||"mousemove"),r.handleOnRay=s.default.debounce(r.onRay,100,!0),r.bindMethods(["animate","resizeLayer","handleOnRay"]),r.camera=null,r.renderer=null,r.scene=null,r.eventMap={},r.preparea(),r}return _(t,e),v(t,[{key:"preparea",value:(r=h(A().mark((function e(){return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.initZooms(),this.addModuleListener(),e.next=4,this.initLayer();case 4:this.onReady(),this._initInteract(),this.animate(),this.handleEvent("complete",this);case 8:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"onReady",value:function(){throw Error("该方法只能被子类重写")}},{key:"onRender",value:function(){}},{key:"update",value:function(){}},{key:"beforeDestroy",value:function(){}},{key:"createHelper",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[0,0,0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:15e3,n=new o.AxesHelper(t),r=S(e,3),i=r[0],a=r[1],s=r[2];n.position.set(i,a,s),this.scene.add(n)}},{key:"queryFeature",value:function(e){var t=this;return new Promise((function(n){n(t.onRay(e))}))}},{key:"destroy",value:function(){for(var e in"function"==typeof this.beforeDestroy&&this.beforeDestroy(),this.removeModuleListener(),this.layer&&(this.layer.hide(),this.map.remove(this.layer)),this.scene&&(this.scene.traverse((function(e){e.material&&e.material.dispose(),e.geometry&&e.geometry.dispose()})),this.scene=null),this.renderer&&(this.camera=null,this.renderer.clear(),this.renderer.dispose(),this.renderer=null),this)delete this[e];(E-=1)<=0&&(I.destroy(),I=null,E=0)}},{key:"setCenter",value:function(e){this._center=e}},{key:"setVisible",value:function(e){this._conf.visible=!0===e,this.reviseVisible()}},{key:"getVisible",value:function(){return this._visible}},{key:"reviseVisible",value:function(e){var t;return(t=!!this.isInZooms()&&("boolean"!=typeof e||e))!==this._visible&&(this.handleEvent("visibleChange",t),!1===t&&this.renderer&&this.renderer.clear()),this._visible=t,this._visible}},{key:"updateCenter",value:function(e){e instanceof Array&&this.customCoords.setCenter(e),this._center=this.customCoords.getCenter()}},{key:"initThree",value:function(e){var t=this.container,n=t.clientWidth,r=t.clientHeight;this.camera=new o.PerspectiveCamera(60,n/r,100,1<<30);var i=this._conf.renderOption,a={alpha:!0,antialias:i.antialias,precision:i.precision};this._conf.alone?a.context=this._canvas.getContext("webgl"):a.context=e;var s=new o.WebGLRenderer(a);if(s.autoClear=!1,s.setClearAlpha(0),s.shadowMap.enabled=!0,s.shadowMap.type=o.PCFSoftShadowMap,s.setSize(n,r),s.setPixelRatio(window.devicePixelRatio),this.renderer=s,this.scene=new o.Scene,this._intensity>0){var l=new o.AmbientLight(16777215,this._intensity);this.scene.add(l)}}},{key:"initLayer",value:(n=h(A().mark((function e(){return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._conf.alone){e.next=6;break}return e.next=3,this.createCustomLayer();case 3:this.layer=e.sent,e.next=9;break;case 6:return e.next=8,this.createGlCustomLayer();case 8:this.layer=e.sent;case 9:this._conf.visible?this.layer.show():this.layer.hide();case 10:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"createCustomLayer",value:function(){var e=this;return new Promise((function(t){if(I)e._canvas=I.canvas,e.initThree(),e.updateCenter(e._center);else{var n=e.container,r=n.clientWidth,i=n.clientHeight;e._canvas=document.createElement("canvas"),e._canvas.id="gl-layers",e._canvas.width=r,e._canvas.height=i,e._canvas.style.cssText="width: ".concat(r,"px; height: ").concat(i,"px;");var a=new AMap.CustomLayer(e._canvas,{visible:!0,zIndex:e._conf.zIndex,alwaysRender:!0});e.initThree(),e.updateCenter(e._center),a.render=function(){null!=e.renderer&&e.onRender()},e.map.add(a),I=a}E+=1,t(I)}))}},{key:"createGlCustomLayer",value:function(){var e=this;return new Promise((function(t){var n=new AMap.GLCustomLayer({zIndex:e._conf.zIndex,visible:!0,init:function(r){e.initThree(r),e.updateCenter(e._center),e.reviseVisible(),t(n)},render:function(t){e.updateCamera(),e.onRender()}});e.map.add(n)}))}},{key:"updateCamera",value:function(){var e,t,n=this.scene,r=this.renderer,i=this.camera,a=this.customCoords;if(r){r.resetState(),this._center&&a.setCenter(this._center);var o=a.getCameraParams(),s=o.near,l=o.far,u=o.fov,c=o.up,h=o.lookAt,d=o.position;i.near=s,i.far=l,i.fov=u,(e=i.position).set.apply(e,k(d)),(t=i.up).set.apply(t,k(c)),i.lookAt.apply(i,k(h)),i.updateProjectionMatrix(),this.composer?this.composer.render():this._visible&&r.render(n,i),r.resetState()}}},{key:"animate",value:function(e){this.renderer&&(this.update&&this.update(e),this._conf.alone?this.updateCamera():this.map&&this.map.render(),requestAnimationFrame(this.animate))}},{key:"_initInteract",value:function(){!1!==this._interactAble&&(this._raycaster=new o.Raycaster,this._pickEvent&&this.container.addEventListener(this._pickEvent,this.handleOnRay))}},{key:"onRay",value:function(e){var t=this.scene,n=this.camera;if(t){var r=this.setPickPosition(e);this._raycaster.setFromCamera(r,n);var i=this._raycaster.intersectObjects(t.children,!0);return"function"==typeof this.onPicked&&this._interactAble&&this._visible&&this.onPicked.apply(this,[{targets:i,event:e}]),i}}},{key:"setPickPosition",value:function(e){var t={x:0,y:0},n=this.container.getBoundingClientRect();return t.x=e.clientX/n.width*2-1,t.y=e.clientY/n.height*-2+1,t}},{key:"initZooms",value:function(){var e=this;this.map.on("zoomend",(function(t){e.reviseVisible()}))}},{key:"isInZooms",value:function(){var e=this.map.getZoom();return e>=this._zooms[0]&&e<=this._zooms[1]}},{key:"addModuleListener",value:function(){window.addEventListener("resize",this.resizeLayer)}},{key:"removeModuleListener",value:function(){window.removeEventListener("resize",this.resizeLayer),this._pickEvent&&this.container.removeEventListener(this._pickEvent,this.onRay)}},{key:"resizeLayer",value:function(){var e=this.container,t=e.clientWidth,n=e.clientHeight;this._canvas&&(this._canvas.width=t,this._canvas.height=n,this._canvas.style.width=t+"px",this._canvas.style.height=n+"px"),this.camera&&(this.camera.aspect=t/n)}},{key:"show",value:function(){this.layer&&(!1===this._conf.alone&&this.layer.show(),this.reviseVisible(!0))}},{key:"hide",value:function(){this.layer&&(!1===this._conf.alone&&this.layer.hide(),this.reviseVisible(!1))}},{key:"isVisible",value:function(){return!0===this._visible}},{key:"bindMethods",value:function(e){var t=this;e.forEach((function(e){t[e]=t[e].bind(t)}))}},{key:"mergeSourceURL",value:function(e){return"string"!=typeof e?(console.error('mergeSourceURL param "url" must be Sting'),null):e.startsWith("http")||e.startsWith(".")?e:"".concat(this._baseURL).concat(e)}},{key:"getResolution",value:function(){return"function"==typeof this.map.getResolution?this.map.getResolution():null}}]);var n,r}(P),D=O,N=function(){return v((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};f(this,e),this._list=t.data||[]}),[{key:"getList",value:function(){return this._list}},{key:"add",value:function(e){if(void 0!==e)if(void 0!==e.id){var t=e.id;this.findLayerById(t)?console.error("图层的id ".concat(t," 不是唯一标识，请更换")):this._list.push(e)}else console.error("缺少图层id");else console.error("缺少图层实例")}},{key:"findLayerById",value:function(e){return this._list.find((function(t){return t.id===e}))}},{key:"remove",value:function(e){e instanceof Array||(e=[e]);var t=this._list.filter((function(t){return 0==e.includes(t.id)}));return this._list=t,t}},{key:"destroyLayerById",value:function(e){var t=this.findLayerById(e);t&&(t.destroy&&t.destroy(),this.remove(e))}},{key:"clear",value:function(){this._list.forEach((function(e){e.destroy&&e.destroy(),console.log("销毁layer ".concat(e.id))})),this._list=[]}},{key:"show",value:function(){this._list.forEach((function(e){e.show()}))}},{key:"hide",value:function(){this._list.forEach((function(e){e.hide()}))}}])}(),U=function(e){return Object.prototype.toString.call(e).split(" ")[1].split("]")[0].toLocaleLowerCase()},F=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return"rgba("+parseInt("0x"+e.slice(1,3))+","+parseInt("0x"+e.slice(3,5))+","+parseInt("0x"+e.slice(5,7))+","+t+")"},B=function(e){function t(e){var n;f(this,t);var r=b({altitude:0,wallHeight:50,wallColor:"#00feff",data:null,animate:!0,alphaMap:"./static/texture/texture_1.png",speed:1},e);return m(n=d(this,t,[r]),"_paths",[]),m(n,"_height",50),m(n,"_color",null),m(n,"_texture",null),m(n,"_texture_offset",0),n._height=r.wallHeight,n._color=r.wallColor,n.initData(r.data),n}return _(t,e),v(t,[{key:"onReady",value:function(){this.createWall()}},{key:"initData",value:function(e){var t=this;e.features.forEach((function(e){var n,r=e.geometry;switch(r.type){case"MultiPolygon":var i=r.coordinates[0].map((function(e){return t.customCoords.lngLatsToCoords(e)}));(n=t._paths).push.apply(n,k(i));break;case"Polygon":var a=t.customCoords.lngLatsToCoords(r.coordinates[0]);t._paths.push(a)}}))}},{key:"generateVecData",value:function(e){for(var t=[],n=[],r=[],i=[0,0],a=[1,0],o=[1,1],s=[0,1],l=0;l<e.length;l++){var u=S(e[l],2),c=u[0],h=u[1];t.push([c,h,this._conf.altitude]),t.push([c,h,this._conf.altitude+this._height])}for(var d=0;d<t.length-2;d++)d%2==0?(n=[].concat(k(n),k(t[d]),k(t[d+2]),k(t[d+1])),r=[].concat(k(r),i,a,s)):(n=[].concat(k(n),k(t[d]),k(t[d+1]),k(t[d+2])),r=[].concat(k(r),s,a,o));return{face:n,uvs:r}}},{key:"createWall",value:function(){for(var e=this.scene,t=[],n=[],r=0;r<this._paths.length;r++){var i=this.generateVecData(this._paths[r]),a=i.face,s=i.uvs;t=[].concat(k(t),k(a)),n=[].concat(k(n),k(s))}var l=new o.BufferGeometry;l.setAttribute("position",new o.BufferAttribute(new Float32Array(t),3)),l.setAttribute("uv",new o.BufferAttribute(new Float32Array(n),2));var u=new o.MeshBasicMaterial({color:this._color,side:o.DoubleSide,transparent:!0,depthWrite:!0,alphaMap:(new o.TextureLoader).load(this.mergeSourceURL(this._conf.alphaMap),(function(){}),null,(function(e){console.error("alphaMap load error")}))}),c=new o.Mesh(l,u);if(e.add(c),this.mainMesh=c,this._conf.animate){var h=l.clone();this._texture=this.generateTexture(128,this._color),this._texture.wrapS=o.RepeatWrapping,this._texture.wrapT=o.RepeatWrapping;var d=new o.MeshBasicMaterial({side:o.DoubleSide,transparent:!0,depthWrite:!1,map:this._texture}),f=new o.Mesh(h,d);e.add(f),this.animateMesh=f}}},{key:"setColor",value:function(e){var t=this.generateTexture(128,e);t.wrapS=o.RepeatWrapping,t.wrapT=o.RepeatWrapping,this._color=e,this._texture_offset=0,this.mainMesh.material.color=e,this.animateMesh.material.map=t,this._texture=t}},{key:"generateTexture",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:64,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"#ff0000",n=document.createElement("canvas");n.width=e,n.height=e;var r=n.getContext("2d"),i=r.createLinearGradient(0,0,0,e);i.addColorStop(.2,F(t,0)),i.addColorStop(.8,F(t,.5)),i.addColorStop(1,F(t,1)),r.fillStyle=i,r.fillRect(0,0,e,e);var a=new o.Texture(n);return a.needsUpdate=!0,a}},{key:"update",value:function(){this._isAnimate&&(this._texture_offset<=0?this._texture_offset=1:this._texture_offset-=.03*this._conf.speed,this._texture&&this._texture.offset.set(0,this._texture_offset))}}])}(D);function z(t){let n,r,i,a=-1,o=0;for(let e=0;e<t.length;++e){const s=t[e];if(s.isInterleavedBufferAttribute)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. InterleavedBufferAttributes are not supported."),null;if(void 0===n&&(n=s.array.constructor),n!==s.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(void 0===r&&(r=s.itemSize),r!==s.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(void 0===i&&(i=s.normalized),i!==s.normalized)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;if(-1===a&&(a=s.gpuType),a!==s.gpuType)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.gpuType must be consistent across matching attributes."),null;o+=s.array.length}const s=new n(o);let l=0;for(let e=0;e<t.length;++e)s.set(t[e].array,l),l+=t[e].array.length;const u=new e.BufferAttribute(s,r,i);return void 0!==a&&(u.gpuType=a),u}function V(t,n){if(n===e.TrianglesDrawMode)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),t;if(n===e.TriangleFanDrawMode||n===e.TriangleStripDrawMode){let r=t.getIndex();if(null===r){const e=[],n=t.getAttribute("position");if(void 0===n)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),t;for(let t=0;t<n.count;t++)e.push(t);t.setIndex(e),r=t.getIndex()}const i=r.count-2,a=[];if(n===e.TriangleFanDrawMode)for(let e=1;e<=i;e++)a.push(r.getX(0)),a.push(r.getX(e)),a.push(r.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(a.push(r.getX(e)),a.push(r.getX(e+1)),a.push(r.getX(e+2))):(a.push(r.getX(e+2)),a.push(r.getX(e+1)),a.push(r.getX(e)));a.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const o=t.clone();return o.setIndex(a),o.clearGroups(),o}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",n),t}function G(t,n=!1){return console.warn("THREE.BufferGeometryUtils: mergeBufferGeometries() has been renamed to mergeGeometries()."),function(t,n=!1){const r=null!==t[0].index,i=new Set(Object.keys(t[0].attributes)),a=new Set(Object.keys(t[0].morphAttributes)),o={},s={},l=t[0].morphTargetsRelative,u=new e.BufferGeometry;let c=0;for(let e=0;e<t.length;++e){const h=t[e];let d=0;if(r!==(null!==h.index))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(const t in h.attributes){if(!i.has(t))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+'. All geometries must have compatible attributes; make sure "'+t+'" attribute exists among all geometries, or in none of them.'),null;void 0===o[t]&&(o[t]=[]),o[t].push(h.attributes[t]),d++}if(d!==i.size)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". Make sure all geometries have the same number of attributes."),null;if(l!==h.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(const t in h.morphAttributes){if(!a.has(t))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+".  .morphAttributes must be consistent throughout all geometries."),null;void 0===s[t]&&(s[t]=[]),s[t].push(h.morphAttributes[t])}if(n){let t;if(r)t=h.index.count;else{if(void 0===h.attributes.position)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". The geometry must have either an index or a position attribute"),null;t=h.attributes.position.count}u.addGroup(c,t,e),c+=t}}if(r){let e=0;const n=[];for(let r=0;r<t.length;++r){const i=t[r].index;for(let t=0;t<i.count;++t)n.push(i.getX(t)+e);e+=t[r].attributes.position.count}u.setIndex(n)}for(const e in o){const t=z(o[e]);if(!t)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+e+" attribute."),null;u.setAttribute(e,t)}for(const e in s){const t=s[e][0].length;if(0===t)break;u.morphAttributes=u.morphAttributes||{},u.morphAttributes[e]=[];for(let n=0;n<t;++n){const t=[];for(let r=0;r<s[e].length;++r)t.push(s[e][r][n]);const r=z(t);if(!r)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+e+" morphAttribute."),null;u.morphAttributes[e].push(r)}}return u}(t,n)}var j="\n      varying vec2 vUv;\n      varying vec3 v_position;\n      varying vec3 vNormal; //点法线向量\n      void main() {\n          vUv = uv;\n          vNormal = normal;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n          v_position = vec3(modelMatrix * vec4(position, 1.0));\n      }\n  ",H="   \n     varying vec2 vUv;\n     varying vec3 v_position;\n     varying vec3 vNormal;\n\n     uniform float innerCircleWidth;\n     uniform float circleWidth;\n     uniform float opacity;\n     uniform vec3 center;\n\n     uniform vec3 color;\n     uniform sampler2D topMap;\n     uniform sampler2D sideMap;\n\n     void main() {\n       float dis = length(v_position - center);\n\n       // 与波动有交集\n       if(dis < (innerCircleWidth + circleWidth) && dis > innerCircleWidth) {\n          float r = (dis - innerCircleWidth) / circleWidth;\n          if (vNormal.z > 0.0) {\n            gl_FragColor = mix(texture2D(topMap, vUv), vec4(color, opacity), r); //位于顶部\n          }else{\n            gl_FragColor = mix(texture2D(sideMap, vUv), vec4(color, opacity), r); //位于侧面\n          }          \n       }else {         \n          if (vNormal.z > 0.0) {\n            gl_FragColor = texture2D( topMap, vUv);\n          }else{\n            gl_FragColor = texture2D( sideMap, vUv);\n          }\n       }  \n     }\n  ",W=function(e){function t(e){var n;f(this,t);var r=b({animate:!0,zooms:[5,14],data:null,sideMap:null,topMap:null,color:null,circleWidth:50,maxRadius:1e3,circleCenter:[0,0],pulseSpeed:1,heightField:"height"},e);return m(n=d(this,t,[r]),"_data",[]),m(n,"_map",null),m(n,"_defaultHeight",50),m(n,"_uniforms",{topMap:{value:null},sideMap:{value:null},innerCircleWidth:{value:0},circleWidth:{value:null},color:{value:null},opacity:{value:.8},center:{value:null}}),m(n,"_mt",{side:null,top:null}),m(n,"_limitCount",0),m(n,"_limitMax",5e4),n.initData(r.data),n.initProps(),n}return _(t,e),v(t,[{key:"initData",value:function(e){var t=this,n=e.features,r=this._conf.heightField;this._data=JSON.parse(JSON.stringify(n)),this._data.forEach((function(e,n){var i=e.geometry,a=e.properties,o=i.type,s=i.coordinates;"MultiPolygon"===o&&(e.geometry.coordinates=s.map((function(e){return t.customCoords.lngLatsToCoords(e)}))),"Polygon"===o&&(e.geometry.coordinates=t.customCoords.lngLatsToCoords(s)),e.properties.height=a[r]})),console.log(this._data)}},{key:"initProps",value:function(){var e=this._conf,t=this._uniforms;if(this._baseURL,e.sideMap?t.sideMap.value=e.sideMap:t.sideMap.value=(new o.TextureLoader).load(this.mergeSourceURL("./static/texture/texture_building_1.png")),e.topMap)t.topMap.value=e.topMap;else{var n=(new o.TextureLoader).load(this.mergeSourceURL("./static/texture/texture_building_2.png"));t.topMap.value=n}t.color.value=e.color||new o.Color(5563129),t.circleWidth.value=e.circleWidth,t.center.value=new o.Vector3(this._conf.circleCenter[0],this._conf.circleCenter[1],0)}},{key:"onReady",value:function(){this.initMt(),this.createPolygon()}},{key:"initMt",value:function(){var e=j,t=H,n=this._uniforms,r=n.sideMap,i=n.topMap,a=n.innerCircleWidth,s=n.circleWidth,l=n.color,u=n.opacity,c=n.center;this._mt=new o.ShaderMaterial({uniforms:{topMap:i,sideMap:r,innerCircleWidth:a,circleWidth:s,color:l,opacity:u,center:c},vertexShader:e,fragmentShader:t,side:o.DoubleSide,depthTest:!0,transparent:!0})}},{key:"createPolygon",value:function(){var e=this,t=[],n=[];this._data.forEach((function(r,i){var a=r.geometry,o=r.properties,s=a.type,l=a.coordinates;if("Polygon"===s){var u=e._createPolygon(l,o),c=u.sides,h=u.tops;t=t.concat(c),n=n.concat(h)}"MultiPolygon"===s&&l.forEach((function(r){var i=e._createPolygon(r,o),a=i.sides,s=i.tops;t=t.concat(a),n=n.concat(s)}))}));var r=new o.Mesh(G(t,!1),this._mt);this.scene.add(r);var i=new o.Mesh(G(n,!1),this._mt);this.scene.add(i)}},{key:"_createPolygon",value:function(){var e=this,t=arguments.length>1?arguments[1]:void 0,n=[],r=[];return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).forEach((function(i){if(!(e._limitCount>=e._limitMax)){var a=e.drawSide(i,t);n.push(a);var o=e.drawTop(i,t);r.push(o),e._limitCount++}})),{sides:n,tops:r}}},{key:"drawSide",value:function(e,t){var n=t.height;return t.name,t.fill,this.createSideGeometry(e,n||this._defaultHeight)}},{key:"drawTop",value:function(e,t){var n=t.height;t.name;var r=new o.Shape;e.forEach((function(e,t){var n=S(e,2),i=n[0],a=n[1];0===t?r.moveTo(i,a):r.lineTo(i,a)}));var i=new o.ShapeGeometry(r),a=n||this._defaultHeight;return i.attributes.position.array.forEach((function(e,t){(t+1)%3==0&&(i.attributes.position.array[t]=a)})),i}},{key:"createSideGeometry",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(e instanceof Array==!1)throw"createSideGeometry: path must be array";e[0].toString()!==e[e.length-1].toString()&&e.push(e[0]);for(var n=[],r=[],i=[],a=[0,0],s=[1,0],l=[1,1],u=[0,1],c=0;c<e.length;c++){var h=S(e[c],2),d=h[0],f=h[1];n.push([d,f,0]),n.push([d,f,t])}for(var p=0;p<n.length-2;p++)p%2==0?(r=[].concat(k(r),k(n[p]),k(n[p+2]),k(n[p+1])),i=[].concat(k(i),a,s,u)):(r=[].concat(k(r),k(n[p]),k(n[p+1]),k(n[p+2])),i=[].concat(k(i),u,s,l));var v=new o.BufferGeometry;return v.setAttribute("position",new o.BufferAttribute(new Float32Array(r),3)),v.setAttribute("uv",new o.BufferAttribute(new Float32Array(i),2)),v}},{key:"update",value:function(){if(this._isAnimate){var e=this._uniforms,t=e.innerCircleWidth;e.circleWidth,e.opacity,t.value+=10*this._conf.pulseSpeed,t.value>this._conf.maxRadius&&(t.value=0)}}},{key:"setSweepStyle",value:function(e){this._uniforms.center.value=e.center}}])}(D),X=function(e){function t(e){var n;f(this,t);var r=b({animate:!0,zooms:[5,14],data:null,interact:!0,style:{initial:{color:"#ffffff",opacity:.3},hover:{color:"#ff0000",opacity:.8}}},e);return m(n=d(this,t,[r]),"_data",[]),m(n,"_map",null),m(n,"_mt",null),n.initData(r.data),n}return _(t,e),v(t,[{key:"initData",value:function(e){var t=this,n=e.features;this._data=JSON.parse(JSON.stringify(n)),this._data.forEach((function(e,n){var r=e.geometry,i=r.type,a=r.coordinates;"MultiPolygon"===i&&(e.geometry.coordinates=a.map((function(e){return t.customCoords.lngLatsToCoords(e)}))),"Polygon"===i&&(e.geometry.coordinates=t.customCoords.lngLatsToCoords(a))})),console.log(this._data)}},{key:"onReady",value:function(){this.initMaterial(),this.createPolygon()}},{key:"onPicked",value:function(e){var t,n,r=e.targets,i=e.event,a=null;if(r.length>0){var o,s=null===(o=r[0])||void 0===o?void 0:o.object;"Mesh"==(null==s?void 0:s.type)?(this.setLastPick(s),a=s._attrs):this.removeLastPick()}else this.removeLastPick();this.handleEvent("pick",{screenX:null==i||null===(t=i.pixel)||void 0===t?void 0:t.x,screenY:null==i||null===(n=i.pixel)||void 0===n?void 0:n.y,attrs:a})}},{key:"setLastPick",value:function(e){var t=this._lastPick;this.scene,e&&(t&&t&&JSON.stringify(null==t?void 0:t._attrs)===JSON.stringify(null==e?void 0:e._attrs)||(this.removeLastPick(),e.material=this._mt.hover,this._lastPick=e))}},{key:"removeLastPick",value:function(){var e=this._lastPick;this.scene,e&&(e.material=this._mt.initial,this._lastPick=null)}},{key:"initMaterial",value:function(){var e=this._conf.style,t=e.initial,n=e.hover;this._mt={},this._mt.initial=new o.MeshBasicMaterial({color:t.color,transparent:!0,opacity:t.opacity,side:o.DoubleSide,wireframe:!1}),this._mt.hover=new o.MeshBasicMaterial({color:n.color,transparent:!0,opacity:n.opacity,side:o.DoubleSide})}},{key:"createPolygon",value:function(){var e=this,t=this._mt.initial,n=[],r=[];this._data.forEach((function(t,i){var a=t.geometry,o=t.properties,s=a.type,l=a.coordinates;if("Polygon"===s){var u=e._createPolygon(l,o),c=u.sides,h=u.tops;n=n.concat(c),r=r.concat(h)}"MultiPolygon"===s&&l.forEach((function(t){var i=e._createPolygon(t,o),a=i.sides,s=i.tops;n=n.concat(a),r=r.concat(s)}))})),n.forEach((function(n){var r=new o.Mesh(n,t);r._attrs=n._attrs,delete n._attrs,e.scene.add(r)}))}},{key:"_createPolygon",value:function(){var e=this,t=arguments.length>1?arguments[1]:void 0,n=[],r=[];return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).forEach((function(i){var a=e.drawSide(i,t);n=[].concat(k(n),k(a));var o=e.drawTop(i,t);r=[].concat(k(r),k(o))})),{sides:n,tops:r}}},{key:"drawSide",value:function(e,t){for(var n=t.regions,r=[],i=0;i<=n.length-1;i++){var a=this.createSideGeometry(e,n[i]);a._attrs=b({},n[i]),r.push(a)}return r}},{key:"drawTop",value:function(e,t){for(var n=t.regions,r=[],i=function(){var t=new o.Shape,i=n[a],s=i.bottomAltitude,l=i.extendAltitude;e.forEach((function(e,n){var r=S(e,2),i=r[0],a=r[1];0===n?t.moveTo(i,a):t.lineTo(i,a)}));var u=new o.ShapeGeometry(t),c=s+l;u.attributes.position.array.forEach((function(e,t){(t+1)%3==0&&(u.attributes.position.array[t]=c)})),r.push(u)},a=0;a<=n.length-1;a++)i();return r}},{key:"createSideGeometry",value:function(e,t){if(e instanceof Array==!1)throw"createSideGeometry: path must be array";t.id;var n=t.bottomAltitude,r=t.extendAltitude;e[0].toString()!==e[e.length-1].toString()&&e.push(e[0]);for(var i=[],a=[],s=[],l=[0,0],u=[1,0],c=[1,1],h=[0,1],d=0;d<e.length;d++){var f=S(e[d],2),p=f[0],v=f[1];i.push([p,v,n]),i.push([p,v,n+r])}for(var m=0;m<i.length-2;m++)m%2==0?(a=[].concat(k(a),k(i[m]),k(i[m+2]),k(i[m+1])),s=[].concat(k(s),l,u,h)):(a=[].concat(k(a),k(i[m]),k(i[m+1]),k(i[m+2])),s=[].concat(k(s),h,u,c));var g=new o.BufferGeometry;return g.setAttribute("position",new o.BufferAttribute(new Float32Array(a),3)),g.setAttribute("uv",new o.BufferAttribute(new Float32Array(s),2)),g}},{key:"update",value:function(){}}])}(D),K=Object.defineProperty,Y=function(e,t,n){return function(e,t,n){t in e?K(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n}(e,"symbol"!==R(t)?t+"":t,n),n};function Q(e,t,n,r,i){var a;if(e=e.subarray||e.slice?e:e.buffer,n=n.subarray||n.slice?n:n.buffer,e=t?e.subarray?e.subarray(t,i&&t+i):e.slice(t,i&&t+i):e,n.set)n.set(e,r);else for(a=0;a<e.length;a++)n[a+r]=e[a];return n}var Z=function(e){function t(){var e;return f(this,t),e=d(this,t),Y(e,"type","MeshLine"),Y(e,"isMeshLine",!0),Y(e,"positions",[]),Y(e,"previous",[]),Y(e,"next",[]),Y(e,"side",[]),Y(e,"width",[]),Y(e,"indices_array",[]),Y(e,"uvs",[]),Y(e,"counters",[]),Y(e,"widthCallback",null),Y(e,"_attributes"),Y(e,"_points",[]),Y(e,"points"),Y(e,"matrixWorld",new o.Matrix4),Object.defineProperties(e,{points:{enumerable:!0,get:function(){return this._points},set:function(e){this.setPoints(e,this.widthCallback)}}}),e}return _(t,e),v(t,[{key:"setMatrixWorld",value:function(e){this.matrixWorld=e}},{key:"setPoints",value:function(e,t){if(e=function(e){return e instanceof Float32Array?e:e instanceof o.BufferGeometry?e.getAttribute("position").array:e.map((function(e){var t=Array.isArray(e);return e instanceof o.Vector3?[e.x,e.y,e.z]:e instanceof o.Vector2?[e.x,e.y,0]:t&&3===e.length?[e[0],e[1],e[2]]:t&&2===e.length?[e[0],e[1],0]:e})).flat()}(e),this._points=e,this.widthCallback=null!=t?t:null,this.positions=[],this.counters=[],e.length&&e[0]instanceof o.Vector3)for(var n=0;n<e.length;n++){var r=e[n],i=n/(e.length-1);this.positions.push(r.x,r.y,r.z),this.positions.push(r.x,r.y,r.z),this.counters.push(i),this.counters.push(i)}else for(var a=0;a<e.length;a+=3){var s=a/(e.length-1);this.positions.push(e[a],e[a+1],e[a+2]),this.positions.push(e[a],e[a+1],e[a+2]),this.counters.push(s),this.counters.push(s)}this.process()}},{key:"compareV3",value:function(e,t){var n=6*e,r=6*t;return this.positions[n]===this.positions[r]&&this.positions[n+1]===this.positions[r+1]&&this.positions[n+2]===this.positions[r+2]}},{key:"copyV3",value:function(e){var t=6*e;return[this.positions[t],this.positions[t+1],this.positions[t+2]]}},{key:"process",value:function(){var e,t,n=this.positions.length/6;this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[],t=this.compareV3(0,n-1)?this.copyV3(n-2):this.copyV3(0),this.previous.push(t[0],t[1],t[2]),this.previous.push(t[0],t[1],t[2]);for(var r=0;r<n;r++){if(this.side.push(1),this.side.push(-1),e=this.widthCallback?this.widthCallback(r/(n-1)):1,this.width.push(e),this.width.push(e),this.uvs.push(r/(n-1),0),this.uvs.push(r/(n-1),1),r<n-1){t=this.copyV3(r),this.previous.push(t[0],t[1],t[2]),this.previous.push(t[0],t[1],t[2]);var i=2*r;this.indices_array.push(i,i+1,i+2),this.indices_array.push(i+2,i+1,i+3)}r>0&&(t=this.copyV3(r),this.next.push(t[0],t[1],t[2]),this.next.push(t[0],t[1],t[2]))}t=this.compareV3(n-1,0)?this.copyV3(1):this.copyV3(n-1),this.next.push(t[0],t[1],t[2]),this.next.push(t[0],t[1],t[2]),this._attributes&&this._attributes.position.count===this.positions.length?(this._attributes.position.copyArray(new Float32Array(this.positions)),this._attributes.position.needsUpdate=!0,this._attributes.previous.copyArray(new Float32Array(this.previous)),this._attributes.previous.needsUpdate=!0,this._attributes.next.copyArray(new Float32Array(this.next)),this._attributes.next.needsUpdate=!0,this._attributes.side.copyArray(new Float32Array(this.side)),this._attributes.side.needsUpdate=!0,this._attributes.width.copyArray(new Float32Array(this.width)),this._attributes.width.needsUpdate=!0,this._attributes.uv.copyArray(new Float32Array(this.uvs)),this._attributes.uv.needsUpdate=!0,this._attributes.index.copyArray(new Uint16Array(this.indices_array)),this._attributes.index.needsUpdate=!0):this._attributes={position:new o.BufferAttribute(new Float32Array(this.positions),3),previous:new o.BufferAttribute(new Float32Array(this.previous),3),next:new o.BufferAttribute(new Float32Array(this.next),3),side:new o.BufferAttribute(new Float32Array(this.side),1),width:new o.BufferAttribute(new Float32Array(this.width),1),uv:new o.BufferAttribute(new Float32Array(this.uvs),2),index:new o.BufferAttribute(new Uint16Array(this.indices_array),1),counters:new o.BufferAttribute(new Float32Array(this.counters),1)},this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setIndex(this._attributes.index),this.computeBoundingSphere(),this.computeBoundingBox()}},{key:"advance",value:function(e){var t=e.x,n=e.y,r=e.z,i=this._attributes.position.array,a=this._attributes.previous.array,o=this._attributes.next.array,s=i.length;Q(i,0,a,0,s),Q(i,6,i,0,s-6),i[s-6]=t,i[s-5]=n,i[s-4]=r,i[s-3]=t,i[s-2]=n,i[s-1]=r,Q(i,6,o,0,s-6),o[s-6]=t,o[s-5]=n,o[s-4]=r,o[s-3]=t,o[s-2]=n,o[s-1]=r,this._attributes.position.needsUpdate=!0,this._attributes.previous.needsUpdate=!0,this._attributes.next.needsUpdate=!0}}])}(o.BufferGeometry),q=function(e){function t(e){var n;return f(this,t),n=d(this,t,[{uniforms:b(b({},o.UniformsLib.fog),{},{lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},color:{value:new o.Color(16777215)},opacity:{value:1},resolution:{value:new o.Vector2(1,1)},sizeAttenuation:{value:1},dashArray:{value:0},dashOffset:{value:0},dashRatio:{value:.5},useDash:{value:0},visibility:{value:1},alphaTest:{value:0},repeat:{value:new o.Vector2(1,1)},offset:{value:new o.Vector2(1,1)}}),vertexShader:"\n  #include <common>\n  #include <logdepthbuf_pars_vertex>\n  #include <fog_pars_vertex>\n\n  attribute vec3 previous;\n  attribute vec3 next;\n  attribute float side;\n  attribute float width;\n  attribute float counters;\n  \n  uniform vec2 resolution;\n  uniform float lineWidth;\n  uniform vec3 color;\n  uniform float opacity;\n  uniform float sizeAttenuation;\n  uniform vec2 offset;\n  \n  varying vec2 vUV;\n  varying vec4 vColor;\n  varying float vCounters;\n  \n  vec2 fix(vec4 i, float aspect) {\n    vec2 res = i.xy / i.w;\n    res.x *= aspect;\n  \tvCounters = counters;\n    return res;\n  }\n  \n  void main() {\n    float aspect = resolution.x / resolution.y;\n    vColor = vec4(color, opacity);\n    vUV = uv + offset;\n  \n    mat4 m = projectionMatrix * modelViewMatrix;\n    vec4 finalPosition = m * vec4(position, 1.0);\n    vec4 prevPos = m * vec4(previous, 1.0);\n    vec4 nextPos = m * vec4(next, 1.0);\n  \n    vec2 currentP = fix(finalPosition, aspect);\n    vec2 prevP = fix(prevPos, aspect);\n    vec2 nextP = fix(nextPos, aspect);\n  \n    float w = lineWidth * width;\n  \n    vec2 dir;\n    if (nextP == currentP) dir = normalize(currentP - prevP);\n    else if (prevP == currentP) dir = normalize(nextP - currentP);\n    else {\n      vec2 dir1 = normalize(currentP - prevP);\n      vec2 dir2 = normalize(nextP - currentP);\n      dir = normalize(dir1 + dir2);\n  \n      vec2 perp = vec2(-dir1.y, dir1.x);\n      vec2 miter = vec2(-dir.y, dir.x);\n      //w = clamp(w / dot(miter, perp), 0., 4. * lineWidth * width);\n    }\n  \n    //vec2 normal = (cross(vec3(dir, 0.), vec3(0., 0., 1.))).xy;\n    vec4 normal = vec4(-dir.y, dir.x, 0., 1.);\n    normal.xy *= .5 * w;\n    //normal *= projectionMatrix;\n    if (sizeAttenuation == 0.) {\n      normal.xy *= finalPosition.w;\n      normal.xy /= (vec4(resolution, 0., 1.) * projectionMatrix).xy;\n    }\n  \n    finalPosition.xy += normal.xy * side;\n    gl_Position = finalPosition;\n    #include <logdepthbuf_vertex>\n    #include <fog_vertex>\n    vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n    #include <fog_vertex>\n  }\n",fragmentShader:"\n  #include <fog_pars_fragment>\n  #include <logdepthbuf_pars_fragment>\n  \n  uniform sampler2D map;\n  uniform sampler2D alphaMap;\n  uniform float useMap;\n  uniform float useAlphaMap;\n  uniform float useDash;\n  uniform float dashArray;\n  uniform float dashOffset;\n  uniform float dashRatio;\n  uniform float visibility;\n  uniform float alphaTest;\n  uniform vec2 repeat;\n  \n  varying vec2 vUV;\n  varying vec4 vColor;\n  varying float vCounters;\n  \n  void main() {\n    #include <logdepthbuf_fragment>\n    vec4 c = vColor;\n    if (useMap == 1.) c *= texture2D(map, vUV * repeat);\n    if (useAlphaMap == 1.) c.a *= texture2D(alphaMap, vUV * repeat).a;\n    if (c.a < alphaTest) discard;\n    if (useDash == 1.) {\n      c.a *= ceil(mod(vCounters + dashOffset, dashArray) - (dashArray * dashRatio));\n    }\n    gl_FragColor = c;\n    gl_FragColor.a *= step(vCounters, visibility);\n    #include <fog_fragment>\n    #include <tonemapping_fragment>\n    #include <encodings_fragment>\n  }\n"}]),Y(n,"lineWidth"),Y(n,"map"),Y(n,"useMap"),Y(n,"alphaMap"),Y(n,"useAlphaMap"),Y(n,"color"),Y(n,"resolution"),Y(n,"sizeAttenuation"),Y(n,"dashArray"),Y(n,"dashOffset"),Y(n,"dashRatio"),Y(n,"useDash"),Y(n,"visibility"),Y(n,"repeat"),n.type="MeshLineMaterial",Object.defineProperties(n,{lineWidth:{enumerable:!0,get:function(){return this.uniforms.lineWidth.value},set:function(e){this.uniforms.lineWidth.value=e}},map:{enumerable:!0,get:function(){return this.uniforms.map.value},set:function(e){this.uniforms.map.value=e}},useMap:{enumerable:!0,get:function(){return this.uniforms.useMap.value},set:function(e){this.uniforms.useMap.value=e}},alphaMap:{enumerable:!0,get:function(){return this.uniforms.alphaMap.value},set:function(e){this.uniforms.alphaMap.value=e}},useAlphaMap:{enumerable:!0,get:function(){return this.uniforms.useAlphaMap.value},set:function(e){this.uniforms.useAlphaMap.value=e}},color:{enumerable:!0,get:function(){return this.uniforms.color.value},set:function(e){this.uniforms.color.value=e}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}},sizeAttenuation:{enumerable:!0,get:function(){return this.uniforms.sizeAttenuation.value},set:function(e){this.uniforms.sizeAttenuation.value=e}},dashArray:{enumerable:!0,get:function(){return this.uniforms.dashArray.value},set:function(e){this.uniforms.dashArray.value=e,this.useDash=0!==e?1:0}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(e){this.uniforms.dashOffset.value=e}},dashRatio:{enumerable:!0,get:function(){return this.uniforms.dashRatio.value},set:function(e){this.uniforms.dashRatio.value=e}},useDash:{enumerable:!0,get:function(){return this.uniforms.useDash.value},set:function(e){this.uniforms.useDash.value=e}},visibility:{enumerable:!0,get:function(){return this.uniforms.visibility.value},set:function(e){this.uniforms.visibility.value=e}},alphaTest:{enumerable:!0,get:function(){return this.uniforms.alphaTest.value},set:function(e){this.uniforms.alphaTest.value=e}},repeat:{enumerable:!0,get:function(){return this.uniforms.repeat.value},set:function(e){this.uniforms.repeat.value.copy(e)}}}),n.setValues(e),n}return _(t,e),v(t,[{key:"copy",value:function(e){var n,r,i,a,o;return(n=t,r="copy",i=this,o=g(y(1&(a=3)?n.prototype:n),r,i),2&a&&"function"==typeof o?function(e){return o.apply(i,e)}:o)([e]),this.lineWidth=e.lineWidth,this.map=e.map,this.useMap=e.useMap,this.alphaMap=e.alphaMap,this.useAlphaMap=e.useAlphaMap,this.color.copy(e.color),this.opacity=e.opacity,this.resolution.copy(e.resolution),this.sizeAttenuation=e.sizeAttenuation,this.dashArray=e.dashArray,this.dashOffset=e.dashOffset,this.dashRatio=e.dashRatio,this.useDash=e.useDash,this.visibility=e.visibility,this.alphaTest=e.alphaTest,this.repeat.copy(e.repeat),this}}])}(o.ShaderMaterial),J=function(e){function t(e){var n;f(this,t);var r=b({data:null,opacity:1,altitude:0,animate:!1,speed:2,topMap:"./static/texture/rock1.jpg",topMapNormal:"./static/texture/rock1-normal.jpg",topColor:"#0d8ce7",topMapRepeat:[1e-4,1e-4],sideMap:"./static/texture/texture_cake_1.png",borderColor:"#10ecda",borderWidth:300,borderMap:void 0},e);return m(n=d(this,t,[r]),"_paths",[]),m(n,"_borderMaterial",null),void 0===r.data?(console.log("props data is required"),M(n)):(n.initData(r.data),n._data=r.data,n)}return _(t,e),v(t,[{key:"initLight",value:function(){var e=new o.AmbientLight(16777215,.2);this.scene.add(e)}},{key:"onReady",value:function(){this.initLight(),this.initArea()}},{key:"initData",value:function(e){var t=this;e.features.forEach((function(e){e.geometry.coordinates.forEach((function(e){var n=e[0][0]instanceof Array?e[0]:e,r=t.customCoords.lngLatsToCoords(n);t._paths.push(r)}))}))}},{key:"initArea",value:function(){var e=this,t=this._data.features,n=this._conf.borderWidth;t.forEach((function(t,r){var i=e._paths[r],a=t.properties;e.drawSide(i,a),e.drawOneArea(i,a),n>0&&e.drawBorder(i,a)}))}},{key:"drawOneArea",value:function(e,t){var n=t.height;t.name;var r=this.scene,i=this._conf.altitude,a=new o.Shape;e.forEach((function(e,t){var n=S(e,2),r=n[0],i=n[1];0===t?a.moveTo(r,i):a.lineTo(r,i)}));var s=new o.ShapeGeometry(a),l=new o.Mesh(s,this.getMaterial());l.position.z=i+n||0,r.add(l)}},{key:"getMaterial",value:function(){var e=this._conf,t=e.topColor,n=e.topMap,r=e.topMapNormal,i=e.opacity,a=e.topMapRepeat,s=new o.MeshPhongMaterial({side:o.DoubleSide,transparent:!0,depthWrite:!0,color:t,opacity:i});if(n){var l=S(a,2),u=l[0],c=l[1],h=(new o.TextureLoader).load(this.mergeSourceURL(n),(function(){}),null,(function(){console.error("topMap load error")}));h.wrapS=o.RepeatWrapping,h.wrapT=o.RepeatWrapping,h.repeat.set(u,c);var d=(new o.TextureLoader).load(this.mergeSourceURL(r),(function(){}),null,(function(){console.error("topMapNormal load error")}));h.wrapS=o.RepeatWrapping,h.wrapT=o.RepeatWrapping,h.repeat.set(u,c),s.map=h,s.normalMap=d}return s}},{key:"drawSide",value:function(e,t){var n=t.height,r=void 0===n?0:n;if(t.name,!(r<=0)){var i=this._conf.altitude,a=e;a[0].toString()!==a[a.length-1].toString()&&a.push(a[0]);for(var s=[],l=[],u=[],c=[0,0],h=[1,0],d=[1,1],f=[0,1],p=0;p<a.length;p++){var v=S(a[p],2),m=v[0],g=v[1];s.push([m,g,i]),s.push([m,g,i+r])}for(var y=0;y<s.length-2;y++)y%2==0?(l=[].concat(k(l),k(s[y]),k(s[y+2]),k(s[y+1])),u=[].concat(k(u),c,h,f)):(l=[].concat(k(l),k(s[y]),k(s[y+1]),k(s[y+2])),u=[].concat(k(u),f,h,d));var _=new o.BufferGeometry;_.setAttribute("position",new o.BufferAttribute(new Float32Array(l),3)),_.setAttribute("uv",new o.BufferAttribute(new Float32Array(u),2));var x=new o.MeshBasicMaterial({side:o.DoubleSide,transparent:!0,depthWrite:!0});if(this._conf.sideMap){var w=(new o.TextureLoader).load(this._conf.sideMap,(function(){}),null,(function(){console.error("sideMap load error")}));w.wrapS=o.RepeatWrapping,w.wrapT=o.RepeatWrapping,w.offset.set(0,1),x.map=w}var b=new o.Mesh(_,x);this.scene.add(b)}}},{key:"drawBorder",value:function(e,t){var n=t.height;t.name;var r=this._conf.altitude,i=e.map((function(e){var t=S(e,2),i=t[0],a=t[1];return new o.Vector3(i,a,r+1.01*n)})),a=new Z;a.setPoints(i);var s=new o.Mesh(a,this.getBorderMaterial());this.scene.add(s)}},{key:"getBorderMaterial",value:function(){if(null==this._borderMaterial){var e,t=this._conf,n=t.borderWidth,r=t.borderColor,i=t.borderMap,a=new q({lineWidth:n,sizeAttenuation:1,useMap:i?1:0,opacity:1,transparent:!1});i?((e=(new o.TextureLoader).load(this._conf.borderMap,(function(){}),null,(function(){console.error("borderMap load error")}))).wrapS=o.RepeatWrapping,e.wrapT=o.RepeatWrapping,a.map=e):a.color=new o.Color(r),this._borderMaterial=a}return this._borderMaterial}},{key:"update",value:function(){this._isAnimate&&this._borderMaterial&&(this._borderMaterial.uniforms.offset.value.x+=.005)}}])}(D);class $ extends e.Loader{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new ae(e)})),this.register((function(e){return new fe(e)})),this.register((function(e){return new pe(e)})),this.register((function(e){return new ve(e)})),this.register((function(e){return new se(e)})),this.register((function(e){return new le(e)})),this.register((function(e){return new ue(e)})),this.register((function(e){return new ce(e)})),this.register((function(e){return new ie(e)})),this.register((function(e){return new he(e)})),this.register((function(e){return new oe(e)})),this.register((function(e){return new de(e)})),this.register((function(e){return new ne(e)})),this.register((function(e){return new me(e)})),this.register((function(e){return new ge(e)}))}load(t,n,r,i){const a=this;let o;o=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:e.LoaderUtils.extractUrlBase(t),this.manager.itemStart(t);const s=function(e){i?i(e):console.error(e),a.manager.itemError(t),a.manager.itemEnd(t)},l=new e.FileLoader(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(t,(function(e){try{a.parse(e,o,(function(e){n(e),a.manager.itemEnd(t)}),s)}catch(e){s(e)}}),r,s)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,r){let i;const a={},o={},s=new TextDecoder;if("string"==typeof e)i=JSON.parse(e);else if(e instanceof ArrayBuffer){if(s.decode(new Uint8Array(e,0,4))===ye){try{a[te.KHR_BINARY_GLTF]=new we(e)}catch(e){return void(r&&r(e))}i=JSON.parse(a[te.KHR_BINARY_GLTF].content)}else i=JSON.parse(s.decode(e))}else i=e;if(void 0===i.asset||i.asset.version[0]<2)return void(r&&r(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new Xe(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](l);o[t.name]=t,a[t.name]=!0}if(i.extensionsUsed)for(let e=0;e<i.extensionsUsed.length;++e){const t=i.extensionsUsed[e],n=i.extensionsRequired||[];switch(t){case te.KHR_MATERIALS_UNLIT:a[t]=new re;break;case te.KHR_DRACO_MESH_COMPRESSION:a[t]=new be(i,this.dracoLoader);break;case te.KHR_TEXTURE_TRANSFORM:a[t]=new Me;break;case te.KHR_MESH_QUANTIZATION:a[t]=new Ae;break;default:n.indexOf(t)>=0&&void 0===o[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(a),l.setPlugins(o),l.parse(n,r)}parseAsync(e,t){const n=this;return new Promise((function(r,i){n.parse(e,t,r,i)}))}}function ee(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const te={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class ne{constructor(e){this.parser=e,this.name=te.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let n=0,r=t.length;n<r;n++){const r=t[n];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(t){const n=this.parser,r="light:"+t;let i=n.cache.get(r);if(i)return i;const a=n.json,o=((a.extensions&&a.extensions[this.name]||{}).lights||[])[t];let s;const l=new e.Color(16777215);void 0!==o.color&&l.setRGB(o.color[0],o.color[1],o.color[2],e.LinearSRGBColorSpace);const u=void 0!==o.range?o.range:0;switch(o.type){case"directional":s=new e.DirectionalLight(l),s.target.position.set(0,0,-1),s.add(s.target);break;case"point":s=new e.PointLight(l),s.distance=u;break;case"spot":s=new e.SpotLight(l),s.distance=u,o.spot=o.spot||{},o.spot.innerConeAngle=void 0!==o.spot.innerConeAngle?o.spot.innerConeAngle:0,o.spot.outerConeAngle=void 0!==o.spot.outerConeAngle?o.spot.outerConeAngle:Math.PI/4,s.angle=o.spot.outerConeAngle,s.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,s.target.position.set(0,0,-1),s.add(s.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+o.type)}return s.position.set(0,0,0),s.decay=2,ze(s,o),void 0!==o.intensity&&(s.intensity=o.intensity),s.name=n.createUniqueName(o.name||"light_"+t),i=Promise.resolve(s),n.cache.add(r,i),i}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,n=this.parser,r=n.json.nodes[e],i=(r.extensions&&r.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then((function(e){return n._getNodeRef(t.cache,i,e)}))}}class re{constructor(){this.name=te.KHR_MATERIALS_UNLIT}getMaterialType(){return e.MeshBasicMaterial}extendParams(t,n,r){const i=[];t.color=new e.Color(1,1,1),t.opacity=1;const a=n.pbrMetallicRoughness;if(a){if(Array.isArray(a.baseColorFactor)){const n=a.baseColorFactor;t.color.setRGB(n[0],n[1],n[2],e.LinearSRGBColorSpace),t.opacity=n[3]}void 0!==a.baseColorTexture&&i.push(r.assignTexture(t,"map",a.baseColorTexture,e.SRGBColorSpace))}return Promise.all(i)}}class ie{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name].emissiveStrength;return void 0!==r&&(t.emissiveIntensity=r),Promise.resolve()}}class ae{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_CLEARCOAT}getMaterialType(t){const n=this.parser.json.materials[t];return n.extensions&&n.extensions[this.name]?e.MeshPhysicalMaterial:null}extendMaterialParams(t,n){const r=this.parser,i=r.json.materials[t];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const a=[],o=i.extensions[this.name];if(void 0!==o.clearcoatFactor&&(n.clearcoat=o.clearcoatFactor),void 0!==o.clearcoatTexture&&a.push(r.assignTexture(n,"clearcoatMap",o.clearcoatTexture)),void 0!==o.clearcoatRoughnessFactor&&(n.clearcoatRoughness=o.clearcoatRoughnessFactor),void 0!==o.clearcoatRoughnessTexture&&a.push(r.assignTexture(n,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),void 0!==o.clearcoatNormalTexture&&(a.push(r.assignTexture(n,"clearcoatNormalMap",o.clearcoatNormalTexture)),void 0!==o.clearcoatNormalTexture.scale)){const t=o.clearcoatNormalTexture.scale;n.clearcoatNormalScale=new e.Vector2(t,t)}return Promise.all(a)}}class oe{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_IRIDESCENCE}getMaterialType(t){const n=this.parser.json.materials[t];return n.extensions&&n.extensions[this.name]?e.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],a=r.extensions[this.name];return void 0!==a.iridescenceFactor&&(t.iridescence=a.iridescenceFactor),void 0!==a.iridescenceTexture&&i.push(n.assignTexture(t,"iridescenceMap",a.iridescenceTexture)),void 0!==a.iridescenceIor&&(t.iridescenceIOR=a.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==a.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=a.iridescenceThicknessMinimum),void 0!==a.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=a.iridescenceThicknessMaximum),void 0!==a.iridescenceThicknessTexture&&i.push(n.assignTexture(t,"iridescenceThicknessMap",a.iridescenceThicknessTexture)),Promise.all(i)}}class se{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_SHEEN}getMaterialType(t){const n=this.parser.json.materials[t];return n.extensions&&n.extensions[this.name]?e.MeshPhysicalMaterial:null}extendMaterialParams(t,n){const r=this.parser,i=r.json.materials[t];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const a=[];n.sheenColor=new e.Color(0,0,0),n.sheenRoughness=0,n.sheen=1;const o=i.extensions[this.name];if(void 0!==o.sheenColorFactor){const t=o.sheenColorFactor;n.sheenColor.setRGB(t[0],t[1],t[2],e.LinearSRGBColorSpace)}return void 0!==o.sheenRoughnessFactor&&(n.sheenRoughness=o.sheenRoughnessFactor),void 0!==o.sheenColorTexture&&a.push(r.assignTexture(n,"sheenColorMap",o.sheenColorTexture,e.SRGBColorSpace)),void 0!==o.sheenRoughnessTexture&&a.push(r.assignTexture(n,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(a)}}class le{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_TRANSMISSION}getMaterialType(t){const n=this.parser.json.materials[t];return n.extensions&&n.extensions[this.name]?e.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],a=r.extensions[this.name];return void 0!==a.transmissionFactor&&(t.transmission=a.transmissionFactor),void 0!==a.transmissionTexture&&i.push(n.assignTexture(t,"transmissionMap",a.transmissionTexture)),Promise.all(i)}}class ue{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_VOLUME}getMaterialType(t){const n=this.parser.json.materials[t];return n.extensions&&n.extensions[this.name]?e.MeshPhysicalMaterial:null}extendMaterialParams(t,n){const r=this.parser,i=r.json.materials[t];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const a=[],o=i.extensions[this.name];n.thickness=void 0!==o.thicknessFactor?o.thicknessFactor:0,void 0!==o.thicknessTexture&&a.push(r.assignTexture(n,"thicknessMap",o.thicknessTexture)),n.attenuationDistance=o.attenuationDistance||1/0;const s=o.attenuationColor||[1,1,1];return n.attenuationColor=(new e.Color).setRGB(s[0],s[1],s[2],e.LinearSRGBColorSpace),Promise.all(a)}}class ce{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_IOR}getMaterialType(t){const n=this.parser.json.materials[t];return n.extensions&&n.extensions[this.name]?e.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name];return t.ior=void 0!==r.ior?r.ior:1.5,Promise.resolve()}}class he{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_SPECULAR}getMaterialType(t){const n=this.parser.json.materials[t];return n.extensions&&n.extensions[this.name]?e.MeshPhysicalMaterial:null}extendMaterialParams(t,n){const r=this.parser,i=r.json.materials[t];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const a=[],o=i.extensions[this.name];n.specularIntensity=void 0!==o.specularFactor?o.specularFactor:1,void 0!==o.specularTexture&&a.push(r.assignTexture(n,"specularIntensityMap",o.specularTexture));const s=o.specularColorFactor||[1,1,1];return n.specularColor=(new e.Color).setRGB(s[0],s[1],s[2],e.LinearSRGBColorSpace),void 0!==o.specularColorTexture&&a.push(r.assignTexture(n,"specularColorMap",o.specularColorTexture,e.SRGBColorSpace)),Promise.all(a)}}class de{constructor(e){this.parser=e,this.name=te.KHR_MATERIALS_ANISOTROPY}getMaterialType(t){const n=this.parser.json.materials[t];return n.extensions&&n.extensions[this.name]?e.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],a=r.extensions[this.name];return void 0!==a.anisotropyStrength&&(t.anisotropy=a.anisotropyStrength),void 0!==a.anisotropyRotation&&(t.anisotropyRotation=a.anisotropyRotation),void 0!==a.anisotropyTexture&&i.push(n.assignTexture(t,"anisotropyMap",a.anisotropyTexture)),Promise.all(i)}}class fe{constructor(e){this.parser=e,this.name=te.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,n=t.json,r=n.textures[e];if(!r.extensions||!r.extensions[this.name])return null;const i=r.extensions[this.name],a=t.options.ktx2Loader;if(!a){if(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,i.source,a)}}class pe{constructor(e){this.parser=e,this.name=te.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;const a=i.extensions[t],o=r.images[a.source];let s=n.textureLoader;if(o.uri){const e=n.options.manager.getHandler(o.uri);null!==e&&(s=e)}return this.detectSupport().then((function(i){if(i)return n.loadTextureImage(e,a.source,s);if(r.extensionsRequired&&r.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return n.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class ve{constructor(e){this.parser=e,this.name=te.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;const a=i.extensions[t],o=r.images[a.source];let s=n.textureLoader;if(o.uri){const e=n.options.manager.getHandler(o.uri);null!==e&&(s=e)}return this.detectSupport().then((function(i){if(i)return n.loadTextureImage(e,a.source,s);if(r.extensionsRequired&&r.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return n.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class me{constructor(e){this.name=te.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,n=t.bufferViews[e];if(n.extensions&&n.extensions[this.name]){const e=n.extensions[this.name],r=this.parser.getDependency("buffer",e.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return r.then((function(t){const n=e.byteOffset||0,r=e.byteLength||0,a=e.count,o=e.byteStride,s=new Uint8Array(t,n,r);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(a,o,s,e.mode,e.filter).then((function(e){return e.buffer})):i.ready.then((function(){const t=new ArrayBuffer(a*o);return i.decodeGltfBuffer(new Uint8Array(t),a,o,s,e.mode,e.filter),t}))}))}return null}}class ge{constructor(e){this.name=te.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(t){const n=this.parser.json,r=n.nodes[t];if(!r.extensions||!r.extensions[this.name]||void 0===r.mesh)return null;const i=n.meshes[r.mesh];for(const e of i.primitives)if(e.mode!==Ce.TRIANGLES&&e.mode!==Ce.TRIANGLE_STRIP&&e.mode!==Ce.TRIANGLE_FAN&&void 0!==e.mode)return null;const a=r.extensions[this.name].attributes,o=[],s={};for(const e in a)o.push(this.parser.getDependency("accessor",a[e]).then((t=>(s[e]=t,s[e]))));return o.length<1?null:(o.push(this.parser.createNodeMesh(t)),Promise.all(o).then((t=>{const n=t.pop(),r=n.isGroup?n.children:[n],i=t[0].count,a=[];for(const t of r){const n=new e.Matrix4,r=new e.Vector3,o=new e.Quaternion,l=new e.Vector3(1,1,1),u=new e.InstancedMesh(t.geometry,t.material,i);for(let e=0;e<i;e++)s.TRANSLATION&&r.fromBufferAttribute(s.TRANSLATION,e),s.ROTATION&&o.fromBufferAttribute(s.ROTATION,e),s.SCALE&&l.fromBufferAttribute(s.SCALE,e),u.setMatrixAt(e,n.compose(r,o,l));for(const e in s)"TRANSLATION"!==e&&"ROTATION"!==e&&"SCALE"!==e&&t.geometry.setAttribute(e,s[e]);e.Object3D.prototype.copy.call(u,t),this.parser.assignFinalMaterial(u),a.push(u)}return n.isGroup?(n.clear(),n.add(...a),n):a[0]})))}}const ye="glTF",_e=1313821514,xe=5130562;class we{constructor(e){this.name=te.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==ye)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const r=this.header.length-12,i=new DataView(e,12);let a=0;for(;a<r;){const t=i.getUint32(a,!0);a+=4;const r=i.getUint32(a,!0);if(a+=4,r===_e){const r=new Uint8Array(e,12+a,t);this.content=n.decode(r)}else if(r===xe){const n=12+a;this.body=e.slice(n,n+t)}a+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class be{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=te.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const n=this.json,r=this.dracoLoader,i=e.extensions[this.name].bufferView,a=e.extensions[this.name].attributes,o={},s={},l={};for(const e in a){const t=Ie[e]||e.toLowerCase();o[t]=a[e]}for(const t in e.attributes){const r=Ie[t]||t.toLowerCase();if(void 0!==a[t]){const i=n.accessors[e.attributes[t]],a=Re[i.componentType];l[r]=a.name,s[r]=!0===i.normalized}}return t.getDependency("bufferView",i).then((function(e){return new Promise((function(t){r.decodeDracoFile(e,(function(e){for(const t in e.attributes){const n=e.attributes[t],r=s[t];void 0!==r&&(n.normalized=r)}t(e)}),o,l)}))}))}}class Me{constructor(){this.name=te.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class Ae{constructor(){this.name=te.KHR_MESH_QUANTIZATION}}class Te extends e.Interpolant{constructor(e,t,n,r){super(e,t,n,r)}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,r=this.valueSize,i=e*r*3+r;for(let e=0;e!==r;e++)t[e]=n[i+e];return t}interpolate_(e,t,n,r){const i=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=2*o,l=3*o,u=r-t,c=(n-t)/u,h=c*c,d=h*c,f=e*l,p=f-l,v=-2*d+3*h,m=d-h,g=1-v,y=m-h+c;for(let e=0;e!==o;e++){const t=a[p+e+o],n=a[p+e+s]*u,r=a[f+e+o],l=a[f+e]*u;i[e]=g*t+y*n+v*r+m*l}return i}}const Se=new e.Quaternion;class ke extends Te{interpolate_(e,t,n,r){const i=super.interpolate_(e,t,n,r);return Se.fromArray(i).normalize().toArray(i),i}}const Ce={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},Re={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Le={9728:e.NearestFilter,9729:e.LinearFilter,9984:e.NearestMipmapNearestFilter,9985:e.LinearMipmapNearestFilter,9986:e.NearestMipmapLinearFilter,9987:e.LinearMipmapLinearFilter},Pe={33071:e.ClampToEdgeWrapping,33648:e.MirroredRepeatWrapping,10497:e.RepeatWrapping},Ee={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Ie={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Oe={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},De={CUBICSPLINE:void 0,LINEAR:e.InterpolateLinear,STEP:e.InterpolateDiscrete},Ne="OPAQUE",Ue="MASK",Fe="BLEND";function Be(e,t,n){for(const r in n.extensions)void 0===e[r]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[r]=n.extensions[r])}function ze(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function Ve(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,r=t.weights.length;n<r;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){const n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,r=n.length;t<r;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Ge(e){let t;const n=e.extensions&&e.extensions[te.KHR_DRACO_MESH_COMPRESSION];if(t=n?"draco:"+n.bufferView+":"+n.indices+":"+je(n.attributes):e.indices+":"+je(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,r=e.targets.length;n<r;n++)t+=":"+je(e.targets[n]);return t}function je(e){let t="";const n=Object.keys(e).sort();for(let r=0,i=n.length;r<i;r++)t+=n[r]+":"+e[n[r]]+";";return t}function He(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const We=new e.Matrix4;class Xe{constructor(t={},n={}){this.json=t,this.extensions={},this.plugins={},this.options=n,this.cache=new ee,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let r=!1,i=!1,a=-1;"undefined"!=typeof navigator&&(r=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),i=navigator.userAgent.indexOf("Firefox")>-1,a=i?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||r||i&&a<98?this.textureLoader=new e.TextureLoader(this.options.manager):this.textureLoader=new e.ImageBitmapLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new e.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const n=this,r=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])})).then((function(t){const a={scene:t[0][r.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:r.asset,parser:n,userData:{}};return Be(i,a,r),ze(a,r),Promise.all(n._invokeAll((function(e){return e.afterRoot&&e.afterRoot(a)}))).then((function(){e(a)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){const r=t[n].joints;for(let t=0,n=r.length;t<n;t++)e[r[t]].isBone=!0}for(let t=0,r=e.length;t<r;t++){const r=e[t];void 0!==r.mesh&&(this._addNodeRef(this.meshCache,r.mesh),void 0!==r.skin&&(n[r.mesh].isSkinnedMesh=!0)),void 0!==r.camera&&this._addNodeRef(this.cameraCache,r.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;const r=n.clone(),i=(e,t)=>{const n=this.associations.get(e);null!=n&&this.associations.set(t,n);for(const[n,r]of e.children.entries())i(r,t.children[n])};return i(n,r),r.name+="_instance_"+e.uses[t]++,r}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){const r=e(t[n]);if(r)return r}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const n=[];for(let r=0;r<t.length;r++){const i=e(t[r]);i&&n.push(i)}return n}getDependency(e,t){const n=e+":"+t;let r=this.cache.get(n);if(!r){switch(e){case"scene":r=this.loadScene(t);break;case"node":r=this._invokeOne((function(e){return e.loadNode&&e.loadNode(t)}));break;case"mesh":r=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":r=this.loadAccessor(t);break;case"bufferView":r=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":r=this.loadBuffer(t);break;case"material":r=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":r=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":r=this.loadSkin(t);break;case"animation":r=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":r=this.loadCamera(t);break;default:if(r=this._invokeOne((function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)})),!r)throw new Error("Unknown type: "+e)}this.cache.add(n,r)}return r}getDependencies(e){let t=this.cache.get(e);if(!t){const n=this,r=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(r.map((function(t,r){return n.getDependency(e,r)}))),this.cache.add(e,t)}return t}loadBuffer(t){const n=this.json.buffers[t],r=this.fileLoader;if(n.type&&"arraybuffer"!==n.type)throw new Error("THREE.GLTFLoader: "+n.type+" buffer type is not supported.");if(void 0===n.uri&&0===t)return Promise.resolve(this.extensions[te.KHR_BINARY_GLTF].body);const i=this.options;return new Promise((function(t,a){r.load(e.LoaderUtils.resolveURL(n.uri,i.path),t,void 0,(function(){a(new Error('THREE.GLTFLoader: Failed to load buffer "'+n.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const n=t.byteLength||0,r=t.byteOffset||0;return e.slice(r,r+n)}))}loadAccessor(t){const n=this,r=this.json,i=this.json.accessors[t];if(void 0===i.bufferView&&void 0===i.sparse){const t=Ee[i.type],n=Re[i.componentType],r=!0===i.normalized,a=new n(i.count*t);return Promise.resolve(new e.BufferAttribute(a,t,r))}const a=[];return void 0!==i.bufferView?a.push(this.getDependency("bufferView",i.bufferView)):a.push(null),void 0!==i.sparse&&(a.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),a.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(a).then((function(t){const a=t[0],o=Ee[i.type],s=Re[i.componentType],l=s.BYTES_PER_ELEMENT,u=l*o,c=i.byteOffset||0,h=void 0!==i.bufferView?r.bufferViews[i.bufferView].byteStride:void 0,d=!0===i.normalized;let f,p;if(h&&h!==u){const t=Math.floor(c/h),r="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+t+":"+i.count;let u=n.cache.get(r);u||(f=new s(a,t*h,i.count*h/l),u=new e.InterleavedBuffer(f,h/l),n.cache.add(r,u)),p=new e.InterleavedBufferAttribute(u,o,c%h/l,d)}else f=null===a?new s(i.count*o):new s(a,c,i.count*o),p=new e.BufferAttribute(f,o,d);if(void 0!==i.sparse){const n=Ee.SCALAR,r=Re[i.sparse.indices.componentType],l=i.sparse.indices.byteOffset||0,u=i.sparse.values.byteOffset||0,c=new r(t[1],l,i.sparse.count*n),h=new s(t[2],u,i.sparse.count*o);null!==a&&(p=new e.BufferAttribute(p.array.slice(),p.itemSize,p.normalized));for(let e=0,t=c.length;e<t;e++){const t=c[e];if(p.setX(t,h[e*o]),o>=2&&p.setY(t,h[e*o+1]),o>=3&&p.setZ(t,h[e*o+2]),o>=4&&p.setW(t,h[e*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return p}))}loadTexture(e){const t=this.json,n=this.options,r=t.textures[e].source,i=t.images[r];let a=this.textureLoader;if(i.uri){const e=n.manager.getHandler(i.uri);null!==e&&(a=e)}return this.loadTextureImage(e,r,a)}loadTextureImage(t,n,r){const i=this,a=this.json,o=a.textures[t],s=a.images[n],l=(s.uri||s.bufferView)+":"+o.sampler;if(this.textureCache[l])return this.textureCache[l];const u=this.loadImageSource(n,r).then((function(n){n.flipY=!1,n.name=o.name||s.name||"",""===n.name&&"string"==typeof s.uri&&!1===s.uri.startsWith("data:image/")&&(n.name=s.uri);const r=(a.samplers||{})[o.sampler]||{};return n.magFilter=Le[r.magFilter]||e.LinearFilter,n.minFilter=Le[r.minFilter]||e.LinearMipmapLinearFilter,n.wrapS=Pe[r.wrapS]||e.RepeatWrapping,n.wrapT=Pe[r.wrapT]||e.RepeatWrapping,i.associations.set(n,{textures:t}),n})).catch((function(){return null}));return this.textureCache[l]=u,u}loadImageSource(t,n){const r=this,i=this.json,a=this.options;if(void 0!==this.sourceCache[t])return this.sourceCache[t].then((e=>e.clone()));const o=i.images[t],s=self.URL||self.webkitURL;let l=o.uri||"",u=!1;if(void 0!==o.bufferView)l=r.getDependency("bufferView",o.bufferView).then((function(e){u=!0;const t=new Blob([e],{type:o.mimeType});return l=s.createObjectURL(t),l}));else if(void 0===o.uri)throw new Error("THREE.GLTFLoader: Image "+t+" is missing URI and bufferView");const c=Promise.resolve(l).then((function(t){return new Promise((function(r,i){let o=r;!0===n.isImageBitmapLoader&&(o=function(t){const n=new e.Texture(t);n.needsUpdate=!0,r(n)}),n.load(e.LoaderUtils.resolveURL(t,a.path),o,void 0,i)}))})).then((function(e){var t;return!0===u&&s.revokeObjectURL(l),e.userData.mimeType=o.mimeType||((t=o.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",l),e}));return this.sourceCache[t]=c,c}assignTexture(e,t,n,r){const i=this;return this.getDependency("texture",n.index).then((function(a){if(!a)return null;if(void 0!==n.texCoord&&n.texCoord>0&&((a=a.clone()).channel=n.texCoord),i.extensions[te.KHR_TEXTURE_TRANSFORM]){const e=void 0!==n.extensions?n.extensions[te.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=i.associations.get(a);a=i.extensions[te.KHR_TEXTURE_TRANSFORM].extendTexture(a,e),i.associations.set(a,t)}}return void 0!==r&&(a.colorSpace=r),e[t]=a,a}))}assignFinalMaterial(t){const n=t.geometry;let r=t.material;const i=void 0===n.attributes.tangent,a=void 0!==n.attributes.color,o=void 0===n.attributes.normal;if(t.isPoints){const t="PointsMaterial:"+r.uuid;let n=this.cache.get(t);n||(n=new e.PointsMaterial,e.Material.prototype.copy.call(n,r),n.color.copy(r.color),n.map=r.map,n.sizeAttenuation=!1,this.cache.add(t,n)),r=n}else if(t.isLine){const t="LineBasicMaterial:"+r.uuid;let n=this.cache.get(t);n||(n=new e.LineBasicMaterial,e.Material.prototype.copy.call(n,r),n.color.copy(r.color),n.map=r.map,this.cache.add(t,n)),r=n}if(i||a||o){let e="ClonedMaterial:"+r.uuid+":";i&&(e+="derivative-tangents:"),a&&(e+="vertex-colors:"),o&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=r.clone(),a&&(t.vertexColors=!0),o&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(r))),r=t}t.material=r}getMaterialType(){return e.MeshStandardMaterial}loadMaterial(t){const n=this,r=this.json,i=this.extensions,a=r.materials[t];let o;const s={},l=[];if((a.extensions||{})[te.KHR_MATERIALS_UNLIT]){const e=i[te.KHR_MATERIALS_UNLIT];o=e.getMaterialType(),l.push(e.extendParams(s,a,n))}else{const r=a.pbrMetallicRoughness||{};if(s.color=new e.Color(1,1,1),s.opacity=1,Array.isArray(r.baseColorFactor)){const t=r.baseColorFactor;s.color.setRGB(t[0],t[1],t[2],e.LinearSRGBColorSpace),s.opacity=t[3]}void 0!==r.baseColorTexture&&l.push(n.assignTexture(s,"map",r.baseColorTexture,e.SRGBColorSpace)),s.metalness=void 0!==r.metallicFactor?r.metallicFactor:1,s.roughness=void 0!==r.roughnessFactor?r.roughnessFactor:1,void 0!==r.metallicRoughnessTexture&&(l.push(n.assignTexture(s,"metalnessMap",r.metallicRoughnessTexture)),l.push(n.assignTexture(s,"roughnessMap",r.metallicRoughnessTexture))),o=this._invokeOne((function(e){return e.getMaterialType&&e.getMaterialType(t)})),l.push(Promise.all(this._invokeAll((function(e){return e.extendMaterialParams&&e.extendMaterialParams(t,s)}))))}!0===a.doubleSided&&(s.side=e.DoubleSide);const u=a.alphaMode||Ne;if(u===Fe?(s.transparent=!0,s.depthWrite=!1):(s.transparent=!1,u===Ue&&(s.alphaTest=void 0!==a.alphaCutoff?a.alphaCutoff:.5)),void 0!==a.normalTexture&&o!==e.MeshBasicMaterial&&(l.push(n.assignTexture(s,"normalMap",a.normalTexture)),s.normalScale=new e.Vector2(1,1),void 0!==a.normalTexture.scale)){const e=a.normalTexture.scale;s.normalScale.set(e,e)}if(void 0!==a.occlusionTexture&&o!==e.MeshBasicMaterial&&(l.push(n.assignTexture(s,"aoMap",a.occlusionTexture)),void 0!==a.occlusionTexture.strength&&(s.aoMapIntensity=a.occlusionTexture.strength)),void 0!==a.emissiveFactor&&o!==e.MeshBasicMaterial){const t=a.emissiveFactor;s.emissive=(new e.Color).setRGB(t[0],t[1],t[2],e.LinearSRGBColorSpace)}return void 0!==a.emissiveTexture&&o!==e.MeshBasicMaterial&&l.push(n.assignTexture(s,"emissiveMap",a.emissiveTexture,e.SRGBColorSpace)),Promise.all(l).then((function(){const e=new o(s);return a.name&&(e.name=a.name),ze(e,a),n.associations.set(e,{materials:t}),a.extensions&&Be(i,e,a),e}))}createUniqueName(t){const n=e.PropertyBinding.sanitizeNodeName(t||"");return n in this.nodeNamesUsed?n+"_"+ ++this.nodeNamesUsed[n]:(this.nodeNamesUsed[n]=0,n)}loadGeometries(t){const n=this,r=this.extensions,i=this.primitiveCache;function a(e){return r[te.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,n).then((function(t){return Ke(t,e,n)}))}const o=[];for(let r=0,s=t.length;r<s;r++){const s=t[r],l=Ge(s),u=i[l];if(u)o.push(u.promise);else{let t;t=s.extensions&&s.extensions[te.KHR_DRACO_MESH_COMPRESSION]?a(s):Ke(new e.BufferGeometry,s,n),i[l]={primitive:s,promise:t},o.push(t)}}return Promise.all(o)}loadMesh(t){const n=this,r=this.json,i=this.extensions,a=r.meshes[t],o=a.primitives,s=[];for(let t=0,n=o.length;t<n;t++){const n=void 0===o[t].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new e.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:e.FrontSide})),l.DefaultMaterial):this.getDependency("material",o[t].material);s.push(n)}var l;return s.push(n.loadGeometries(o)),Promise.all(s).then((function(r){const s=r.slice(0,r.length-1),l=r[r.length-1],u=[];for(let r=0,c=l.length;r<c;r++){const c=l[r],h=o[r];let d;const f=s[r];if(h.mode===Ce.TRIANGLES||h.mode===Ce.TRIANGLE_STRIP||h.mode===Ce.TRIANGLE_FAN||void 0===h.mode)d=!0===a.isSkinnedMesh?new e.SkinnedMesh(c,f):new e.Mesh(c,f),!0===d.isSkinnedMesh&&d.normalizeSkinWeights(),h.mode===Ce.TRIANGLE_STRIP?d.geometry=V(d.geometry,e.TriangleStripDrawMode):h.mode===Ce.TRIANGLE_FAN&&(d.geometry=V(d.geometry,e.TriangleFanDrawMode));else if(h.mode===Ce.LINES)d=new e.LineSegments(c,f);else if(h.mode===Ce.LINE_STRIP)d=new e.Line(c,f);else if(h.mode===Ce.LINE_LOOP)d=new e.LineLoop(c,f);else{if(h.mode!==Ce.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);d=new e.Points(c,f)}Object.keys(d.geometry.morphAttributes).length>0&&Ve(d,a),d.name=n.createUniqueName(a.name||"mesh_"+t),ze(d,a),h.extensions&&Be(i,d,h),n.assignFinalMaterial(d),u.push(d)}for(let e=0,r=u.length;e<r;e++)n.associations.set(u[e],{meshes:t,primitives:e});if(1===u.length)return a.extensions&&Be(i,u[0],a),u[0];const c=new e.Group;a.extensions&&Be(i,c,a),n.associations.set(c,{meshes:t});for(let e=0,t=u.length;e<t;e++)c.add(u[e]);return c}))}loadCamera(t){let n;const r=this.json.cameras[t],i=r[r.type];if(i)return"perspective"===r.type?n=new e.PerspectiveCamera(e.MathUtils.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===r.type&&(n=new e.OrthographicCamera(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),r.name&&(n.name=this.createUniqueName(r.name)),ze(n,r),Promise.resolve(n);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(t){const n=this.json.skins[t],r=[];for(let e=0,t=n.joints.length;e<t;e++)r.push(this._loadNodeShallow(n.joints[e]));return void 0!==n.inverseBindMatrices?r.push(this.getDependency("accessor",n.inverseBindMatrices)):r.push(null),Promise.all(r).then((function(t){const r=t.pop(),i=t,a=[],o=[];for(let t=0,s=i.length;t<s;t++){const s=i[t];if(s){a.push(s);const n=new e.Matrix4;null!==r&&n.fromArray(r.array,16*t),o.push(n)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',n.joints[t])}return new e.Skeleton(a,o)}))}loadAnimation(t){const n=this.json,r=this,i=n.animations[t],a=i.name?i.name:"animation_"+t,o=[],s=[],l=[],u=[],c=[];for(let e=0,t=i.channels.length;e<t;e++){const t=i.channels[e],n=i.samplers[t.sampler],r=t.target,a=r.node,h=void 0!==i.parameters?i.parameters[n.input]:n.input,d=void 0!==i.parameters?i.parameters[n.output]:n.output;void 0!==r.node&&(o.push(this.getDependency("node",a)),s.push(this.getDependency("accessor",h)),l.push(this.getDependency("accessor",d)),u.push(n),c.push(r))}return Promise.all([Promise.all(o),Promise.all(s),Promise.all(l),Promise.all(u),Promise.all(c)]).then((function(t){const n=t[0],i=t[1],o=t[2],s=t[3],l=t[4],u=[];for(let e=0,t=n.length;e<t;e++){const t=n[e],a=i[e],c=o[e],h=s[e],d=l[e];if(void 0===t)continue;t.updateMatrix&&t.updateMatrix();const f=r._createAnimationTracks(t,a,c,h,d);if(f)for(let e=0;e<f.length;e++)u.push(f[e])}return new e.AnimationClip(a,void 0,u)}))}createNodeMesh(e){const t=this.json,n=this,r=t.nodes[e];return void 0===r.mesh?null:n.getDependency("mesh",r.mesh).then((function(e){const t=n._getNodeRef(n.meshCache,r.mesh,e);return void 0!==r.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,n=r.weights.length;t<n;t++)e.morphTargetInfluences[t]=r.weights[t]})),t}))}loadNode(e){const t=this,n=this.json.nodes[e],r=t._loadNodeShallow(e),i=[],a=n.children||[];for(let e=0,n=a.length;e<n;e++)i.push(t.getDependency("node",a[e]));const o=void 0===n.skin?Promise.resolve(null):t.getDependency("skin",n.skin);return Promise.all([r,Promise.all(i),o]).then((function(e){const t=e[0],n=e[1],r=e[2];null!==r&&t.traverse((function(e){e.isSkinnedMesh&&e.bind(r,We)}));for(let e=0,r=n.length;e<r;e++)t.add(n[e]);return t}))}_loadNodeShallow(t){const n=this.json,r=this.extensions,i=this;if(void 0!==this.nodeCache[t])return this.nodeCache[t];const a=n.nodes[t],o=a.name?i.createUniqueName(a.name):"",s=[],l=i._invokeOne((function(e){return e.createNodeMesh&&e.createNodeMesh(t)}));return l&&s.push(l),void 0!==a.camera&&s.push(i.getDependency("camera",a.camera).then((function(e){return i._getNodeRef(i.cameraCache,a.camera,e)}))),i._invokeAll((function(e){return e.createNodeAttachment&&e.createNodeAttachment(t)})).forEach((function(e){s.push(e)})),this.nodeCache[t]=Promise.all(s).then((function(n){let s;if(s=!0===a.isBone?new e.Bone:n.length>1?new e.Group:1===n.length?n[0]:new e.Object3D,s!==n[0])for(let e=0,t=n.length;e<t;e++)s.add(n[e]);if(a.name&&(s.userData.name=a.name,s.name=o),ze(s,a),a.extensions&&Be(r,s,a),void 0!==a.matrix){const t=new e.Matrix4;t.fromArray(a.matrix),s.applyMatrix4(t)}else void 0!==a.translation&&s.position.fromArray(a.translation),void 0!==a.rotation&&s.quaternion.fromArray(a.rotation),void 0!==a.scale&&s.scale.fromArray(a.scale);return i.associations.has(s)||i.associations.set(s,{}),i.associations.get(s).nodes=t,s})),this.nodeCache[t]}loadScene(t){const n=this.extensions,r=this.json.scenes[t],i=this,a=new e.Group;r.name&&(a.name=i.createUniqueName(r.name)),ze(a,r),r.extensions&&Be(n,a,r);const o=r.nodes||[],s=[];for(let e=0,t=o.length;e<t;e++)s.push(i.getDependency("node",o[e]));return Promise.all(s).then((function(t){for(let e=0,n=t.length;e<n;e++)a.add(t[e]);return i.associations=(t=>{const n=new Map;for(const[t,r]of i.associations)(t instanceof e.Material||t instanceof e.Texture)&&n.set(t,r);return t.traverse((e=>{const t=i.associations.get(e);null!=t&&n.set(e,t)})),n})(a),a}))}_createAnimationTracks(t,n,r,i,a){const o=[],s=t.name?t.name:t.uuid,l=[];let u;switch(Oe[a.path]===Oe.weights?t.traverse((function(e){e.morphTargetInfluences&&l.push(e.name?e.name:e.uuid)})):l.push(s),Oe[a.path]){case Oe.weights:u=e.NumberKeyframeTrack;break;case Oe.rotation:u=e.QuaternionKeyframeTrack;break;case Oe.position:case Oe.scale:u=e.VectorKeyframeTrack;break;default:if(1===r.itemSize)u=e.NumberKeyframeTrack;else u=e.VectorKeyframeTrack}const c=void 0!==i.interpolation?De[i.interpolation]:e.InterpolateLinear,h=this._getArrayFromAccessor(r);for(let e=0,t=l.length;e<t;e++){const t=new u(l[e]+"."+Oe[a.path],n.array,h,c);"CUBICSPLINE"===i.interpolation&&this._createCubicSplineTrackInterpolant(t),o.push(t)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=He(t.constructor),n=new Float32Array(t.length);for(let r=0,i=t.length;r<i;r++)n[r]=t[r]*e;t=n}return t}_createCubicSplineTrackInterpolant(t){t.createInterpolant=function(t){return new(this instanceof e.QuaternionKeyframeTrack?ke:Te)(this.times,this.values,this.getValueSize()/3,t)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Ke(t,n,r){const i=n.attributes,a=[];function o(e,n){return r.getDependency("accessor",e).then((function(e){t.setAttribute(n,e)}))}for(const e in i){const n=Ie[e]||e.toLowerCase();n in t.attributes||a.push(o(i[e],n))}if(void 0!==n.indices&&!t.index){const e=r.getDependency("accessor",n.indices).then((function(e){t.setIndex(e)}));a.push(e)}return e.ColorManagement.workingColorSpace!==e.LinearSRGBColorSpace&&"COLOR_0"in i&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${e.ColorManagement.workingColorSpace}" not supported.`),ze(t,n),function(t,n,r){const i=n.attributes,a=new e.Box3;if(void 0===i.POSITION)return;{const t=r.json.accessors[i.POSITION],n=t.min,o=t.max;if(void 0===n||void 0===o)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(a.set(new e.Vector3(n[0],n[1],n[2]),new e.Vector3(o[0],o[1],o[2])),t.normalized){const e=He(Re[t.componentType]);a.min.multiplyScalar(e),a.max.multiplyScalar(e)}}const o=n.targets;if(void 0!==o){const t=new e.Vector3,n=new e.Vector3;for(let e=0,i=o.length;e<i;e++){const i=o[e];if(void 0!==i.POSITION){const e=r.json.accessors[i.POSITION],a=e.min,o=e.max;if(void 0!==a&&void 0!==o){if(n.setX(Math.max(Math.abs(a[0]),Math.abs(o[0]))),n.setY(Math.max(Math.abs(a[1]),Math.abs(o[1]))),n.setZ(Math.max(Math.abs(a[2]),Math.abs(o[2]))),e.normalized){const t=He(Re[e.componentType]);n.multiplyScalar(t)}t.max(n)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}a.expandByVector(t)}t.boundingBox=a;const s=new e.Sphere;a.getCenter(s.center),s.radius=a.min.distanceTo(a.max)/2,t.boundingSphere=s}(t,n,r),Promise.all(a).then((function(){return void 0!==n.targets?function(e,t,n){let r=!1,i=!1,a=!1;for(let e=0,n=t.length;e<n;e++){const n=t[e];if(void 0!==n.POSITION&&(r=!0),void 0!==n.NORMAL&&(i=!0),void 0!==n.COLOR_0&&(a=!0),r&&i&&a)break}if(!r&&!i&&!a)return Promise.resolve(e);const o=[],s=[],l=[];for(let u=0,c=t.length;u<c;u++){const c=t[u];if(r){const t=void 0!==c.POSITION?n.getDependency("accessor",c.POSITION):e.attributes.position;o.push(t)}if(i){const t=void 0!==c.NORMAL?n.getDependency("accessor",c.NORMAL):e.attributes.normal;s.push(t)}if(a){const t=void 0!==c.COLOR_0?n.getDependency("accessor",c.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(o),Promise.all(s),Promise.all(l)]).then((function(t){const n=t[0],o=t[1],s=t[2];return r&&(e.morphAttributes.position=n),i&&(e.morphAttributes.normal=o),a&&(e.morphAttributes.color=s),e.morphTargetsRelative=!0,e}))}(t,n.targets,r):t}))}var Ye=function(e){function t(e){var n;f(this,t);var r=b({zooms:[4,22],interact:!0,models:[],impactName:"灯杆",animate:!0},e);return m(n=d(this,t,[r]),"_lastPick",null),m(n,"_data",[]),m(n,"_group",null),m(n,"_models",[]),m(n,"_impactName",""),m(n,"_mixers",[]),n._impactName=r.impactName,r.models.length<=0?(console.error("缺少模型配置"),M(n)):(n._models=k(r.models),n.loader=null,r.data&&(n.data=r.data),n)}return _(t,e),v(t,[{key:"data",get:function(){return this._data},set:function(e){var t=e.features,n=[];t?(this._data=t.map((function(e){var t=e.properties,n=e.geometry;return b(b({},t),{},{lngLat:n.coordinates})})),n=this.customCoords.lngLatsToCoords(t.map((function(e){return e.geometry.coordinates})))):e instanceof Array&&(this._data=e,n=this.customCoords.lngLatsToCoords(e.map((function(e){return e.lngLat})))),this._data.forEach((function(e,t){e.coords=n[t]})),this.updateModel()}},{key:"init",value:function(){}},{key:"onReady",value:function(){this.updateModel(),this.initMouseEvent()}},{key:"onPicked",value:function(e){var t,n,r=e.targets,i=e.event,a=null;if(r.length>0){var o=this.getParentObject(r[0],{name:this._impactName});o?(this.setLastPick(o),a=o._attrs):this.removeLastPick()}else this.removeLastPick();this.handleEvent("pick",{screenX:null==i||null===(t=i.pixel)||void 0===t?void 0:t.x,screenY:null==i||null===(n=i.pixel)||void 0===n?void 0:n.y,attrs:a})}},{key:"loadOneModel",value:function(e,t){var n=this,r=this._models,i=e.modelId,a=e.size,o=e.sourceUrl;return new Promise((function(e){void 0!==(r.find((function(e){return e.modelId===i}))||{}).model?e():n.loader.load(o,(function(n){var i=n.scene.children[0];i.scale.set(a,a,a),i.rotateX(Math.PI/2),r[t].model=i,r[t].animations=n.animations,e()}),(function(e){console.log(e.loaded/e.total*100+"% loaded")}),(function(e){console.log("An error happened"+e)}))}))}},{key:"loadModel",value:(r=h(A().mark((function e(){var t,n;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:null===this.loader&&(this.loader=new $),null===this._group&&(this._group=new o.Group,this.scene.add(this._group)),t=this._models,n=0;case 4:if(!(n<t.length)){e.next=10;break}return e.next=7,this.loadOneModel(t[n],n);case 7:n++,e.next=4;break;case 10:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"clearModel",value:function(){if(this._group){var e=this._group.children;do{this._group.remove(e[0])}while(e.length>0);this._mixers.length&&(this._mixers.forEach((function(e){e.stopAllAction(),e.uncacheRoot()})),this._mixers=[])}}},{key:"getModelConfById",value:function(e){return this._models.find((function(t){return t.modelId===e}))}},{key:"initMouseEvent",value:function(){var e=this;this.container.addEventListener("click",(function(t){var n=e._lastPick;n&&e.handleEvent("click",{screenX:null==t?void 0:t.clientX,screenY:null==t?void 0:t.clientY,attrs:n._attrs})}))}},{key:"updateModel",value:(n=h(A().mark((function e(){var t,n,r,i,a=this;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.scene){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.loadModel();case 4:t=this._group,n=this._data,r=this._isAnimate,i=this._mixers,this.clearModel(),n.forEach((function(e,n){var s=e.id,l=e.modelId,u=e.altitude,c=e.angle,h=e.coords,d=e.lngLat,f=a.getModelConfById(l),p=f.model,v=f.animations,m=f.upAxis,g=p.clone();if(g._attrs={id:s,altitude:u,angle:c,coords:h,modelId:l,lngLat:d},g.position.set(h[0],h[1],void 0===u?0:u),void 0!==c&&g["x"===m?"rotateX":"z"===m?"rotateZ":"rotateY"](-c/180*Math.PI),r&&v.length){var y=new o.AnimationMixer(g),_=y.clipAction(v[0]);_.loop=o.LoopRepeat,_.play(),i.push(y)}t.add(g)}));case 7:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"getModelById",value:function(e){return this._group.children.find((function(t){return t._attrs.id===e}))||null}},{key:"getParentObject",value:function(e,t){var n=e.object,r=t.name;do{var i;if(n.name===r||"Scene"===(null===(i=n.parent)||void 0===i||null===(i=i.parent)||void 0===i?void 0:i.type))return n;n=n.parent}while(n)}},{key:"setLastPick",value:function(e){var t=this._lastPick,n=this.scene;if(e&&(!t||JSON.stringify(null==t?void 0:t._attrs)!==JSON.stringify(null==e?void 0:e._attrs))){this.removeLastPick();var r=new o.BoxHelper(e,"#00ff00");n.add(r),r._attrs=null==e?void 0:e._attrs,this._lastPick=r}}},{key:"removeLastPick",value:function(){var e=this._lastPick,t=this.scene;e&&(t.remove(e),this._lastPick=null)}},{key:"update",value:function(){this._isAnimate&&this._mixers.forEach((function(e){e.update(.02)}))}}]);var n,r}(D),Qe=function(e){function t(e){var n;f(this,t);var r=b({zooms:[4,22],interact:!0,models:[],animate:!0},e);return m(n=d(this,t,[r]),"_lastPickIndex",{index:null,modelId:null}),m(n,"_data",{}),m(n,"_group",null),m(n,"_models",[]),r.models.length<=0?(console.error("缺少模型配置"),M(n)):(n._models=k(r.models),n.loader=null,r.data&&(n.data=r.data),n)}return _(t,e),v(t,[{key:"data",get:function(){return this._data},set:function(e){var t=this,n=e.features,r=[];n?this._data=n.map((function(e){var t=e.properties,n=e.geometry;return b(b({},t),{},{lngLat:n.coordinates})})):e instanceof Array&&e.forEach((function(e){var n=e.modelId;void 0===r[n]&&(r[n]=[]);var i=t.customCoords.lngLatsToCoords([e.lngLat]);r[n].push(b({coords:i[0]},e))})),this._data=r,this.updateModel()}},{key:"init",value:function(){}},{key:"onReady",value:function(){this.updateModel(),this.initMouseEvent()}},{key:"onPicked",value:function(e){var t,n,r=e.targets,i=e.event,a=null;if(r.length>0){var o=r[0].object;if(null!=o&&o.isInstancedMesh){var s=o.attrs.modelId,l=this._raycaster.intersectObject(o,!1)[0].instanceId;this.setLastPick({index:l,modelId:s}),a=this._data[s][l]}}else this.removeLastPick();this.handleEvent("pick",{screenX:null==i||null===(t=i.pixel)||void 0===t?void 0:t.x,screenY:null==i||null===(n=i.pixel)||void 0===n?void 0:n.y,attrs:a})}},{key:"loadOneModel",value:function(e,t){var n=this,r=this._models,i=e.modelId,a=e.sourceUrl;return new Promise((function(e){void 0!==(r.find((function(e){return e.modelId===i}))||{}).model?e():n.loader.load(a,(function(n){var i=n.scene.children[0];r[t].model=i,e()}),(function(e){console.log(e.loaded/e.total*100+"% loaded")}),(function(e){console.log("loader model fail"+e)}))}))}},{key:"loadModel",value:(r=h(A().mark((function e(){var t;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:null===this.loader&&(this.loader=new $),null===this._group&&(this._group=new o.Group,this.scene.add(this._group)),t=0;case 3:if(!(t<this._models.length)){e.next=9;break}return e.next=6,this.loadOneModel(this._models[t],t);case 6:t++,e.next=3;break;case 9:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"clearModel",value:function(){if(this._group){var e=this._group.children;do{this._group.remove(e[0])}while(e.length>0)}}},{key:"getModelConfById",value:function(e){return this._models.find((function(t){return t.modelId===e}))}},{key:"initMouseEvent",value:function(){}},{key:"updateModel",value:(n=h(A().mark((function e(){var t,n,r,i,a,o;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.scene){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.loadModel();case 4:for(t=this._group,n=this._data,this.clearModel(),r=Object.keys(n),i=0;i<r.length;i++)a=r[i],o=this.createInstancedMesh(this.getModelConfById(a),n[a]),t.add(o);case 8:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"createInstancedMesh",value:function(e,t){var n=e.model,r=e.size,i=e.name,a=e.modelId,s=t.length,l=n.geometry,u=n.material,c=new o.InstancedMesh(l,u,s);c.attrs={name:i,modelId:a};var h=new o.Object3D;h.scale.set(r,r,r),h.rotateX(Math.PI/2);for(var d=new o.Color,f=0;f<s;f++){var p=t[f];p.id,p.modelId;var v=p.altitude,m=p.angle,g=p.coords;h.position.set(g[0],g[1],void 0===v?0:v),h.updateMatrix(),void 0!==m&&h.rotateY(-m/180*Math.PI),c.setMatrixAt(f,h.matrix),c.setColorAt(f,d)}return c}},{key:"getModelById",value:function(e){return this._group.children.find((function(t){return t._attrs.id===e}))||null}},{key:"setLastPick",value:function(e){var t=e.index,n=e.modelId;if(this._lastPickIndex.index!==t||this._lastPickIndex.modelId!==n){var r=this.getMeshByModelId(n);r&&(null!==this._lastPickIndex.index&&(r.setColorAt(this._lastPickIndex.index,new o.Color),r.instanceColor.needsUpdate=!0),r.setColorAt(t,new o.Color(65535)),r.instanceColor.needsUpdate=!0,this._lastPickIndex={index:t,modelId:n})}}},{key:"getMeshByModelId",value:function(e){var t;return null===(t=this._group)||void 0===t?void 0:t.children.find((function(t){return t.attrs.modelId===e}))}},{key:"removeLastPick",value:function(){var e=this._lastPickIndex,t=e.index,n=e.modelId;if(null!==t&&null!==n){var r=this.getMeshByModelId(n);if(r){var i=new o.Color;r.setColorAt(t,i),r.instanceColor.needsUpdate=!0,this._lastPickIndex={index:null,modelId:null}}}}},{key:"update",value:function(){}}]);var n,r}(D),Ze=function(e){function t(e){var n;f(this,t);var r=b({data:null,speed:1,animate:!0,lineWidth:20,altitude:0,sizeAttenuation:!0,uvMapURL:"./static/texture/road_bg1.png"},e);return m(n=d(this,t,[r]),"_data",[]),m(n,"_material",null),n.initData(r.data),n}return _(t,e),v(t,[{key:"onReady",value:function(){this.initLines()}},{key:"initData",value:function(e){var t=null==e?void 0:e.features.map((function(e){var t;return null==e||null===(t=e.geometry)||void 0===t?void 0:t.coordinates[0]})),n=this.customCoords.lngLatsToCoords(t);this._data=n}},{key:"initLines",value:function(){var e=this,t=this.scene,n=(new o.TextureLoader).load(this.mergeSourceURL(this._conf.uvMapURL));n.wrapS=o.RepeatWrapping,n.wrapT=o.RepeatWrapping;var r=new q({lineWidth:this._conf.lineWidth,sizeAttenuation:this._conf.sizeAttenuation?1:0,useMap:1,opacity:1,map:n,transparent:!0,depthTest:!0,repeat:new o.Vector2(2,1)});this._material=r,k(this._data).forEach((function(n){var i=[];n.forEach((function(t){var n=S(t,2),r=n[0],a=n[1];i.push(new o.Vector3(r,a,e._conf.altitude))}));var a=new Z;a.setPoints(i);var s=new o.Mesh(a,r);t.add(s)}))}},{key:"update",value:function(){var e;this._isAnimate&&null!==(e=this._material)&&void 0!==e&&null!==(e=e.uniforms)&&void 0!==e&&e.offset&&(this._material.uniforms.offset.value.x-=.01*this._conf.speed)}}])}(D),qe=function(e){function t(e){var n;f(this,t);var r=b({zooms:[10,22],data:null,icon:{src:"./static/texture/pole.svg",alphaMapURL:"./static/texture/pole.svg",color:"rgba(0,255,255,0.8)",size:[64,128]}},e);return m(n=d(this,t,[r]),"_data",[]),m(n,"_features",[]),m(n,"_currIcon",null),n.initData(r.data),n}return _(t,e),v(t,[{key:"onReady",value:function(){this.initMaterial(),this.createMesh()}},{key:"onPicked",value:function(e){var t=e.targets,n=S(this._conf.icon.size,2),r=n[0],i=n[1];t.length>0?(t[0].object.scale.set(1.5*r,1.5*i,0),this._currIcon&&this._currIcon.object.scale.set(r,i,0),this._currIcon=t[0]):(this._currIcon&&this._currIcon.object.scale.set(r,i,0),this._currIcon=null)}},{key:"initData",value:function(e){var t=e.features,n=t.map((function(e){var t=S(e.geometry.coordinates,2);return[t[0],t[1]]}));this._features=t,this._data=this.customCoords.lngLatsToCoords(n)}},{key:"initMaterial",value:function(){var e=this._conf.icon,t=(new o.TextureLoader).load(e.src),n=new o.SpriteMaterial({map:t,transparent:!0,depthTest:!0});return e.alphaMapURL?n.alphaMap=(new o.TextureLoader).load(e.alphaMapURL):n.alphaMap=t,e.color&&(n.color=new o.Color(e.color)),n.blending=o.CustomBlending,n.blendDst=o.OneFactor,this._material=n,n}},{key:"createMesh",value:function(){for(var e=this.scene,t=S(this._conf.icon.size,2),n=t[0],r=t[1],i=0;i<this._data.length;i++){var a=S(this._data[i],2),s=a[0],l=a[1],u=new o.Sprite(this._material);u._attrs=this._features[i],u.scale.set(n,r,0),u.position.set(s,l,r/2),e.add(u)}}}])}(D),Je="\n    // 每个点的尺寸倍率属性\n    attribute float size; \n    // 每个点的自定义颜色属性\n    attribute vec3 customColor;\n    \n    // 指定点的大小是否因相机深度而衰减\n    uniform bool sizeAttenuation;\n    \n    // 传递颜色到片元着色器的变量\n    varying vec3 vColor; \n   \n    void main() {\n    \n      // 将自定义颜色传递到片元着色器\n      vColor = customColor;\n      \n      // 将顶点位置转换到视图空间\n      vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n      \n      if(sizeAttenuation){\n        // 根据到相机的距离计算点的大小\n        gl_PointSize = size * (512.0 / -mvPosition.z );     \n      }else{\n        gl_PointSize = size ;   \n      }\n      \n      // 计算点在投影空间的最终位置\n      gl_Position = projectionMatrix * mvPosition; \n    }\n  ",$e="\n    // 点的基础颜色统一变量\n    uniform vec3 color;  // 基础颜色\n    // 点贴图统一变量\n    uniform sampler2D pointTexture; //点贴图\n    // 透明度测试阈值统一变量\n    uniform float alphaTest; //透明度阈值\n    \n    // 获取每个点自定义颜色的变量\n    varying vec3 vColor; // 每个点的颜色\n    \n    void main() {\n    \n      // 计算点的最终颜色,乘以基础颜色和自定义颜色\n      gl_FragColor = vec4( color * vColor, 1.0 );\n      \n      // 将点贴图应用到点上     \n      // gl_FragColor = gl_FragColor * texture2D(pointTexture, gl_PointCoord);\n      \n      // 将点贴图应用到点上,gl_PointCoord的值是从[0, 1]映射到[1, 0]的范围,需要把贴图y分量翻转\n      gl_FragColor = gl_FragColor * texture2D(pointTexture, vec2(gl_PointCoord.x, 1.0 - gl_PointCoord.y));\n      \n      // 如果alpha值小于透明度测试阈值,则丢弃片元\n      if ( gl_FragColor.a < alphaTest ) discard;\n      \n    }\n      ",et=function(e){function t(e){var n;f(this,t);var r=b({zooms:[10,22],data:null,intensity:0,icon:{src:"./static/texture/pole.svg",alphaMapURL:"./static/texture/pole.svg",color:"rgba(0,255,255,0.8)",size:[64,64]},pickThreshold:0,sizeAttenuation:!0,interact:!0},e);return m(n=d(this,t,[r]),"_data",[]),m(n,"_features",[]),m(n,"_currIcon",null),n.initData(r.data),n}return _(t,e),v(t,[{key:"onReady",value:(i=h(A().mark((function e(){var t,n,r;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.createMesh();case 2:this._raycaster&&(t=this._conf,n=t.pickThreshold,r=t.icon,this._raycaster.params.Points.threshold=n>0?n:r.size[0]/4||1);case 3:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"onPicked",value:function(e){var t=e.targets,n=this._mesh.geometry.attributes,r=this._conf.icon.size[0];t.length>0?this._currIcon!==t[0].index&&(n.size.array[this._currIcon]=r,this._currIcon=t[0].index,n.size.array[this._currIcon]*=1.2,n.size.needsUpdate=!0):null!==this._currIcon&&(n.size.array[this._currIcon]=r,n.size.needsUpdate=!0,this._currIcon=null)}},{key:"initData",value:function(e){var t=e.features,n=t.map((function(e){var t=S(e.geometry.coordinates,2);return[t[0],t[1]]}));this._data=this.customCoords.lngLatsToCoords(n),this._features=t}},{key:"generateMaterial",value:(r=h(A().mark((function e(){var t,n,r,i,a,s,l;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._conf,n=t.icon,r=t.sizeAttenuation,e.next=3,(new o.TextureLoader).load(n.src);case 3:return i=e.sent,a=Je,s=$e,l=new o.ShaderMaterial({uniforms:{color:{value:new o.Color(n.color||16777215)},pointTexture:{value:i},alphaTest:{value:.1},sizeAttenuation:{value:r}},vertexShader:a,fragmentShader:s,transparent:!0}),e.abrupt("return",l);case 7:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"generateGeometry",value:function(){for(var e=new o.BufferGeometry,t=[],n=[],r=[],i=this._conf.icon.size[0],a=new o.Color,s=0;s<this._data.length;s++){var l=S(this._data[s],2),u=l[0],c=l[1],h=this._features[s].properties.scale||1;n.push(i*h),t.push(u,c,i*h/5.12),a.set(this._features[s].properties.color||"#ffffff"),a.toArray(r,3*s)}return e.setAttribute("position",new o.Float32BufferAttribute(t,3)),e.setAttribute("customColor",new o.Float32BufferAttribute(r,3)),e.setAttribute("size",new o.Float32BufferAttribute(n,1)),e}},{key:"createMesh",value:(n=h(A().mark((function e(){var t,n,r;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.generateGeometry(),e.next=3,this.generateMaterial();case 3:n=e.sent,r=new o.Points(t,n),this.scene.add(r),this._mesh=r;case 7:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"updateUniforms",value:function(e,t){this._mesh.material.uniforms[e].value=t}}]);var n,r,i}(D),tt="\n    //初始透明度\n    // attribute float opacity;\n    //点尺寸\n    uniform float size;\n    \n    void main()\n    {  \n      // float m = mod( opacity + time , 2.0);\n      // uvOpacity = m >= 1.5 ? (2.0-m) : m ;    \n      gl_PointSize = size;\n      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    }\n  ",nt="\n    #define MOD3 vec3(.1031,.11369,.13787)\n    \n    uniform vec3 color;\n    uniform float time;\n    // varying float uvOpacity;   \n    \n    float hash12(vec2 p) \n    {\n      vec3 p3  = fract(vec3(p.xyx) * MOD3);\n      p3 += dot(p3, p3.yzx + 19.19);\n      return fract((p3.x + p3.y) * p3.z);\n    }\n   \n    float stars(vec2 uv, float t)\n    {     \n      //调整闪烁频率\n      t*= 1.0;     \n      // 调整噪点透明度\n      // float n1 = hash12(uv*10000.);\n      // float n2 = hash12(uv*11234.);\n      // float alpha1 = pow(n1, 20.);\n      // float alpha2 = pow(n2, 20.);\n\n      //随机性闪烁\n      float twinkle = sin((uv.x-t+cos(uv.y*20.+t))*10.);\n      twinkle *= cos((uv.y*.234-t*3.24+sin(uv.x*12.3+t*.243))*7.34);\n      twinkle = (twinkle + 1.)/2.;\n      return twinkle;\n    }\n   \n    void main() \n    {\n      //坐标原点为画布的左上角，x轴水平向右，y竖直向下\n      vec2 uv = vec2(gl_FragCoord.x, gl_FragCoord.y);\n      float uvOpacity = stars(uv, time);\n      gl_FragColor = vec4(color, uvOpacity);\n    }\n  ",rt=function(e){function t(e){var n;f(this,t);var r=b({data:null,animate:!0},e);return m(n=d(this,t,[r]),"_data",[]),m(n,"uniforms",{color:{type:"v3",value:new o.Color(16701210)},size:{type:"float",value:1},time:{type:"float",value:0}}),n.initData(r.data),n}return _(t,e),v(t,[{key:"onReady",value:function(){this.initPoints()}},{key:"initData",value:function(e){var t=e.features.map((function(e){var t=S(e.geometry.coordinates,2);return[t[0],t[1]]}));this._data=this.customCoords.lngLatsToCoords(t)}},{key:"initPoints",value:function(){var e=this.scene,t=[],n=[];this._data.forEach((function(e){var r=S(e,2),i=r[0],a=r[1];t.push(i,a,0),n.push(parseFloat(Math.random().toFixed(2)))}));var r=new o.BufferGeometry;r.setAttribute("position",new o.Float32BufferAttribute(t,3)),r.setAttribute("opacity",new o.Float32BufferAttribute(n,1));var i=tt,a=nt,s=new o.ShaderMaterial({uniforms:this.uniforms,vertexShader:i,fragmentShader:a,blending:o.AdditiveBlending,depthTest:!1,transparent:!0}),l=new o.Points(r,s);e.add(l)}},{key:"update",value:function(){this._isAnimate&&(this.uniforms.time.value+=.01)}}])}(D),it=function(e){function t(e){var n;f(this,t);var r=b({data:null,speed:1,radius:1e3,animate:!0,textureURL:"./static/texture/texture_wave_circle.png"},e);return m(n=d(this,t,[r]),"_data",[]),m(n,"_frameX",1),m(n,"_texture",null),m(n,"_offset",0),n.initData(r.data),n}return _(t,e),v(t,[{key:"onReady",value:(r=h(A().mark((function e(){return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.initPoints();case 2:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"initData",value:function(e){var t=e.features.map((function(e){return b({lngLat:e.geometry.coordinates},e.properties)})),n=this.customCoords.lngLatsToCoords(t.map((function(e){return e.lngLat})));this._data=n}},{key:"initPoints",value:(n=h(A().mark((function e(){var t,n,r,i,a,s,l=this;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.scene,n=new o.TextureLoader,e.next=4,n.loadAsync(this.mergeSourceURL(this._conf.textureURL));case 4:r=e.sent,i=r.image,a=i.width,s=i.height,this._frameX=a/s,r.wrapS=r.wrapT=o.RepeatWrapping,r.repeat.set(1/this._frameX,1),this._texture=r,this._data.forEach((function(e){var n=S(e,2),i=n[0],a=n[1],s=l.generateGeometry(i,a),u=new o.MeshBasicMaterial({map:r,transparent:!0,depthTest:!0,depthWrite:!1}),c=new o.Mesh(s,u);t.add(c)}));case 11:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"generateGeometry",value:function(e,t){var n=this._conf.radius,r=[new o.Vector3(e-n,t-n,0),new o.Vector3(e+n,t-n,0),new o.Vector3(e-n,t+n,0),new o.Vector3(e-n,t+n,0),new o.Vector3(e+n,t-n,0),new o.Vector3(e+n,t+n,0)],i=(new o.BufferGeometry).setFromPoints(r);return i.setAttribute("uv",new o.BufferAttribute(new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),2)),i}},{key:"update",value:function(){this._isAnimate&&this._texture&&(this._offset+=this._conf.speed,this._texture.offset.x=Math.floor(this._offset)/this._frameX)}}]);var n,r}(D),at=function(e){function t(e){var n;f(this,t);var r=b({data:null,scale:1,altitude:100,content:null,sizeAttenuation:!0,interact:!1,pickEvent:"click"},e);return m(n=d(this,t,[r]),"_data",[]),m(n,"_feature",[]),m(n,"_size",1),m(n,"_content",null),n._content=r.content,n.initData(r.data),n}return _(t,e),v(t,[{key:"onReady",value:(i=h(A().mark((function e(){return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.initSprites();case 2:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"initData",value:function(e){var t=[],n=[];e.features.forEach((function(e){var r=e.properties,i=e.geometry,a=i.coordinates;t.push(a),n.push(b({type:i.type,coordinates:a},r))}));var r=this.customCoords.lngLatsToCoords(t);this._data=r,this._feature=n}},{key:"setSource",value:function(e){}},{key:"setContent",value:function(e){}},{key:"generateMaterial",value:(r=h(A().mark((function e(t,n){var r,i,a,s,u,c,h,d;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._content){e.next=3;break}return console.error("SpriteLayer 参数content 不能为空"),e.abrupt("return");case 3:return"function"===(i=U(this._content))?r=this._content(t,n):"string"===i&&(r=this._content),a=(new DOMParser).parseFromString(r,"text/xml").childNodes[0],(s=document.createElement("div")).style.cssText=a.getAttribute("style"),s.innerHTML=a.innerHTML,document.body.append(s),u=s.offsetWidth/s.offsetHeight,e.next=13,l.default(s,{backgroundColor:null,dpi:window.devicePixelRatio});case 13:return c=e.sent,(h=new o.Texture(c)).needsUpdate=!0,document.body.removeChild(s),d=new o.SpriteMaterial({map:h,sizeAttenuation:this._conf.sizeAttenuation,transparent:!0}),e.abrupt("return",{material:d,ratio:u});case 19:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"initSprites",value:(n=h(A().mark((function e(){var t,n,r,i,a,s,l,u,c,h;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this.scene,n=this._size*this._conf.scale,r=0;case 3:if(!(r<this._data.length)){e.next=18;break}return i=S(this._data[r],2),a=i[0],s=i[1],e.next=7,this.generateMaterial(r,this._feature[r]);case 7:l=e.sent,u=l.material,c=l.ratio,(h=new o.Sprite(u))._attrs=this._feature[r],h.scale.set(c*n,1*n,0),h.position.set(a,s,this._conf.altitude),t.add(h);case 15:r++,e.next=3;break;case 18:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"onPicked",value:function(e){var t,n,r=e.targets,i=e.event,a=null;if(r.length>0){var o=this.getParentObject(r[0]);o&&(a=o._attrs)}this.handleEvent("pick",{screenX:null==i||null===(t=i.pixel)||void 0===t?void 0:t.x,screenY:null==i||null===(n=i.pixel)||void 0===n?void 0:n.y,attrs:a})}},{key:"getParentObject",value:function(e){var t=e.object;do{var n;if(["Scene","Group"].includes(null===(n=t.parent)||void 0===n?void 0:n.type))return t;t=t.parent}while(t)}},{key:"update",value:function(){}}]);var n,r,i}(D);const ot=new WeakMap;class st extends e.Loader{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(t,n,r,i){const a=new e.FileLoader(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(t,(e=>{this.parse(e,n,i)}),r,i)}parse(t,n,r){this.decodeDracoFile(t,n,null,null,e.SRGBColorSpace).catch(r)}decodeDracoFile(t,n,r,i,a=e.LinearSRGBColorSpace){const o={attributeIDs:r||this.defaultAttributeIDs,attributeTypes:i||this.defaultAttributeTypes,useUniqueIDs:!!r,vertexColorSpace:a};return this.decodeGeometry(t,o).then(n)}decodeGeometry(e,t){const n=JSON.stringify(t);if(ot.has(e)){const t=ot.get(e);if(t.key===n)return t.promise;if(0===e.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let r;const i=this.workerNextTaskID++,a=e.byteLength,o=this._getWorker(i,a).then((n=>(r=n,new Promise(((n,a)=>{r._callbacks[i]={resolve:n,reject:a},r.postMessage({type:"decode",id:i,taskConfig:t,buffer:e},[e])}))))).then((e=>this._createGeometry(e.geometry)));return o.catch((()=>!0)).then((()=>{r&&i&&this._releaseTask(r,i)})),ot.set(e,{key:n,promise:o}),o}_createGeometry(t){const n=new e.BufferGeometry;t.index&&n.setIndex(new e.BufferAttribute(t.index.array,1));for(let r=0;r<t.attributes.length;r++){const i=t.attributes[r],a=i.name,o=i.array,s=i.itemSize,l=new e.BufferAttribute(o,s);"color"===a&&(this._assignVertexColorSpace(l,i.vertexColorSpace),l.normalized=o instanceof Float32Array==!1),n.setAttribute(a,l)}return n}_assignVertexColorSpace(t,n){if(n!==e.SRGBColorSpace)return;const r=new e.Color;for(let e=0,n=t.count;e<n;e++)r.fromBufferAttribute(t,e).convertSRGBToLinear(),t.setXYZ(e,r.r,r.g,r.b)}_loadLibrary(t,n){const r=new e.FileLoader(this.manager);return r.setPath(this.decoderPath),r.setResponseType(n),r.setWithCredentials(this.withCredentials),new Promise(((e,n)=>{r.load(t,e,void 0,n)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then((t=>{const n=t[0];e||(this.decoderConfig.wasmBinary=t[1]);const r=lt.toString(),i=["/* draco decoder */",n,"","/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([i]))})),this.decoderPending}_getWorker(e,t){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const e=new Worker(this.workerSourceURL);e._callbacks={},e._taskCosts={},e._taskLoad=0,e.postMessage({type:"init",decoderConfig:this.decoderConfig}),e.onmessage=function(t){const n=t.data;switch(n.type){case"decode":e._callbacks[n.id].resolve(n);break;case"error":e._callbacks[n.id].reject(n);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+n.type+'"')}},this.workerPool.push(e)}else this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const n=this.workerPool[this.workerPool.length-1];return n._taskCosts[e]=t,n._taskLoad+=t,n}))}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map((e=>e._taskLoad)))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,""!==this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),this}}function lt(){let e,t;function n(e,t,n,r,i,a){const o=a.num_components(),s=n.num_points()*o,l=s*i.BYTES_PER_ELEMENT,u=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,i),c=e._malloc(l);t.GetAttributeDataArrayForAllPoints(n,a,u,l,c);const h=new i(e.HEAPF32.buffer,c,s).slice();return e._free(c),{name:r,array:h,itemSize:o}}onmessage=function(r){const i=r.data;switch(i.type){case"init":e=i.decoderConfig,t=new Promise((function(t){e.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(e)}));break;case"decode":const r=i.buffer,a=i.taskConfig;t.then((e=>{const t=e.draco,o=new t.Decoder;try{const e=function(e,t,r,i){const a=i.attributeIDs,o=i.attributeTypes;let s,l;const u=t.GetEncodedGeometryType(r);if(u===e.TRIANGULAR_MESH)s=new e.Mesh,l=t.DecodeArrayToMesh(r,r.byteLength,s);else{if(u!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");s=new e.PointCloud,l=t.DecodeArrayToPointCloud(r,r.byteLength,s)}if(!l.ok()||0===s.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+l.error_msg());const c={index:null,attributes:[]};for(const r in a){const l=self[o[r]];let u,h;if(i.useUniqueIDs)h=a[r],u=t.GetAttributeByUniqueId(s,h);else{if(h=t.GetAttributeId(s,e[a[r]]),-1===h)continue;u=t.GetAttribute(s,h)}const d=n(e,t,s,r,l,u);"color"===r&&(d.vertexColorSpace=i.vertexColorSpace),c.attributes.push(d)}u===e.TRIANGULAR_MESH&&(c.index=function(e,t,n){const r=n.num_faces(),i=3*r,a=4*i,o=e._malloc(a);t.GetTrianglesUInt32Array(n,a,o);const s=new Uint32Array(e.HEAPF32.buffer,o,i).slice();return e._free(o),{array:s,itemSize:1}}(e,t,s));return e.destroy(s),c}(t,o,new Int8Array(r),a),s=e.attributes.map((e=>e.array.buffer));e.index&&s.push(e.index.array.buffer),self.postMessage({type:"decode",id:i.id,geometry:e},s)}catch(e){console.error(e),self.postMessage({type:"error",id:i.id,error:e.message})}finally{t.destroy(o)}}))}}}var ut,ct=function(e){function t(e){var n;return f(this,t),m(n=d(this,t,[b({zooms:[5,22],tilesURL:"",center:null,loaderURL:"./static/three/examples/js/libs/gltf/",altitude:0},e)]),"_tilesRendererArr",[]),n}return _(t,e),v(t,[{key:"onReady",value:function(){this.loadTiles()}},{key:"getCenter",value:function(){return this.customCoords.getCenter()}},{key:"loadTiles",value:function(){var e=new st;e.setDecoderPath(this.mergeSourceURL(this._conf.loaderURL));var t=new $;t.setDRACOLoader(e);var n=new r.TilesRenderer(this._conf.tilesURL);n.manager.addHandler(/\.gltf$/,t),n.setCamera(this.camera),n.setResolutionFromRenderer(this.camera,this.renderer),n.group.position.z=this._conf.altitude,this.scene.add(n.group),this._tilesRendererArr.push(n),this._conf.needShadow&&(n.onLoadModel=function(){n.group.traverse((function(e){e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}))})}},{key:"update",value:function(){var e,t=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=L(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}(this._tilesRendererArr);try{for(t.s();!(e=t.n()).done;){e.value.update()}}catch(e){t.e(e)}finally{t.f()}}},{key:"onPicked",value:function(e){var t=e.targets;e.event,t.length>0?(this.removeLastPick(),this.setLastPick(t[0].object)):this.removeLastPick()}},{key:"setLastPick",value:function(e){var t=this._lastPick;e&&"Mesh"===e.type&&(t&&JSON.stringify(null==t?void 0:t.uuid)===JSON.stringify(null==e?void 0:e.uuid)||(this.removeLastPick(),e.material.color=new o.Color(246/255,215/255,17/255),this._lastPick=e))}},{key:"removeLastPick",value:function(){this._lastPick&&(this._lastPick.material.color=new o.Color(1,1,1))}},{key:"getParentObject",value:function(e,t){var n=e.object,r=t.name;do{if(n.name===r)return n;n=n.parent}while(n)}}])}(D),ht={uniforms:{normalSampler:{type:"t",value:null},mirrorSampler:{type:"t",value:null},alpha:{type:"f",value:1},time:{type:"f",value:0},distortionScale:{type:"f",value:20},noiseScale:{type:"f",value:1},textureMatrix:{type:"m4",value:new o.Matrix4},sunColor:{type:"c",value:new o.Color(8355711)},sunDirection:{type:"v3",value:new o.Vector3(.70707,.70707,0)},eye:{type:"v3",value:new o.Vector3(0,0,0)},waterColor:{type:"c",value:new o.Color(5592405)}},vertexShader:"\n    uniform mat4 textureMatrix;\n    uniform float time;\n    varying vec4 mirrorCoord;\n    varying vec3 worldPosition;\n    varying vec3 modelPosition;\n    varying vec3 surfaceX;\n    varying vec3 surfaceY;\n    varying vec3 surfaceZ;\n    void main()\n    {\n      mirrorCoord = modelMatrix * vec4(position, 1.0);\n      worldPosition = mirrorCoord.xyz;\n      modelPosition = position;\n      surfaceX = vec3( modelMatrix[0][0], modelMatrix[0][1], modelMatrix[0][2]);\n      surfaceY = vec3( modelMatrix[1][0], modelMatrix[1][1], modelMatrix[1][2]);\n      surfaceZ = vec3( modelMatrix[2][0], modelMatrix[2][1], modelMatrix[2][2]);\n      mirrorCoord = textureMatrix * mirrorCoord;\n      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    }\n  ",fragmentShader:["uniform sampler2D mirrorSampler;","uniform float alpha;","uniform float time;","uniform float distortionScale;","uniform float noiseScale;","uniform sampler2D normalSampler;","uniform vec3 sunColor;","uniform vec3 sunDirection;","uniform vec3 eye;","uniform vec3 waterColor;","varying vec4 mirrorCoord;","varying vec3 worldPosition;","varying vec3 modelPosition;","varying vec3 surfaceX;","varying vec3 surfaceY;","varying vec3 surfaceZ;","void sunLight(const vec3 surfaceNormal, const vec3 eyeDirection, in float shiny, in float spec, in float diffuse, inout vec3 diffuseColor, inout vec3 specularColor)","{","\tvec3 reflection = normalize(reflect(-sunDirection, surfaceNormal));","\tfloat direction = max(0.0, dot(eyeDirection, reflection));","\tspecularColor += pow(direction, shiny) * sunColor * spec;","\tdiffuseColor += max(dot(sunDirection, surfaceNormal), 0.0) * sunColor * diffuse;","}","vec3 getNoise(in vec2 uv)","{","\tvec2 uv0 = uv / (103.0 * noiseScale) + vec2(time / 17.0, time / 29.0);","\tvec2 uv1 = uv / (107.0 * noiseScale) - vec2(time / -19.0, time / 31.0);","\tvec2 uv2 = uv / (vec2(8907.0, 9803.0) * noiseScale) + vec2(time / 101.0, time /   97.0);","\tvec2 uv3 = uv / (vec2(1091.0, 1027.0) * noiseScale) - vec2(time / 109.0, time / -113.0);","\tvec4 noise = texture2D(normalSampler, uv0) +","\t\ttexture2D(normalSampler, uv1) +","\t\ttexture2D(normalSampler, uv2) +","\t\ttexture2D(normalSampler, uv3);","\treturn noise.xyz * 0.5 - 1.0;","}",o.ShaderChunk.common,o.ShaderChunk.fog_pars_fragment,"void main()","{","\tvec3 worldToEye = eye - worldPosition;","\tvec3 eyeDirection = normalize(worldToEye);","\tvec3 noise = getNoise(modelPosition.xy * 1.0);","\tvec3 distordCoord = noise.x * surfaceX + noise.y * surfaceY;","\tvec3 distordNormal = distordCoord + surfaceZ;","\tif(dot(eyeDirection, surfaceZ) < 0.0)","\t\tdistordNormal = distordNormal * -1.0;","\tvec3 diffuseLight = vec3(0.0);","\tvec3 specularLight = vec3(0.0);","\tsunLight(distordNormal, eyeDirection, 100.0, 2.0, 0.5, diffuseLight, specularLight);","\tfloat distance = length(worldToEye);","\tvec2 distortion = distordCoord.xy * distortionScale * sqrt(distance) * 0.07;"," vec3 mirrorDistord = mirrorCoord.xyz + vec3(distortion.x, distortion.y, 1.0);"," vec3 reflectionSample = texture2DProj(mirrorSampler, mirrorDistord).xyz;","\tfloat theta = max(dot(eyeDirection, distordNormal), 0.0);","\tfloat reflectance = 0.3 + (1.0 - 0.3) * pow((1.0 - theta), 3.0);","\tvec3 scatter = max(0.0, dot(distordNormal, eyeDirection)) * waterColor;","\tvec3 albedo = mix(sunColor * diffuseLight * 0.3 + scatter, (vec3(0.1) + reflectionSample * 0.9 + reflectionSample * specularLight), reflectance);"," vec3 outgoingLight = albedo;",o.ShaderChunk.fog_fragment," gl_FragColor = vec4( outgoingLight, alpha );","}"].join("\n")},dt=function(e){function t(e){var n;f(this,t);var r=b({data:null,waterColor:"#78acd2",opacity:1,distortionScale:13.7,textureURL:"./static/texture/water_normals.jpg",altitude:0,animate:!0},e);m(n=d(this,t,[r]),"_data",[]),m(n,"uniforms",o.UniformsUtils.merge([o.UniformsLib.fog,o.UniformsLib.lights,ht.uniforms]));var i=(new o.TextureLoader).load(n.mergeSourceURL(r.textureURL));return i.wrapS=o.RepeatWrapping,i.wrapT=o.RepeatWrapping,n.uniforms.normalSampler.value=i,n.uniforms.waterColor.value=new o.Color(r.waterColor),n.uniforms.distortionScale.value=r.distortionScale,n.uniforms.alpha.value=r.opacity,n.initData(r.data),n}return _(t,e),v(t,[{key:"onReady",value:function(){this.createMesh()}},{key:"initData",value:function(e){var t=this;e.features.forEach((function(e){var n=e.geometry,r=e.properties;switch(n.type){case"MultiPolygon":n.coordinates[0].forEach((function(e){t._data.push({path:t.customCoords.lngLatsToCoords(e),properties:r})}));break;case"Polygon":t._data.push({path:t.customCoords.lngLatsToCoords(n.coordinates[0]),properties:r})}})),console.log(this._data)}},{key:"createMesh",value:function(){var e=this;this._data.forEach((function(t){e.drawOneArea(t)}))}},{key:"drawOneArea",value:function(e){var t=e.path,n=this.scene,r=new o.Shape;t.forEach((function(e,t){var n=S(e,2),i=n[0],a=n[1];0===t?r.moveTo(i,a):r.lineTo(i,a)}));var i=new o.ShapeGeometry(r),a=new o.Mesh(i,this.getMaterial());a.position.z=this._conf.altitude,n.add(a)}},{key:"getMaterial",value:function(){var e=ht.vertexShader,t=ht.fragmentShader;return new o.ShaderMaterial({uniforms:this.uniforms,vertexShader:e,fragmentShader:t,depthTest:!0,transparent:!0})}},{key:"update",value:function(){this._isAnimate&&this.uniforms&&(this.uniforms.time.value+=.01,this.uniforms.eye.value.setFromMatrixPosition(this.camera.matrixWorld))}}])}(D),ft="\n       // 可配置变量：高度图纹理\n        uniform sampler2D bumpTexture;\n        // 可配置变量：形变程度，数值越大形变越明显\n        uniform float bumpScale;\n        \n        // 用于传递顶点的高度\n        varying float vAmount;\n        // 用于传递顶点的 UV 贴图坐标\n        varying vec2 vUV;\n        \n        void main()\n        {\n            // 将UV映射传递到片元着色器\n            vUV = uv;\n        \n            // 高度图纹理坐标\n            vec4 bumpData = texture2D(bumpTexture, uv);\n        \n            // 高程图是灰色的(每个点的r=b=g),用于获取顶点高度，因此取rgb中任意一个值即可，这里取r\n            vAmount = bumpData.r;\n        \n            // 将顶点朝着法线的方向移动，平面的法线向上，相当于垂直抬高\n            vec3 newPosition = position + normal * bumpScale * vAmount;\n        \n            // 使用标准公式计算顶点的位置\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0);\n        }\n  ",pt="   \n        // 可配置变量：地形纹理图\n        uniform sampler2D terrainTexture;\n        // 获取从顶点着色器传来的UV\n        varying vec2 vUV;\n        // 获取从顶点着色器传来的 顶点高度\n        varying float vAmount;\n        \n        void main()\n        {\n            // 由UV来确定纹理图布局\n            gl_FragColor = texture2D(terrainTexture, vUV);\n        }\n\n  ",vt=function(e){function t(e){var n;return f(this,t),m(n=d(this,t,[b({animate:!1,zooms:[5,14],center:[0,0],style:{width:100,height:100,widthSegments:50,heightSegments:50},intensity:0,unitHeight:2,altitude:0,mapTexture:"./static/texture/terrain_terrain_texture.jpg",normalTexture:"./static/texture/terrain_map_normal.jpg",terrainTexture:"./static/texture/terrain_terrain_texture.jpg"},e)]),"_model",null),n.initData(),n}return _(t,e),v(t,[{key:"initData",value:function(){var e=S(this._conf.center,2),t=e[0],n=e[1];this._data=this.customCoords.lngLatsToCoords([t,n])}},{key:"onReady",value:(n=h(A().mark((function e(){return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.createModel();case 1:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"createModel",value:function(){var e=this.createPlaneGeometry(),t=(new o.TextureLoader).load(this.mergeSourceURL(this._conf.terrainTexture)),n=(new o.TextureLoader).load(this.mergeSourceURL(this._conf.mapTexture)),r=this.generateMaterial(t,n),i=new o.Mesh(e,r);this.scene.add(i);var a=S(this._data[0],2),s=a[0],l=a[1];i.position.set(s,l,this._conf.altitude),this._model=i}},{key:"generateMaterial",value:function(e,t){var n=ft,r=pt;return new o.ShaderMaterial({vertexShader:n,fragmentShader:r,uniforms:{terrainTexture:{value:t},bumpTexture:{value:e},bumpScale:{value:100*this._conf.unitHeight}}})}},{key:"setMapTexture",value:function(e){var t;if("string"==typeof e)t=(new o.TextureLoader).load(e);else{if(!(e instanceof o.Texture))throw"setMapTexture value invalid";t=e}var n=(new o.TextureLoader).load(this.mergeSourceURL(this._conf.terrainTexture)),r=this.generateMaterial(n,t);this._model.material=r}},{key:"createPlaneGeometry",value:function(){var e=this._conf.style,t=e.width,n=e.height,r=e.widthSegments,i=e.heightSegments;return new o.PlaneGeometry(t,n,r,i)}},{key:"update",value:function(){}}]);var n}(D),mt=Object.freeze({Linear:Object.freeze({None:function(e){return e},In:function(e){return this.None(e)},Out:function(e){return this.None(e)},InOut:function(e){return this.None(e)}}),Quadratic:Object.freeze({In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}}),Cubic:Object.freeze({In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}}),Quartic:Object.freeze({In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}}),Quintic:Object.freeze({In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}}),Sinusoidal:Object.freeze({In:function(e){return 1-Math.sin((1-e)*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.sin(Math.PI*(.5-e)))}}),Exponential:Object.freeze({In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}}),Circular:Object.freeze({In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}}),Elastic:Object.freeze({In:function(e){return 0===e?0:1===e?1:-Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)},Out:function(e){return 0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(5*(e-.1)*Math.PI)+1},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?-.5*Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI):.5*Math.pow(2,-10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)+1}}),Back:Object.freeze({In:function(e){var t=1.70158;return 1===e?1:e*e*((t+1)*e-t)},Out:function(e){var t=1.70158;return 0===e?0:--e*e*((t+1)*e+t)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}}),Bounce:Object.freeze({In:function(e){return 1-mt.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*mt.Bounce.In(2*e):.5*mt.Bounce.Out(2*e-1)+.5}}),generatePow:function(e){return void 0===e&&(e=4),e=(e=e<Number.EPSILON?Number.EPSILON:e)>1e4?1e4:e,{In:function(t){return Math.pow(t,e)},Out:function(t){return 1-Math.pow(1-t,e)},InOut:function(t){return t<.5?Math.pow(2*t,e)/2:(1-Math.pow(2-2*t,e))/2+.5}}}}),gt=function(){return performance.now()},yt=function(){function e(){this._tweens={},this._tweensAddedDuringUpdate={}}return e.prototype.getAll=function(){var e=this;return Object.keys(this._tweens).map((function(t){return e._tweens[t]}))},e.prototype.removeAll=function(){this._tweens={}},e.prototype.add=function(e){this._tweens[e.getId()]=e,this._tweensAddedDuringUpdate[e.getId()]=e},e.prototype.remove=function(e){delete this._tweens[e.getId()],delete this._tweensAddedDuringUpdate[e.getId()]},e.prototype.update=function(e,t){void 0===e&&(e=gt()),void 0===t&&(t=!1);var n=Object.keys(this._tweens);if(0===n.length)return!1;for(;n.length>0;){this._tweensAddedDuringUpdate={};for(var r=0;r<n.length;r++){var i=this._tweens[n[r]],a=!t;i&&!1===i.update(e,a)&&!t&&delete this._tweens[n[r]]}n=Object.keys(this._tweensAddedDuringUpdate)}return!0},e}(),_t={Linear:function(e,t){var n=e.length-1,r=n*t,i=Math.floor(r),a=_t.Utils.Linear;return t<0?a(e[0],e[1],r):t>1?a(e[n],e[n-1],n-r):a(e[i],e[i+1>n?n:i+1],r-i)},Bezier:function(e,t){for(var n=0,r=e.length-1,i=Math.pow,a=_t.Utils.Bernstein,o=0;o<=r;o++)n+=i(1-t,r-o)*i(t,o)*e[o]*a(r,o);return n},CatmullRom:function(e,t){var n=e.length-1,r=n*t,i=Math.floor(r),a=_t.Utils.CatmullRom;return e[0]===e[n]?(t<0&&(i=Math.floor(r=n*(1+t))),a(e[(i-1+n)%n],e[i],e[(i+1)%n],e[(i+2)%n],r-i)):t<0?e[0]-(a(e[0],e[0],e[1],e[1],-r)-e[0]):t>1?e[n]-(a(e[n],e[n],e[n-1],e[n-1],r-n)-e[n]):a(e[i?i-1:0],e[i],e[n<i+1?n:i+1],e[n<i+2?n:i+2],r-i)},Utils:{Linear:function(e,t,n){return(t-e)*n+e},Bernstein:function(e,t){var n=_t.Utils.Factorial;return n(e)/n(t)/n(e-t)},Factorial:(ut=[1],function(e){var t=1;if(ut[e])return ut[e];for(var n=e;n>1;n--)t*=n;return ut[e]=t,t}),CatmullRom:function(e,t,n,r,i){var a=.5*(n-e),o=.5*(r-t),s=i*i;return(2*t-2*n+a+o)*(i*s)+(-3*t+3*n-2*a-o)*s+a*i+t}}},xt=function(){function e(){}return e.nextId=function(){return e._nextId++},e._nextId=0,e}(),wt=new yt,bt=function(){function e(e,t){void 0===t&&(t=wt),this._object=e,this._group=t,this._isPaused=!1,this._pauseStart=0,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._isDynamic=!1,this._initialRepeat=0,this._repeat=0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=0,this._easingFunction=mt.Linear.None,this._interpolationFunction=_t.Linear,this._chainedTweens=[],this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._id=xt.nextId(),this._isChainStopped=!1,this._propertiesAreSetUp=!1,this._goToEnd=!1}return e.prototype.getId=function(){return this._id},e.prototype.isPlaying=function(){return this._isPlaying},e.prototype.isPaused=function(){return this._isPaused},e.prototype.to=function(e,t){if(void 0===t&&(t=1e3),this._isPlaying)throw new Error("Can not call Tween.to() while Tween is already started or paused. Stop the Tween first.");return this._valuesEnd=e,this._propertiesAreSetUp=!1,this._duration=t,this},e.prototype.duration=function(e){return void 0===e&&(e=1e3),this._duration=e,this},e.prototype.dynamic=function(e){return void 0===e&&(e=!1),this._isDynamic=e,this},e.prototype.start=function(e,t){if(void 0===e&&(e=gt()),void 0===t&&(t=!1),this._isPlaying)return this;if(this._group&&this._group.add(this),this._repeat=this._initialRepeat,this._reversed)for(var n in this._reversed=!1,this._valuesStartRepeat)this._swapEndStartRepeatValues(n),this._valuesStart[n]=this._valuesStartRepeat[n];if(this._isPlaying=!0,this._isPaused=!1,this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._isChainStopped=!1,this._startTime=e,this._startTime+=this._delayTime,!this._propertiesAreSetUp||t){if(this._propertiesAreSetUp=!0,!this._isDynamic){var r={};for(var i in this._valuesEnd)r[i]=this._valuesEnd[i];this._valuesEnd=r}this._setupProperties(this._object,this._valuesStart,this._valuesEnd,this._valuesStartRepeat,t)}return this},e.prototype.startFromCurrentValues=function(e){return this.start(e,!0)},e.prototype._setupProperties=function(e,t,n,r,i){for(var a in n){var o=e[a],s=Array.isArray(o),l=s?"array":typeof o,u=!s&&Array.isArray(n[a]);if("undefined"!==l&&"function"!==l){if(u){if(0===(m=n[a]).length)continue;for(var c=[o],h=0,d=m.length;h<d;h+=1){var f=this._handleRelativeValue(o,m[h]);if(isNaN(f)){u=!1,console.warn("Found invalid interpolation list. Skipping.");break}c.push(f)}u&&(n[a]=c)}if("object"!==l&&!s||!o||u)(void 0===t[a]||i)&&(t[a]=o),s||(t[a]*=1),r[a]=u?n[a].slice().reverse():t[a]||0;else{t[a]=s?[]:{};var p=o;for(var v in p)t[a][v]=p[v];r[a]=s?[]:{};var m=n[a];if(!this._isDynamic){var g={};for(var v in m)g[v]=m[v];n[a]=m=g}this._setupProperties(p,t[a],m,r[a],i)}}}},e.prototype.stop=function(){return this._isChainStopped||(this._isChainStopped=!0,this.stopChainedTweens()),this._isPlaying?(this._group&&this._group.remove(this),this._isPlaying=!1,this._isPaused=!1,this._onStopCallback&&this._onStopCallback(this._object),this):this},e.prototype.end=function(){return this._goToEnd=!0,this.update(1/0),this},e.prototype.pause=function(e){return void 0===e&&(e=gt()),this._isPaused||!this._isPlaying||(this._isPaused=!0,this._pauseStart=e,this._group&&this._group.remove(this)),this},e.prototype.resume=function(e){return void 0===e&&(e=gt()),this._isPaused&&this._isPlaying?(this._isPaused=!1,this._startTime+=e-this._pauseStart,this._pauseStart=0,this._group&&this._group.add(this),this):this},e.prototype.stopChainedTweens=function(){for(var e=0,t=this._chainedTweens.length;e<t;e++)this._chainedTweens[e].stop();return this},e.prototype.group=function(e){return void 0===e&&(e=wt),this._group=e,this},e.prototype.delay=function(e){return void 0===e&&(e=0),this._delayTime=e,this},e.prototype.repeat=function(e){return void 0===e&&(e=0),this._initialRepeat=e,this._repeat=e,this},e.prototype.repeatDelay=function(e){return this._repeatDelayTime=e,this},e.prototype.yoyo=function(e){return void 0===e&&(e=!1),this._yoyo=e,this},e.prototype.easing=function(e){return void 0===e&&(e=mt.Linear.None),this._easingFunction=e,this},e.prototype.interpolation=function(e){return void 0===e&&(e=_t.Linear),this._interpolationFunction=e,this},e.prototype.chain=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this._chainedTweens=e,this},e.prototype.onStart=function(e){return this._onStartCallback=e,this},e.prototype.onEveryStart=function(e){return this._onEveryStartCallback=e,this},e.prototype.onUpdate=function(e){return this._onUpdateCallback=e,this},e.prototype.onRepeat=function(e){return this._onRepeatCallback=e,this},e.prototype.onComplete=function(e){return this._onCompleteCallback=e,this},e.prototype.onStop=function(e){return this._onStopCallback=e,this},e.prototype.update=function(e,t){if(void 0===e&&(e=gt()),void 0===t&&(t=!0),this._isPaused)return!0;var n,r,i=this._startTime+this._duration;if(!this._goToEnd&&!this._isPlaying){if(e>i)return!1;t&&this.start(e,!0)}if(this._goToEnd=!1,e<this._startTime)return!0;!1===this._onStartCallbackFired&&(this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),!1===this._onEveryStartCallbackFired&&(this._onEveryStartCallback&&this._onEveryStartCallback(this._object),this._onEveryStartCallbackFired=!0),r=(e-this._startTime)/this._duration,r=0===this._duration||r>1?1:r;var a=this._easingFunction(r);if(this._updateProperties(this._object,this._valuesStart,this._valuesEnd,a),this._onUpdateCallback&&this._onUpdateCallback(this._object,r),1===r){if(this._repeat>0){for(n in isFinite(this._repeat)&&this._repeat--,this._valuesStartRepeat)this._yoyo||"string"!=typeof this._valuesEnd[n]||(this._valuesStartRepeat[n]=this._valuesStartRepeat[n]+parseFloat(this._valuesEnd[n])),this._yoyo&&this._swapEndStartRepeatValues(n),this._valuesStart[n]=this._valuesStartRepeat[n];return this._yoyo&&(this._reversed=!this._reversed),void 0!==this._repeatDelayTime?this._startTime=e+this._repeatDelayTime:this._startTime=e+this._delayTime,this._onRepeatCallback&&this._onRepeatCallback(this._object),this._onEveryStartCallbackFired=!1,!0}this._onCompleteCallback&&this._onCompleteCallback(this._object);for(var o=0,s=this._chainedTweens.length;o<s;o++)this._chainedTweens[o].start(this._startTime+this._duration,!1);return this._isPlaying=!1,!1}return!0},e.prototype._updateProperties=function(e,t,n,r){for(var i in n)if(void 0!==t[i]){var a=t[i]||0,o=n[i],s=Array.isArray(e[i]),l=Array.isArray(o);!s&&l?e[i]=this._interpolationFunction(o,r):"object"==typeof o&&o?this._updateProperties(e[i],a,o,r):"number"==typeof(o=this._handleRelativeValue(a,o))&&(e[i]=a+(o-a)*r)}},e.prototype._handleRelativeValue=function(e,t){return"string"!=typeof t?t:"+"===t.charAt(0)||"-"===t.charAt(0)?e+parseFloat(t):parseFloat(t)},e.prototype._swapEndStartRepeatValues=function(e){var t=this._valuesStartRepeat[e],n=this._valuesEnd[e];this._valuesStartRepeat[e]="string"==typeof n?this._valuesStartRepeat[e]+parseFloat(n):this._valuesEnd[e],this._valuesEnd[e]=t},e}(),Mt="20.0.3",At=xt.nextId,Tt=wt,St=Tt.getAll.bind(Tt),kt=Tt.removeAll.bind(Tt),Ct=Tt.add.bind(Tt),Rt=Tt.remove.bind(Tt),Lt=Tt.update.bind(Tt),Pt={Easing:mt,Group:yt,Interpolation:_t,now:gt,Sequence:xt,nextId:At,Tween:bt,VERSION:Mt,getAll:St,removeAll:kt,add:Ct,remove:Rt,update:Lt},Et=Object.freeze({__proto__:null,Easing:mt,Group:yt,Interpolation:_t,Sequence:xt,Tween:bt,VERSION:Mt,add:Ct,default:Pt,getAll:St,nextId:At,now:gt,remove:Rt,removeAll:kt,update:Lt}),It=function(e){function t(e){var n,r;f(this,t);var i=b({path:null,NPC:null,speed:50,cameraFollow:!1,perspective:3},e);return m(r=d(this,t,[i]),"_data",[]),m(r,"_PATH_COORDS",[]),m(r,"_PATH_LNG_LAT",[]),m(r,"_NPC_ALTITUDE",0),m(r,"_rayController",null),m(r,"npc_step",0),m(r,"_isMoving",!1),r._NPC_ALTITUDE=null!==(n=e.altitude)&&void 0!==n?n:0,r.initData(i.path),r}return _(t,e),v(t,[{key:"perspective",get:function(){return this._conf.perspective},set:function(e){this._conf.perspective=e,this.updateNPC()}},{key:"onReady",value:function(){this._conf.NPC&&this.initNPC(),this.initController()}},{key:"initData",value:function(e){var t=this,n=e.features;this._data=JSON.parse(JSON.stringify(n)),this._data.forEach((function(e,n){var r=e.geometry,i=r.type,a=r.coordinates;"MultiLineString"===i&&(e.geometry.coordinates=a.map((function(e){return t.handleOnePath(e)}))),"LineString"===i&&(e.geometry.coordinates=t.handleOnePath(a))}))}},{key:"handleOnePath",value:function(e){var t=this,n=this._PATH_LNG_LAT,r=this._PATH_COORDS,i=this._NPC_ALTITUDE,a=r.length,s=e.map((function(e){return[e[0],e[1],e[2]||t._NPC_ALTITUDE]}));if(a>0){var l=n[a-1],u=l.x,c=l.y,h=l.z;JSON.stringify([u,c,h])===JSON.stringify(s[0])&&s.shift()}n.push.apply(n,k(s.map((function(e){return(new o.Vector3).fromArray(e)}))));var d=this.customCoords.lngLatsToCoords(s).map((function(e,t){return[e[0],e[1],s[t][2]||i]}));return r.push.apply(r,k(d.map((function(e){return(new o.Vector3).fromArray(e)})))),s}},{key:"setPath",value:function(e){}},{key:"reStart",value:function(){null==this._rayController&&this.initController()}},{key:"stop",value:function(){this._rayController&&this.destroyController()}},{key:"resume",value:function(){this._isMoving=!0}},{key:"pause",value:function(){this._isMoving=!1}},{key:"locateNPC",value:function(){}},{key:"setSpeed",value:function(e){this._conf.speed=e}},{key:"setCameraFollow",value:function(e){this._conf.cameraFollow=!!e}},{key:"initNPC",value:function(){var e=this._PATH_COORDS,t=this.scene,n=this._conf.NPC;n.up.set(0,0,1),e.length>1&&(n.position.copy(e[0]),n.lookAt(e[1])),t.add(n)}},{key:"updateNPC",value:function(){var e=this._conf,t=e.perspective,n=e.NPC,r=this.map,i=this.scene,a=this._PATH_COORDS,o=this.npc_step;if(1===t)n&&i.remove(n),r.setZoom(22);else if(3===t){if(n){i.add(n);var s=a[o];n.position.copy(s)}r.setZoom(20)}}},{key:"initController",value:function(){var e=this,t={t:0},n=this.getMoveDuration(),r=this._PATH_COORDS,i=this._PATH_LNG_LAT;this.map,this._rayController=new bt(t).to({t:1},n).easing(mt.Linear.None).onUpdate((function(){var n=e._conf,a=n.NPC,s=n.cameraFollow,l=e.getNextStepIndex(),u=(new o.Vector3).copy(r[e.npc_step]),c=(new o.Vector3).copy(r[l]),h=(new o.Vector3).copy(u).lerp(c,t.t);if(a&&a.position.copy(h),s){var d=(new o.Vector3).copy(i[e.npc_step]),f=(new o.Vector3).copy(i[l]),p=(new o.Vector3).copy(d).lerp(f,t.t);e.updateMapCenter(p)}if(s){var v=e.getAngle(h,r[(e.npc_step+3)%r.length]);e.updateMapRotation(v)}})).onStart((function(){var t=e._conf.NPC,n=r[(e.npc_step+3)%r.length];t&&(t.lookAt(n),t.up.set(0,0,1))})).onComplete((function(){e.npc_step=e.getNextStepIndex();var n=e.getMoveDuration();t.t=0,e._rayController.stop().to({t:1},n).start()})).start()}},{key:"getNextStepIndex",value:function(){return(this.npc_step+1)%this._PATH_COORDS.length}},{key:"destroyController",value:function(){this._rayController.stop(),Rt(this._rayController),this._rayController=null}},{key:"getMoveDuration",value:function(){var e=this._PATH_COORDS,t=this.npc_step,n=this._conf.speed,r=e[t],i=e[(t+1)%e.length],a=r.distanceTo(i)/n;return 1e3*Math.max(.2,a)}},{key:"updateMapCenter",value:function(e){this.map.panTo([e.x,e.y],0)}},{key:"updateMapRotation",value:function(e){Math.abs(e)>=1&&this.map.setRotation(e,!0,0)}},{key:"coordsToLngLat",value:function(e){var t=this.map,n=this.camera,r=this.container.getBoundingClientRect(),i=r.width,a=r.height,o=r.left,s=r.top;e.project(n),e.z=0;var l=(e.x+1)/2*i+o,u=(1-e.y)/2*a+s;return t.containerToLngLat([l,u])}},{key:"getAngle",value:function(e,t){var n=t.x-e.x,r=t.y-e.y,i=180*Math.atan2(r,n)/Math.PI;return-1*((i=90-(i=i>=0?i:360+i))>=-180?i:i+360)}},{key:"update",value:function(e){var t=this._rayController,n=this._isMoving;t&&n&&t.update(e)}}])}(D),Ot=function(e){function t(e){var n;f(this,t);var r=b({data:null,altitude:0,interact:!0,pickEvent:"click",moveStep:1},e);return m(n=d(this,t,[r]),"_line",null),m(n,"_nodeData",[]),m(n,"_currNode",null),m(n,"_nodeGroup",[]),m(n,"_currNodeHelper",new o.AxesHelper(10)),m(n,"_nodeMt",new o.MeshBasicMaterial({color:65280})),m(n,"_currNodeMt",new o.MeshBasicMaterial({color:16711680})),n.initData(r.data),n}return _(t,e),v(t,[{key:"initData",value:function(e){var t,n=this,r=(null===(t=e.features[0])||void 0===t||null===(t=t.geometry)||void 0===t?void 0:t.coordinates[0])||[],i=this.customCoords.lngLatsToCoords(r);this._nodeData=i.map((function(e,t){var i=void 0===r[t][2]?n._conf.altitude:r[t][2];return new o.Vector3(e[0],e[1],i)})),this._data=i}},{key:"onReady",value:function(){this.initLine(),this.initNodes(),this.initInteract()}},{key:"initInteract",value:function(){var e=this;document.addEventListener("keydown",(function(t){if(e._currNode){var n=e._conf.moveStep,r=e._currNode.position,i=t.shiftKey?-1:1;switch(t.code){case"KeyX":e._currNode.position.set(r.x+n*i,r.y,r.z);break;case"KeyY":e._currNode.position.set(r.x,r.y+n*i,r.z);break;case"KeyZ":e._currNode.position.set(r.x,r.y,r.z+n*i)}e.reDraw()}}))}},{key:"reDraw",value:function(){this._nodeData=this._nodeGroup.map((function(e){return new o.Vector3(e.position.x,e.position.y,e.position.z)})),this.updateLine(this._nodeData)}},{key:"updateLine",value:function(e){var t=this._line.geometry;t.setFromPoints(e),t.attributes.position.needsUpdate=!0}},{key:"initLine",value:function(){var e=this.scene,t=new o.LineBasicMaterial({color:new o.Color("#00ff00")}),n=(new o.BufferGeometry).setFromPoints(this._nodeData),r=new o.Line(n,t);this._line=r,e.add(r)}},{key:"initNodes",value:function(){var e=this,t=new o.BoxGeometry(2,2,2),n=new o.Mesh(t,this._nodeMt);this._nodeData.forEach((function(t,r){var i=t.x,a=t.y,o=t.z,s=n.clone();s.position.set(i,a,o),s._attrs={index:r},e.scene.add(s),e._nodeGroup.push(s)}))}},{key:"onPicked",value:function(e){var t=e.targets;if(e.event,t.length>0){var n=t[0].object,r=n.geometry,i=n._attrs;"BoxGeometry"===(null==r?void 0:r.type)&&(console.log(JSON.stringify(i)),this.setCurrNode(t[0].object))}}},{key:"setCurrNode",value:function(e){var t=e._attrs;this._currNode&&this._currNode._attrs===t||(this._currNode&&(this._currNode.material=this._nodeMt,this._currNode.remove(this._currNodeHelper)),this._currNode=e,this._currNode.material=this._currNodeMt,this._currNode.add(this._currNodeHelper))}},{key:"getNodesLngLat",value:function(){var e=this;return this._nodeData.map((function(t){var n=e.coordsToLngLat(t.clone());return[n.lng,n.lat,t.z]}))}},{key:"coordsToLngLat",value:function(e){var t=this.map,n=this.camera,r=this.container.getBoundingClientRect(),i=r.width,a=r.height,o=r.left,s=r.top;e.z=0,e.project(n);var l=(e.x+1)/2*i+o,u=(1-e.y)/2*a+s;return t.containerToLngLat([l,u])}},{key:"update",value:function(){}}])}(D),Dt=function(e){function t(e){var n;f(this,t);var r=b({type:"cube",size:[500,500,500],altitude:0},e.bound),i=b({size:1,ratio:.01,opacity:.5,textureURL:"./static/texture/rain_drop.png",count:1e4,speed:1},e.particleStyle),a=b({windAngle:0,windPower:0},e.wind);return delete e.bound,delete e.particleStyle,delete e.wind,m(n=d(this,t,[b(b({},e),{},{bound:r,particleStyle:i,wind:a})]),"_time",0),m(n,"_clock",new o.Clock),n}return _(t,e),v(t,[{key:"initData",value:function(e){}},{key:"onReady",value:function(){this.createScope()}},{key:"createScope",value:function(){var e=this.createMaterial(),t=this.createGeometry(),n=new o.Mesh(t,e);n.position.set(0,0,this._conf.bound.altitude),this.scene.add(n)}},{key:"createGeometry",value:function(){var e=this._conf.particleStyle,t=e.count,n=e.scale,r=e.ratio,i=this._conf.bound.size,a=new o.Box3(new o.Vector3(-i[0],-i[1],0),new o.Vector3(i[0],i[1],i[2])),s=this._conf.wind,l=s.windPower;s.windAngle;for(var u=new o.Vector3(1,1,0).normalize(),c=l*Math.PI/4,h=new o.BufferGeometry,d=[],f=[],p=[],v=[],m=0;m<t;m++){var g=new o.Vector3;g.x=Math.random()*(a.max.x-a.min.x)+a.min.x,g.y=Math.random()*(a.max.y-a.min.y)+a.min.y,g.z=Math.random()*(a.max.z-a.min.z)+a.min.z;for(var y=(a.max.z-a.min.z)*n/15,_=y*r,x=[g.x+_,g.y,g.z+y/2,g.x-_,g.y,g.z+y/2,g.x-_,g.y,g.z-y/2,g.x+_,g.y,g.z-y/2],w=(new o.Matrix4).makeRotationAxis(u,c),b=0;b<x.length;b+=3){var M=new o.Vector3(x[b],x[b+1],x[b+2]);M.sub(new o.Vector3(g.x,g.y,g.z)),M.applyMatrix4(w),M.add(new o.Vector3(g.x,g.y,g.z)),x[b]=M.x,x[b+1]=M.y,x[b+2]=M.z}d.push.apply(d,x),f.push(g.x,g.y,g.z,g.x,g.y,g.z,g.x,g.y,g.z,g.x,g.y,g.z),p.push(1,1,0,1,0,0,1,0),v.push(4*m+0,4*m+1,4*m+2,4*m+0,4*m+2,4*m+3)}return h.setAttribute("position",new o.BufferAttribute(new Float32Array(d),3)),h.setAttribute("normal",new o.BufferAttribute(new Float32Array(f),3)),h.setAttribute("uv",new o.BufferAttribute(new Float32Array(p),2)),h.setIndex(new o.BufferAttribute(new Uint32Array(v),1)),h}},{key:"createMaterial",value:function(){var e=this._conf.particleStyle,t=e.opacity,n=e.textureURL,r=this._conf.wind,i=r.windAngle,a=r.windPower,s=new o.MeshBasicMaterial({transparent:!0,opacity:t,alphaMap:(new o.TextureLoader).load(this.mergeSourceURL(n)),map:(new o.TextureLoader).load(this.mergeSourceURL(n)),depthWrite:!1,side:o.DoubleSide}),l=this._conf.bound.size[2],u=Math.ceil(Math.tan(a*Math.PI/4)*l),c=i*Math.PI/180;return s.onBeforeCompile=function(e,t){e.vertexShader=e.vertexShader.replace("#include <common>","\n            uniform float top; // 天花板高度\n            uniform float bottom; // 地面高度\n            uniform float time; // 时间轴进度\n            uniform float disX; // x轴移动距离\n            uniform float disY; // y轴移动距离\n            #include <common>\n            float angle(float x, float y){\n              return atan(y, x);\n            }\n            // 让所有面始终朝向相机\n            vec2 getFoot(vec2 camera,vec2 normal,vec2 pos){           \n                vec2 position;\n                //  计算法向量到点的距离\n                float distanceLen = distance(pos, normal);\n                // 计算相机位置与法向量之间的夹角\n                float a = angle(camera.x - normal.x, camera.y - normal.y);\n                // 根据点的位置和法向量的位置调整90度 \n                pos.x > normal.x ? a -= 0.785 : a += 0.785; \n                // 计算投影值\n                position.x = cos(a) * distanceLen;\n                position.y = sin(a) * distanceLen;\n                \n                return position + normal;\n            }\n            "),e.vertexShader=e.vertexShader.replace("#include <begin_vertex>","\n            vec2 foot = getFoot(vec2(cameraPosition.x, cameraPosition.y),  vec2(normal.x, normal.y), vec2(position.x, position.y));\n            float height = top - bottom;\n            // 计算目标当前高度\n            float z = normal.z - bottom - height * time;\n            // 落地后重新开始，保持运动循环\n            z = z + (z < 0.0 ? height : 0.0);\n            // 利用自由落体公式计算目标高度\n            float ratio = (1.0 - z / height) * (1.0 - z / height);\n            z = height * (1.0 - ratio);\n            float y = foot.y + disY * ratio;\n            float x = foot.x + disX * ratio;\n            // 调整坐标参考值\n            z += bottom;\n            z += position.z - normal.z;\n            // 生成变换矩阵\n            vec3 transformed = vec3( x, y, z );\n            "),e.uniforms.cameraPosition={value:new o.Vector3(0,0,0)},e.uniforms.top={value:l},e.uniforms.bottom={value:0},e.uniforms.time={value:0},e.uniforms.disX={value:u*Math.sin(c)},e.uniforms.disY={value:u*Math.cos(c)},s.uniforms=e.uniforms},this._material=s,s}},{key:"update",value:function(){var e=this._conf,t=this._time,n=this._clock,r=this._material,i=this.camera;e&&(this._time=n.getElapsedTime()*e.particleStyle.speed/2%1,r.uniforms&&(r.uniforms.cameraPosition.value=i.position,r.uniforms.time.value=t))}}])}(D),Nt=function(e){function t(e){var n;f(this,t);var r=b({data:null},e);return(n=d(this,t,[r])).initData(r.data),n}return _(t,e),v(t,[{key:"initData",value:function(e){var t=this;this._data=JSON.parse(JSON.stringify(e)),this._data.forEach((function(e){e._center=t.customCoords.lngLatToCoord(e.center)})),console.log(this._data)}},{key:"onReady",value:function(){this.createPlanes()}},{key:"createPlanes",value:function(){var e=this;this._data.forEach((function(t){e.createOnePlane(t)}))}},{key:"createOnePlane",value:(n=h(A().mark((function e(t){var n,r,i,a,s,l,u,c,h;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.url,r=t.size,i=t._center,a=t.altitude,s=t.rotation,e.t0=o.VideoTexture,e.next=4,this.loadVideo(n);case 4:e.t1=e.sent,(l=new e.t0(e.t1)).colorSpace=o.SRGBColorSpace,u=new o.MeshLambertMaterial({map:l,side:o.DoubleSide,transparent:!0}),c=new o.PlaneGeometry(r[0],r[1]),(h=new o.Mesh(c,u)).position.set(i[0],i[1],a),h.rotation.z=o.MathUtils.degToRad(s),this.scene.add(h);case 13:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"loadVideo",value:function(e){return new Promise((function(t,n){var r=document.createElement("video");r.src=e,r.crossOrigin="anonymous",r.loop=!0,r.muted=!0,r.addEventListener("canplay",(function(){r.play(),t(r)}),!1),r.addEventListener("error",(function(e){n(e)}),!1),r.load()}))}},{key:"update",value:function(){}}]);var n}(D),Ut=function(e){function t(e){var n;f(this,t);var r=s.default.merge({zooms:[4,22],interact:!0,intensity:1,animate:!0,scale:1,colorStyle:{map:{0:"#be393a",1:"#f97f17",2:"#ffe056",3:"#2f81f7"},fieldName:null},label:{fieldName:"label",altitude:30},models:[],maxMainAltitude:1,minMainAltitude:0,mainAltitudeSpeed:1,rotateSpeed:1,traySpeed:1,PDI:!1},e);return m(n=d(this,t,[r]),"_lastPickIndex",{index:null,modelId:"main"}),m(n,"_data",[]),m(n,"_group",null),m(n,"_models",[]),m(n,"_mtMap",{}),m(n,"_offset",0),m(n,"_frameX",1),m(n,"_currentPosition",0),m(n,"_moveDirection",1),m(n,"_currentAngle",0),m(n,"_maxAngle",2*Math.PI),m(n,"_dummy",new o.Object3D),m(n,"_colorMap",{}),m(n,"_highLightIndexArray",[]),m(n,"_sizeMap",{}),m(n,"_altitudeMap",{}),m(n,"_maxMainAltitude",0),m(n,"_minMainAltitude",0),m(n,"_mainAltitudeSpeed",0),m(n,"_instancedMeshMap",{}),m(n,"_resolution",0),m(n,"_customRendererList",[]),m(n,"_customRendererIds",[]),n._models=s.default.merge([{modelId:"main",name:"主体",size:1,altitude:1,sourceUrl:"./static/gltf/taper1.glb"},{modelId:"tray",name:"托盘",size:2,altitude:0,sourceUrl:"./static/gltf/taper1-p.glb"}],r.models),n.loader=null,r.data&&(n.data=r.data),n.init(),n}return _(t,e),v(t,[{key:"data",get:function(){return this._data},set:function(e){var t=this,n=e.features,r=[];if(n)this._data=n.map((function(e){var t=e.properties,n=e.geometry;return b(b({},t),{},{lngLat:n.coordinates})})),r=this.customCoords.lngLatsToCoords(n.map((function(e){return e.geometry.coordinates})));else{if(!Array.isArray(e))return console.error("poi3dlayer: this._data invalid"),!1;this._data=e,r=this.customCoords.lngLatsToCoords(e.map((function(e){return e.lngLat})))}this._customRendererList=[],this._customRendererIds=[],this._data.forEach((function(e,n){e.coords=r[n],e.renderer&&(t._customRendererList.push({index:n,data:e}),t._customRendererIds.push(n))})),this._data.length>0?(this.resetHeightLightIndexArray(),this.updateModel()):this.clear()}},{key:"init",value:function(){this.initColorMap(),this.refreshTransformData(),this.bindMethods(["handleContainerClick","handelViewChange","handelZoomChange"])}},{key:"beforeDestroy",value:function(){this.container&&this.container.removeEventListener("click",this.handleContainerClick),this.map&&(this.map.off("zoomchange",this.handelViewChange),this.map.off("zoomend",this.handelZoomChange))}},{key:"onRender",value:function(){}},{key:"onReady",value:(u=h(A().mark((function e(){return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.updateModel();case 2:this.initMouseEvent(),this.initLight(),this.handleEvent("ready",this);case 5:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"initColorMap",value:function(){var e=this,t=this._conf.colorStyle.map;this._colorMap={},Object.keys(t).forEach((function(n){e._colorMap[n]=new o.Color(t[n])}))}},{key:"handelViewChange",value:function(){this._conf.PDI&&(this.refreshTransformData(),this.updatePOIMesh())}},{key:"refreshTransformData",value:function(){var e=this,t=this._conf;this._resolution=this.getResolution()*this._conf.scale,this._models.forEach((function(t){var n=t.size,r=t.altitude,i=t.modelId;e._sizeMap[i]=3*e._resolution*(void 0!==n?n:e._conf.scale),e._altitudeMap[i]=e._resolution*r/.08})),this._maxMainAltitude=this._altitudeMap.main+t.maxMainAltitude*this._resolution/.08,this._minMainAltitude=this._altitudeMap.main+t.minMainAltitude*this._resolution/.08,this._mainAltitudeSpeed=t.mainAltitudeSpeed*this._resolution}},{key:"handelZoomChange",value:function(){this._conf.PDI,this._visible&&this.isInZooms()}},{key:"getColorByColorField",value:function(e,t){var n=this._conf.colorStyle.fieldName,r=null==n?t%Object.keys(this._colorMap).length:e[n];return this._colorMap[r]||new o.Color("#ffffff")}},{key:"initLight",value:function(){var e=this._conf.intensity,t=new o.AmbientLight(16777215,1*e);this.scene.add(t);var n=new o.DirectionalLight(16777215,1.5*e);n.position.set(1,1,1),this.scene.add(n)}},{key:"onPicked",value:function(e){var t,n,r=e.targets,i=e.event,a=null;if(r.length>0){var o=r[0].object;if(null!=o&&o.isInstancedMesh){var s=this._raycaster.intersectObject(o,!1)[0].instanceId;this.setLastPick(s),a=this._data[s],this.container.style.cursor="pointer"}}else null!==this._lastPickIndex.index&&(this.container.style.cursor="default"),this.removeLastPick();this.handleEvent("pick",{screenX:null==i||null===(t=i.pixel)||void 0===t?void 0:t.x,screenY:null==i||null===(n=i.pixel)||void 0===n?void 0:n.y,attrs:a})}},{key:"setLastPick",value:function(e){this._lastPickIndex.index=e}},{key:"removeLastPick",value:function(){var e=this._lastPickIndex.index;if(null!==e){var t=this.getMeshByModelId("main"),n=S(this._data[e].coords,2),r=n[0],i=n[1];this.updateMatrixAt(t,{size:this._sizeMap.main,position:[r,i,this._altitudeMap.main],rotation:[0,0,0]},e)}this._lastPickIndex.index=null}},{key:"loadOneModel",value:function(e,t){var n=this,r=this._models,i=e.modelId,a=e.sourceUrl;return new Promise((function(e){void 0!==(r.find((function(e){return e.modelId===i}))||{}).model?e():n.loader.load(n.mergeSourceURL(a),(function(n){var i=n.scene.children[0];r[t].model=i,e()}),(function(e){}),(function(e){console.log("loader model fail"+e)}))}))}},{key:"loadModel",value:(l=h(A().mark((function e(){var t;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:null===this.loader&&(this.loader=new $),null===this._group&&(this._group=new o.Group,this.scene.add(this._group)),t=0;case 3:if(!(t<this._models.length)){e.next=9;break}return e.next=6,this.loadOneModel(this._models[t],t);case 6:t++,e.next=3;break;case 9:this.handleEvent("loadModelCompleted",{modelsMap:this._models});case 10:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"clearModel",value:function(){if(this._group){var e=this._group.children;do{this._group.remove(e[0])}while(e.length>0)}}},{key:"getModelConfById",value:function(e){return this._models.find((function(t){return t.modelId===e}))}},{key:"initMouseEvent",value:function(){this.container.addEventListener("click",this.handleContainerClick),this.map.on("zoomchange",this.handelViewChange),this.map.on("zoomend",this.handelZoomChange)}},{key:"handleContainerClick",value:function(e){var t=this._lastPickIndex,n=this._data;null!=t.index&&this.handleEvent("click",{screenX:null==e?void 0:e.clientX,screenY:null==e?void 0:e.clientY,attrs:n[t.index]})}},{key:"updateModel",value:(a=h(A().mark((function e(){var t,n,r;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.scene){e.next=2;break}return e.abrupt("return");case 2:if(!(this._data.length<=0)){e.next=5;break}return this.clear(),e.abrupt("return");case 5:return e.next=7,this.loadModel();case 7:return this.createMainMaterial(),e.next=10,this.createTrayMaterial();case 10:return e.next=12,this.createInstancedMeshes();case 12:this.clearModel(),t=this._models,n=0;case 15:if(!(n<t.length)){e.next=24;break}return e.next=18,this.updateInstancedMesh(t[n],this._data);case 18:r=e.sent,this._instancedMeshMap[t[n].modelId]=r,this._group.add(r);case 21:n++,e.next=15;break;case 24:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"updateMarker",value:function(){var e=this,t=this.map,n=this._conf.label.fieldName;this._data.forEach((function(r){if(r[n]<=0||["",void 0,null].includes(r[n]))e._labelMarkers.push(null);else{var i=S(r.lngLat,2),a=i[0],o=i[1],s=new AMap.Marker({offset:[-30,-15],position:[a,o,75*e._resolution],content:'<div class="gl-label-marker" style="width: 60px; color:#fff;text-align: center;font-weight: bold;">'.concat(r[n],"</div>"),map:t});e._labelMarkers.push(s)}}))}},{key:"clearLabelMarkers",value:function(){this.map&&this.map.remove(this._labelMarkers.filter((function(e){return null!==e}))),this._labelMarkers=[]}},{key:"setLabelMarkers",value:function(e){var t=e.altitude,n=void 0===t?0:t;this._labelMarkers.filter((function(e){return null!==e})).forEach((function(e){var t=e.getPosition(),r=t.lng,i=t.lat;e.setPosition([r,i,n])}))}},{key:"createTrayMaterial",value:(i=h(A().mark((function e(){var t,n,r,i,a,s;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new o.TextureLoader,e.next=3,t.loadAsync(this.mergeSourceURL("./static/texture/texture_wave_circle4.png"));case 3:n=e.sent,r=n.image,i=r.width,a=r.height,this._frameX=i/a,n.wrapS=n.wrapT=o.RepeatWrapping,n.repeat.set(1/this._frameX,1),s=new o.MeshStandardMaterial({color:"#ffffff",map:n,transparent:!0,opacity:.8,metalness:0,roughness:.6,depthTest:!0,depthWrite:!1}),this._mtMap.tray=s;case 10:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"createMainMaterial",value:function(){var e=this.getModelConfById("main").model.material.map,t=new o.MeshStandardMaterial({color:"#ffffff",side:o.FrontSide,transparent:!0,opacity:1,map:e});this._mtMap.main=t}},{key:"createInstancedMeshes",value:(r=h(A().mark((function e(){var t,n,r,i,a,s,l,u,c;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(t=this._models,n=this._data,r=this._mtMap,i=0;i<t.length;i++)a=t[i],s=a.model,l=a.modelId,u=r[l],(c=new o.InstancedMesh(s.geometry,u,n.length)).attrs={modelId:l},t[i].instancedMesh=c;case 2:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"updateInstancedMesh",value:(n=h(A().mark((function e(t,n){var r,i,a,o,s,l,u;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(r=t.instancedMesh,i=t.modelId,a=n.length,o=this._sizeMap[i],this._dummy.scale.set(o,o,o),s=0;s<a;s++)(l=n[s]).id,u=l.coords,this._dummy.position.set(u[0],u[1],this._altitudeMap[i]),this._dummy.updateMatrix(),r.setMatrixAt(s,this._dummy.matrix),r.setColorAt(s,this.getColorByColorField(n[s],s));return e.abrupt("return",r);case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"getModelById",value:function(e){return this._group.children.find((function(t){return t._attrs.id===e}))||null}},{key:"getMeshByModelId",value:function(e){return(null==this?void 0:this._instancedMeshMap[e])||null}},{key:"clear",value:function(){this._highLightIndexArray=[],this._lastPickIndex.index=null,this.clearModel(),this.renderer&&this.renderer.clear()}},{key:"update",value:function(e){var t,n=this,r=this._conf,i=this._maxAngle,a=this._highLightIndexArray,o=this._lastPickIndex,s=this._sizeMap;if(this._isAnimate){null!=this&&null!==(t=this._mtMap)&&void 0!==t&&null!==(t=t.tray)&&void 0!==t&&t.map&&(this._offset+=.6*r.traySpeed,this._mtMap.tray.map.offset.x=Math.floor(this._offset)/this._frameX);var l=this.getMeshByModelId("main");if(l){this._currentPosition+=this._moveDirection*this._mainAltitudeSpeed,this._currentPosition>=this._maxMainAltitude?(this._currentPosition=this._maxMainAltitude,this._moveDirection*=-1):this._currentPosition<=this._minMainAltitude&&(this._currentPosition=this._minMainAltitude,this._moveDirection*=-1),this._customRendererList.forEach((function(e){var t=e.data.renderer(Object.assign(r,{size:s.main,altitude:n._altitudeMap}));n.updateMatrixAt(l,t,e.index)})),this._currentAngle=(this._currentAngle+.05*r.rotateSpeed)%i;for(var u=0;u<a.length;u++){var c=a[u];if(!this._customRendererIds.includes(c)){var h=S(this._data[c].coords,2),d=h[0],f=h[1];this.updateMatrixAt(l,{size:s.main,position:[d,f,this._currentPosition],rotation:[0,0,this._currentAngle]},c)}}if(null!==o.index&&!this._customRendererIds.includes(o.index)){var p=S(this._data[o.index].coords,2),v=p[0],m=p[1];this.updateMatrixAt(l,{size:1.2*s.main,position:[v,m,this._currentPosition],rotation:[0,0,this._currentAngle]},o.index)}null!=l&&l.instanceMatrix&&(l.instanceMatrix.needsUpdate=!0)}}}},{key:"updatePOIMesh",value:function(){var e,t=this._sizeMap,n=this.getMeshByModelId("main"),r=this.getMeshByModelId("tray");null!=this&&null!==(e=this._mtMap)&&void 0!==e&&null!==(e=e.tray)&&void 0!==e&&e.map&&(this._mtMap.tray.map.offset.x=0),this._currentPosition=0;for(var i=0;i<this._data.length;i++){var a=S(this._data[i].coords,2),o=a[0],s=a[1];this.updateMatrixAt(n,{size:t.main,position:[o,s,this._altitudeMap.main+this.getRandomValue()],rotation:[0,0,0]},i),this.updateMatrixAt(r,{size:t.tray,position:[o,s,this._altitudeMap.tray+this.getRandomValue()],rotation:[0,0,0]},i)}null!=n&&n.instanceMatrix&&(n.instanceMatrix.needsUpdate=!0),null!=r&&r.instanceMatrix&&(r.instanceMatrix.needsUpdate=!0)}},{key:"getRandomValue",value:function(){return 2*Math.random()-1}},{key:"resetHeightLightIndexArray",value:function(){var e=this._highLightIndexArray;if(e.length>0)for(var t=this.getMeshByModelId("main"),n=this.getModelConfById("main").altitude,r=0;r<e.length;r++){var i=S(this._data[r].coords,2),a=i[0],o=i[1];this.updateMatrixAt(t,{size:this._sizeMap.main,position:[a,o,n],rotation:[0,0,0]},r)}this._highLightIndexArray=[]}},{key:"updateMatrixAt",value:function(e,t,n){if(e){var r=t.size,i=t.position,a=t.rotation,o=this._dummy;o.scale.set(r,r,r),o.position.set(i[0],i[1],i[2]),o.rotation.x=a[0],o.rotation.y=a[1],o.rotation.z=a[2],o.updateMatrix(),e.setMatrixAt(n,o.matrix)}}},{key:"lightUp",value:function(e){var t=this,n=e.map((function(e){return t._data.findIndex((function(t){return t.id===e}))}));this._highLightIndexArray=s.default.union(this._highLightIndexArray,s.default.without(n,-1))}},{key:"lightOff",value:function(e){var t=this,n=e.map((function(e){return t._data.findIndex((function(t){return t.id===e}))}));this._highLightIndexArray=s.default.difference(this._highLightIndexArray,n)}},{key:"switchLight",value:function(e){var t=this._data.findIndex((function(t){return t.id===e}));this._highLightIndexArray.includes(t)?this.lightOff([e]):this.lightUp([e])}},{key:"lightUpAll",value:function(){}},{key:"lightOffAll",value:function(){}}]);var n,r,i,a,l,u}(D);const Ft={name:"CopyShader",uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform float opacity;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\t\t\tgl_FragColor = opacity * texel;\n\n\n\t\t}"};class Bt{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}const zt=new e.OrthographicCamera(-1,1,1,-1,0,1),Vt=new e.BufferGeometry;Vt.setAttribute("position",new e.Float32BufferAttribute([-1,3,0,-1,-1,0,3,-1,0],3)),Vt.setAttribute("uv",new e.Float32BufferAttribute([0,2,0,0,2,0],2));class Gt{constructor(t){this._mesh=new e.Mesh(Vt,t)}dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,zt)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}}class jt extends Bt{constructor(t,n){super(),this.textureID=void 0!==n?n:"tDiffuse",t instanceof e.ShaderMaterial?(this.uniforms=t.uniforms,this.material=t):t&&(this.uniforms=e.UniformsUtils.clone(t.uniforms),this.material=new e.ShaderMaterial({name:void 0!==t.name?t.name:"unspecified",defines:Object.assign({},t.defines),uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader})),this.fsQuad=new Gt(this.material)}render(e,t,n){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=n.texture),this.fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}class Ht extends Bt{constructor(e,t){super(),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,n){const r=e.getContext(),i=e.state;let a,o;i.buffers.color.setMask(!1),i.buffers.depth.setMask(!1),i.buffers.color.setLocked(!0),i.buffers.depth.setLocked(!0),this.inverse?(a=0,o=1):(a=1,o=0),i.buffers.stencil.setTest(!0),i.buffers.stencil.setOp(r.REPLACE,r.REPLACE,r.REPLACE),i.buffers.stencil.setFunc(r.ALWAYS,a,4294967295),i.buffers.stencil.setClear(o),i.buffers.stencil.setLocked(!0),e.setRenderTarget(n),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),i.buffers.color.setLocked(!1),i.buffers.depth.setLocked(!1),i.buffers.color.setMask(!0),i.buffers.depth.setMask(!0),i.buffers.stencil.setLocked(!1),i.buffers.stencil.setFunc(r.EQUAL,1,4294967295),i.buffers.stencil.setOp(r.KEEP,r.KEEP,r.KEEP),i.buffers.stencil.setLocked(!0)}}class Wt extends Bt{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}class Xt{constructor(t,n){if(this.renderer=t,this._pixelRatio=t.getPixelRatio(),void 0===n){const r=t.getSize(new e.Vector2);this._width=r.width,this._height=r.height,(n=new e.WebGLRenderTarget(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:e.HalfFloatType})).texture.name="EffectComposer.rt1"}else this._width=n.width,this._height=n.height;this.renderTarget1=n,this.renderTarget2=n.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],this.copyPass=new jt(Ft),this.copyPass.material.blending=e.NoBlending,this.clock=new e.Clock}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);-1!==t&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){void 0===e&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let n=!1;for(let t=0,r=this.passes.length;t<r;t++){const r=this.passes[t];if(!1!==r.enabled){if(r.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(t),r.render(this.renderer,this.writeBuffer,this.readBuffer,e,n),r.needsSwap){if(n){const t=this.renderer.getContext(),n=this.renderer.state.buffers.stencil;n.setFunc(t.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),n.setFunc(t.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==Ht&&(r instanceof Ht?n=!0:r instanceof Wt&&(n=!1))}}this.renderer.setRenderTarget(t)}reset(t){if(void 0===t){const n=this.renderer.getSize(new e.Vector2);this._pixelRatio=this.renderer.getPixelRatio(),this._width=n.width,this._height=n.height,(t=this.renderTarget1.clone()).setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=t,this.renderTarget2=t.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const n=this._width*this._pixelRatio,r=this._height*this._pixelRatio;this.renderTarget1.setSize(n,r),this.renderTarget2.setSize(n,r);for(let e=0;e<this.passes.length;e++)this.passes[e].setSize(n,r)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}class Kt extends Bt{constructor(t,n,r=null,i=null,a=null){super(),this.scene=t,this.camera=n,this.overrideMaterial=r,this.clearColor=i,this.clearAlpha=a,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new e.Color}render(e,t,n){const r=e.autoClear;let i,a;e.autoClear=!1,null!==this.overrideMaterial&&(a=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),null!==this.clearColor&&(e.getClearColor(this._oldClearColor),e.setClearColor(this.clearColor)),null!==this.clearAlpha&&(i=e.getClearAlpha(),e.setClearAlpha(this.clearAlpha)),1==this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:n),!0===this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),null!==this.clearColor&&e.setClearColor(this._oldClearColor),null!==this.clearAlpha&&e.setClearAlpha(i),null!==this.overrideMaterial&&(this.scene.overrideMaterial=a),e.autoClear=r}}const Yt={shaderID:"luminosityHighPass",uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new e.Color(0)},defaultOpacity:{value:0}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform vec3 defaultColor;\n\t\tuniform float defaultOpacity;\n\t\tuniform float luminosityThreshold;\n\t\tuniform float smoothWidth;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\n\t\t\tvec3 luma = vec3( 0.299, 0.587, 0.114 );\n\n\t\t\tfloat v = dot( texel.xyz, luma );\n\n\t\t\tvec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );\n\n\t\t\tfloat alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );\n\n\t\t\tgl_FragColor = mix( outputColor, texel, alpha );\n\n\t\t}"};class Qt extends Bt{constructor(t,n,r,i){super(),this.strength=void 0!==n?n:1,this.radius=r,this.threshold=i,this.resolution=void 0!==t?new e.Vector2(t.x,t.y):new e.Vector2(256,256),this.clearColor=new e.Color(0,0,0),this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;let a=Math.round(this.resolution.x/2),o=Math.round(this.resolution.y/2);this.renderTargetBright=new e.WebGLRenderTarget(a,o,{type:e.HalfFloatType}),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(let t=0;t<this.nMips;t++){const n=new e.WebGLRenderTarget(a,o,{type:e.HalfFloatType});n.texture.name="UnrealBloomPass.h"+t,n.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(n);const r=new e.WebGLRenderTarget(a,o,{type:e.HalfFloatType});r.texture.name="UnrealBloomPass.v"+t,r.texture.generateMipmaps=!1,this.renderTargetsVertical.push(r),a=Math.round(a/2),o=Math.round(o/2)}const s=Yt;this.highPassUniforms=e.UniformsUtils.clone(s.uniforms),this.highPassUniforms.luminosityThreshold.value=i,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new e.ShaderMaterial({uniforms:this.highPassUniforms,vertexShader:s.vertexShader,fragmentShader:s.fragmentShader}),this.separableBlurMaterials=[];const l=[3,5,7,9,11];a=Math.round(this.resolution.x/2),o=Math.round(this.resolution.y/2);for(let t=0;t<this.nMips;t++)this.separableBlurMaterials.push(this.getSeperableBlurMaterial(l[t])),this.separableBlurMaterials[t].uniforms.invSize.value=new e.Vector2(1/a,1/o),a=Math.round(a/2),o=Math.round(o/2);this.compositeMaterial=this.getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=n,this.compositeMaterial.uniforms.bloomRadius.value=.1;this.compositeMaterial.uniforms.bloomFactors.value=[1,.8,.6,.4,.2],this.bloomTintColors=[new e.Vector3(1,1,1),new e.Vector3(1,1,1),new e.Vector3(1,1,1),new e.Vector3(1,1,1),new e.Vector3(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors;const u=Ft;this.copyUniforms=e.UniformsUtils.clone(u.uniforms),this.blendMaterial=new e.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:u.vertexShader,fragmentShader:u.fragmentShader,blending:e.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this._oldClearColor=new e.Color,this.oldClearAlpha=1,this.basic=new e.MeshBasicMaterial,this.fsQuad=new Gt(null)}dispose(){for(let e=0;e<this.renderTargetsHorizontal.length;e++)this.renderTargetsHorizontal[e].dispose();for(let e=0;e<this.renderTargetsVertical.length;e++)this.renderTargetsVertical[e].dispose();this.renderTargetBright.dispose();for(let e=0;e<this.separableBlurMaterials.length;e++)this.separableBlurMaterials[e].dispose();this.compositeMaterial.dispose(),this.blendMaterial.dispose(),this.basic.dispose(),this.fsQuad.dispose()}setSize(t,n){let r=Math.round(t/2),i=Math.round(n/2);this.renderTargetBright.setSize(r,i);for(let t=0;t<this.nMips;t++)this.renderTargetsHorizontal[t].setSize(r,i),this.renderTargetsVertical[t].setSize(r,i),this.separableBlurMaterials[t].uniforms.invSize.value=new e.Vector2(1/r,1/i),r=Math.round(r/2),i=Math.round(i/2)}render(e,t,n,r,i){e.getClearColor(this._oldClearColor),this.oldClearAlpha=e.getClearAlpha();const a=e.autoClear;e.autoClear=!1,e.setClearColor(this.clearColor,0),i&&e.state.buffers.stencil.setTest(!1),this.renderToScreen&&(this.fsQuad.material=this.basic,this.basic.map=n.texture,e.setRenderTarget(null),e.clear(),this.fsQuad.render(e)),this.highPassUniforms.tDiffuse.value=n.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this.fsQuad.material=this.materialHighPassFilter,e.setRenderTarget(this.renderTargetBright),e.clear(),this.fsQuad.render(e);let o=this.renderTargetBright;for(let t=0;t<this.nMips;t++)this.fsQuad.material=this.separableBlurMaterials[t],this.separableBlurMaterials[t].uniforms.colorTexture.value=o.texture,this.separableBlurMaterials[t].uniforms.direction.value=Qt.BlurDirectionX,e.setRenderTarget(this.renderTargetsHorizontal[t]),e.clear(),this.fsQuad.render(e),this.separableBlurMaterials[t].uniforms.colorTexture.value=this.renderTargetsHorizontal[t].texture,this.separableBlurMaterials[t].uniforms.direction.value=Qt.BlurDirectionY,e.setRenderTarget(this.renderTargetsVertical[t]),e.clear(),this.fsQuad.render(e),o=this.renderTargetsVertical[t];this.fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,e.setRenderTarget(this.renderTargetsHorizontal[0]),e.clear(),this.fsQuad.render(e),this.fsQuad.material=this.blendMaterial,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,i&&e.state.buffers.stencil.setTest(!0),this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(n),this.fsQuad.render(e)),e.setClearColor(this._oldClearColor,this.oldClearAlpha),e.autoClear=a}getSeperableBlurMaterial(t){const n=[];for(let e=0;e<t;e++)n.push(.39894*Math.exp(-.5*e*e/(t*t))/t);return new e.ShaderMaterial({defines:{KERNEL_RADIUS:t},uniforms:{colorTexture:{value:null},invSize:{value:new e.Vector2(.5,.5)},direction:{value:new e.Vector2(.5,.5)},gaussianCoefficients:{value:n}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform vec2 invSize;\n\t\t\t\tuniform vec2 direction;\n\t\t\t\tuniform float gaussianCoefficients[KERNEL_RADIUS];\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tfloat weightSum = gaussianCoefficients[0];\n\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv ).rgb * weightSum;\n\t\t\t\t\tfor( int i = 1; i < KERNEL_RADIUS; i ++ ) {\n\t\t\t\t\t\tfloat x = float(i);\n\t\t\t\t\t\tfloat w = gaussianCoefficients[i];\n\t\t\t\t\t\tvec2 uvOffset = direction * invSize * x;\n\t\t\t\t\t\tvec3 sample1 = texture2D( colorTexture, vUv + uvOffset ).rgb;\n\t\t\t\t\t\tvec3 sample2 = texture2D( colorTexture, vUv - uvOffset ).rgb;\n\t\t\t\t\t\tdiffuseSum += (sample1 + sample2) * w;\n\t\t\t\t\t\tweightSum += 2.0 * w;\n\t\t\t\t\t}\n\t\t\t\t\tgl_FragColor = vec4(diffuseSum/weightSum, 1.0);\n\t\t\t\t}"})}getCompositeMaterial(t){return new e.ShaderMaterial({defines:{NUM_MIPS:t},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\n\t\t\t\tuniform sampler2D blurTexture1;\n\t\t\t\tuniform sampler2D blurTexture2;\n\t\t\t\tuniform sampler2D blurTexture3;\n\t\t\t\tuniform sampler2D blurTexture4;\n\t\t\t\tuniform sampler2D blurTexture5;\n\t\t\t\tuniform float bloomStrength;\n\t\t\t\tuniform float bloomRadius;\n\t\t\t\tuniform float bloomFactors[NUM_MIPS];\n\t\t\t\tuniform vec3 bloomTintColors[NUM_MIPS];\n\n\t\t\t\tfloat lerpBloomFactor(const in float factor) {\n\t\t\t\t\tfloat mirrorFactor = 1.2 - factor;\n\t\t\t\t\treturn mix(factor, mirrorFactor, bloomRadius);\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tgl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );\n\t\t\t\t}"})}}Qt.BlurDirectionX=new e.Vector2(1,0),Qt.BlurDirectionY=new e.Vector2(0,1);var Zt=function(e){function t(e,n,r,i){return f(this,t),d(this,t,[e,n,r,i])}return _(t,e),v(t,[{key:"getSeperableBlurMaterial",value:function(e){for(var t=[],n=0;n<e;n++)t.push(.39894*Math.exp(-.5*n*n/(e*e))/e);return new o.ShaderMaterial({defines:{KERNEL_RADIUS:e},uniforms:{colorTexture:{value:null},invSize:{value:new o.Vector2(.5,.5)},direction:{value:new o.Vector2(.5,.5)},gaussianCoefficients:{value:t}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform vec2 invSize;\n\t\t\t\tuniform vec2 direction;\n\t\t\t\tuniform float gaussianCoefficients[KERNEL_RADIUS];\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tfloat weightSum = gaussianCoefficients[0];\n\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv ).rgb * weightSum;\n\t\t\t\t\tfloat alphaSum;\n\t\t\t\t\tfor( int i = 1; i < KERNEL_RADIUS; i ++ ) {\n\t\t\t\t\t\tfloat x = float(i);\n\t\t\t\t\t\tfloat w = gaussianCoefficients[i];\n\t\t\t\t\t\tvec2 uvOffset = direction * invSize * x;\n\t\t\t\t\t\tvec4 sample1 = texture2D( colorTexture, vUv + uvOffset );\n\t\t\t\t\t\tvec4 sample2 = texture2D( colorTexture, vUv - uvOffset );\n\t\t\t\t\t\tdiffuseSum += (sample1.rgb + sample2.rgb) * w;\n\t\t\t\t\t\talphaSum += (sample1.a + sample2.a) * w; //\n\t\t\t\t\t\tweightSum += 2.0 * w;\n\t\t\t\t\t}\n\t\t\t\t\t//gyrate: overwrite this line for alpha pass\n\t\t\t\t\t//gl_FragColor = vec4(diffuseSum/weightSum, 1.0);\n\t\t\t\t\tgl_FragColor = vec4(diffuseSum/weightSum, alphaSum/weightSum);\n\t\t\t\t}"})}}])}(Qt);const qt={uniforms:{tDiffuse:{value:null},toneMappingExposure:{value:1}},vertexShader:"\n\t\tprecision highp float;\n\n\t\tuniform mat4 modelViewMatrix;\n\t\tuniform mat4 projectionMatrix;\n\n\t\tattribute vec3 position;\n\t\tattribute vec2 uv;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\t\n\t\tprecision highp float;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\t"+e.ShaderChunk.tonemapping_pars_fragment+e.ShaderChunk.colorspace_pars_fragment+"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tgl_FragColor = texture2D( tDiffuse, vUv );\n\n\t\t\t// tone mapping\n\n\t\t\t#ifdef LINEAR_TONE_MAPPING\n\n\t\t\t\tgl_FragColor.rgb = LinearToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( REINHARD_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = ReinhardToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( CINEON_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = OptimizedCineonToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( ACES_FILMIC_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = ACESFilmicToneMapping( gl_FragColor.rgb );\n\n\t\t\t#endif\n\n\t\t\t// color space\n\n\t\t\t#ifdef SRGB_TRANSFER\n\n\t\t\t\tgl_FragColor = sRGBTransferOETF( gl_FragColor );\n\n\t\t\t#endif\n\n\t\t}"};class Jt extends Bt{constructor(){super();const t=qt;this.uniforms=e.UniformsUtils.clone(t.uniforms),this.material=new e.RawShaderMaterial({uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader}),this.fsQuad=new Gt(this.material),this._outputColorSpace=null,this._toneMapping=null}render(t,n,r){this.uniforms.tDiffuse.value=r.texture,this.uniforms.toneMappingExposure.value=t.toneMappingExposure,this._outputColorSpace===t.outputColorSpace&&this._toneMapping===t.toneMapping||(this._outputColorSpace=t.outputColorSpace,this._toneMapping=t.toneMapping,this.material.defines={},e.ColorManagement.getTransfer(this._outputColorSpace)===e.SRGBTransfer&&(this.material.defines.SRGB_TRANSFER=""),this._toneMapping===e.LinearToneMapping?this.material.defines.LINEAR_TONE_MAPPING="":this._toneMapping===e.ReinhardToneMapping?this.material.defines.REINHARD_TONE_MAPPING="":this._toneMapping===e.CineonToneMapping?this.material.defines.CINEON_TONE_MAPPING="":this._toneMapping===e.ACESFilmicToneMapping&&(this.material.defines.ACES_FILMIC_TONE_MAPPING=""),this.material.needsUpdate=!0),!0===this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(n),this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),this.fsQuad.render(t))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}const $t={uniforms:{tDiffuse:{value:null},resolution:{value:new e.Vector2(1/1024,1/512)}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\tprecision highp float;\n\n\tuniform sampler2D tDiffuse;\n\n\tuniform vec2 resolution;\n\n\tvarying vec2 vUv;\n\n\t// FXAA 3.11 implementation by NVIDIA, ported to WebGL by Agost Biro (biro@archilogic.com)\n\n\t//----------------------------------------------------------------------------------\n\t// File:        es3-keplerFXAAassetsshaders/FXAA_DefaultES.frag\n\t// SDK Version: v3.00\n\t// Email:       gameworks@nvidia.com\n\t// Site:        http://developer.nvidia.com/\n\t//\n\t// Copyright (c) 2014-2015, NVIDIA CORPORATION. All rights reserved.\n\t//\n\t// Redistribution and use in source and binary forms, with or without\n\t// modification, are permitted provided that the following conditions\n\t// are met:\n\t//  * Redistributions of source code must retain the above copyright\n\t//    notice, this list of conditions and the following disclaimer.\n\t//  * Redistributions in binary form must reproduce the above copyright\n\t//    notice, this list of conditions and the following disclaimer in the\n\t//    documentation and/or other materials provided with the distribution.\n\t//  * Neither the name of NVIDIA CORPORATION nor the names of its\n\t//    contributors may be used to endorse or promote products derived\n\t//    from this software without specific prior written permission.\n\t//\n\t// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ''AS IS'' AND ANY\n\t// EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\n\t// IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR\n\t// PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR\n\t// CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,\n\t// EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,\n\t// PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n\t// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY\n\t// OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n\t// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n\t// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n\t//\n\t//----------------------------------------------------------------------------------\n\n\t#ifndef FXAA_DISCARD\n\t\t\t//\n\t\t\t// Only valid for PC OpenGL currently.\n\t\t\t// Probably will not work when FXAA_GREEN_AS_LUMA = 1.\n\t\t\t//\n\t\t\t// 1 = Use discard on pixels which don't need AA.\n\t\t\t//     For APIs which enable concurrent TEX+ROP from same surface.\n\t\t\t// 0 = Return unchanged color on pixels which don't need AA.\n\t\t\t//\n\t\t\t#define FXAA_DISCARD 0\n\t#endif\n\n\t/*--------------------------------------------------------------------------*/\n\t#define FxaaTexTop(t, p) texture2D(t, p, -100.0)\n\t#define FxaaTexOff(t, p, o, r) texture2D(t, p + (o * r), -100.0)\n\t/*--------------------------------------------------------------------------*/\n\n\t#define NUM_SAMPLES 5\n\n\t// assumes colors have premultipliedAlpha, so that the calculated color contrast is scaled by alpha\n\tfloat contrast( vec4 a, vec4 b ) {\n\t\t\tvec4 diff = abs( a - b );\n\t\t\treturn max( max( max( diff.r, diff.g ), diff.b ), diff.a );\n\t}\n\n\t/*============================================================================\n\n\t\t\t\t\t\t\t\t\tFXAA3 QUALITY - PC\n\n\t============================================================================*/\n\n\t/*--------------------------------------------------------------------------*/\n\tvec4 FxaaPixelShader(\n\t\t\tvec2 posM,\n\t\t\tsampler2D tex,\n\t\t\tvec2 fxaaQualityRcpFrame,\n\t\t\tfloat fxaaQualityEdgeThreshold,\n\t\t\tfloat fxaaQualityinvEdgeThreshold\n\t) {\n\t\t\tvec4 rgbaM = FxaaTexTop(tex, posM);\n\t\t\tvec4 rgbaS = FxaaTexOff(tex, posM, vec2( 0.0, 1.0), fxaaQualityRcpFrame.xy);\n\t\t\tvec4 rgbaE = FxaaTexOff(tex, posM, vec2( 1.0, 0.0), fxaaQualityRcpFrame.xy);\n\t\t\tvec4 rgbaN = FxaaTexOff(tex, posM, vec2( 0.0,-1.0), fxaaQualityRcpFrame.xy);\n\t\t\tvec4 rgbaW = FxaaTexOff(tex, posM, vec2(-1.0, 0.0), fxaaQualityRcpFrame.xy);\n\t\t\t// . S .\n\t\t\t// W M E\n\t\t\t// . N .\n\n\t\t\tbool earlyExit = max( max( max(\n\t\t\t\t\tcontrast( rgbaM, rgbaN ),\n\t\t\t\t\tcontrast( rgbaM, rgbaS ) ),\n\t\t\t\t\tcontrast( rgbaM, rgbaE ) ),\n\t\t\t\t\tcontrast( rgbaM, rgbaW ) )\n\t\t\t\t\t< fxaaQualityEdgeThreshold;\n\t\t\t// . 0 .\n\t\t\t// 0 0 0\n\t\t\t// . 0 .\n\n\t\t\t#if (FXAA_DISCARD == 1)\n\t\t\t\t\tif(earlyExit) FxaaDiscard;\n\t\t\t#else\n\t\t\t\t\tif(earlyExit) return rgbaM;\n\t\t\t#endif\n\n\t\t\tfloat contrastN = contrast( rgbaM, rgbaN );\n\t\t\tfloat contrastS = contrast( rgbaM, rgbaS );\n\t\t\tfloat contrastE = contrast( rgbaM, rgbaE );\n\t\t\tfloat contrastW = contrast( rgbaM, rgbaW );\n\n\t\t\tfloat relativeVContrast = ( contrastN + contrastS ) - ( contrastE + contrastW );\n\t\t\trelativeVContrast *= fxaaQualityinvEdgeThreshold;\n\n\t\t\tbool horzSpan = relativeVContrast > 0.;\n\t\t\t// . 1 .\n\t\t\t// 0 0 0\n\t\t\t// . 1 .\n\n\t\t\t// 45 deg edge detection and corners of objects, aka V/H contrast is too similar\n\t\t\tif( abs( relativeVContrast ) < .3 ) {\n\t\t\t\t\t// locate the edge\n\t\t\t\t\tvec2 dirToEdge;\n\t\t\t\t\tdirToEdge.x = contrastE > contrastW ? 1. : -1.;\n\t\t\t\t\tdirToEdge.y = contrastS > contrastN ? 1. : -1.;\n\t\t\t\t\t// . 2 .      . 1 .\n\t\t\t\t\t// 1 0 2  ~=  0 0 1\n\t\t\t\t\t// . 1 .      . 0 .\n\n\t\t\t\t\t// tap 2 pixels and see which ones are \"outside\" the edge, to\n\t\t\t\t\t// determine if the edge is vertical or horizontal\n\n\t\t\t\t\tvec4 rgbaAlongH = FxaaTexOff(tex, posM, vec2( dirToEdge.x, -dirToEdge.y ), fxaaQualityRcpFrame.xy);\n\t\t\t\t\tfloat matchAlongH = contrast( rgbaM, rgbaAlongH );\n\t\t\t\t\t// . 1 .\n\t\t\t\t\t// 0 0 1\n\t\t\t\t\t// . 0 H\n\n\t\t\t\t\tvec4 rgbaAlongV = FxaaTexOff(tex, posM, vec2( -dirToEdge.x, dirToEdge.y ), fxaaQualityRcpFrame.xy);\n\t\t\t\t\tfloat matchAlongV = contrast( rgbaM, rgbaAlongV );\n\t\t\t\t\t// V 1 .\n\t\t\t\t\t// 0 0 1\n\t\t\t\t\t// . 0 .\n\n\t\t\t\t\trelativeVContrast = matchAlongV - matchAlongH;\n\t\t\t\t\trelativeVContrast *= fxaaQualityinvEdgeThreshold;\n\n\t\t\t\t\tif( abs( relativeVContrast ) < .3 ) { // 45 deg edge\n\t\t\t\t\t\t\t// 1 1 .\n\t\t\t\t\t\t\t// 0 0 1\n\t\t\t\t\t\t\t// . 0 1\n\n\t\t\t\t\t\t\t// do a simple blur\n\t\t\t\t\t\t\treturn mix(\n\t\t\t\t\t\t\t\t\trgbaM,\n\t\t\t\t\t\t\t\t\t(rgbaN + rgbaS + rgbaE + rgbaW) * .25,\n\t\t\t\t\t\t\t\t\t.4\n\t\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\thorzSpan = relativeVContrast > 0.;\n\t\t\t}\n\n\t\t\tif(!horzSpan) rgbaN = rgbaW;\n\t\t\tif(!horzSpan) rgbaS = rgbaE;\n\t\t\t// . 0 .      1\n\t\t\t// 1 0 1  ->  0\n\t\t\t// . 0 .      1\n\n\t\t\tbool pairN = contrast( rgbaM, rgbaN ) > contrast( rgbaM, rgbaS );\n\t\t\tif(!pairN) rgbaN = rgbaS;\n\n\t\t\tvec2 offNP;\n\t\t\toffNP.x = (!horzSpan) ? 0.0 : fxaaQualityRcpFrame.x;\n\t\t\toffNP.y = ( horzSpan) ? 0.0 : fxaaQualityRcpFrame.y;\n\n\t\t\tbool doneN = false;\n\t\t\tbool doneP = false;\n\n\t\t\tfloat nDist = 0.;\n\t\t\tfloat pDist = 0.;\n\n\t\t\tvec2 posN = posM;\n\t\t\tvec2 posP = posM;\n\n\t\t\tint iterationsUsed = 0;\n\t\t\tint iterationsUsedN = 0;\n\t\t\tint iterationsUsedP = 0;\n\t\t\tfor( int i = 0; i < NUM_SAMPLES; i++ ) {\n\t\t\t\t\titerationsUsed = i;\n\n\t\t\t\t\tfloat increment = float(i + 1);\n\n\t\t\t\t\tif(!doneN) {\n\t\t\t\t\t\t\tnDist += increment;\n\t\t\t\t\t\t\tposN = posM + offNP * nDist;\n\t\t\t\t\t\t\tvec4 rgbaEndN = FxaaTexTop(tex, posN.xy);\n\t\t\t\t\t\t\tdoneN = contrast( rgbaEndN, rgbaM ) > contrast( rgbaEndN, rgbaN );\n\t\t\t\t\t\t\titerationsUsedN = i;\n\t\t\t\t\t}\n\n\t\t\t\t\tif(!doneP) {\n\t\t\t\t\t\t\tpDist += increment;\n\t\t\t\t\t\t\tposP = posM - offNP * pDist;\n\t\t\t\t\t\t\tvec4 rgbaEndP = FxaaTexTop(tex, posP.xy);\n\t\t\t\t\t\t\tdoneP = contrast( rgbaEndP, rgbaM ) > contrast( rgbaEndP, rgbaN );\n\t\t\t\t\t\t\titerationsUsedP = i;\n\t\t\t\t\t}\n\n\t\t\t\t\tif(doneN || doneP) break;\n\t\t\t}\n\n\n\t\t\tif ( !doneP && !doneN ) return rgbaM; // failed to find end of edge\n\n\t\t\tfloat dist = min(\n\t\t\t\t\tdoneN ? float( iterationsUsedN ) / float( NUM_SAMPLES - 1 ) : 1.,\n\t\t\t\t\tdoneP ? float( iterationsUsedP ) / float( NUM_SAMPLES - 1 ) : 1.\n\t\t\t);\n\n\t\t\t// hacky way of reduces blurriness of mostly diagonal edges\n\t\t\t// but reduces AA quality\n\t\t\tdist = pow(dist, .5);\n\n\t\t\tdist = 1. - dist;\n\n\t\t\treturn mix(\n\t\t\t\t\trgbaM,\n\t\t\t\t\trgbaN,\n\t\t\t\t\tdist * .5\n\t\t\t);\n\t}\n\n\tvoid main() {\n\t\t\tconst float edgeDetectionQuality = .2;\n\t\t\tconst float invEdgeDetectionQuality = 1. / edgeDetectionQuality;\n\n\t\t\tgl_FragColor = FxaaPixelShader(\n\t\t\t\t\tvUv,\n\t\t\t\t\ttDiffuse,\n\t\t\t\t\tresolution,\n\t\t\t\t\tedgeDetectionQuality, // [0,1] contrast needed, otherwise early discard\n\t\t\t\t\tinvEdgeDetectionQuality\n\t\t\t);\n\n\t}\n\t"};var en=function(e){function t(e){var n;f(this,t),m(n=d(this,t,[e]),"id",null),m(n,"map",null),m(n,"_conf",{layer:null,zIndex:120}),m(n,"_customLayer",null),m(n,"_visible",!0),m(n,"_canvas",null),m(n,"_composer",null),m(n,"_bloomPass",null),m(n,"_renderer",null),m(n,"_composerList",[]),m(n,"_style",{threshold:0,strength:1,radius:1.5,fxxa:!0});var r=s.default.merge(n._conf,e);return n._style=s.default.merge(n._style,r.style),n.id=e.id||(new Date).getTime().toString(),n.map=e.map,n.map?(n.bindMethods(["animate","resizeLayer","setLayerVisible"]),n.init(),n):(console.error("缺少地图对象"),M(n))}return _(t,e),v(t,[{key:"bindMethods",value:function(e){var t=this;e.forEach((function(e){t[e]=t[e].bind(t)}))}},{key:"visible",get:function(){return this._visible},set:function(e){this._visible=e,this._customLayer[e?"show":"hide"]()}},{key:"init",value:(n=h(A().mark((function e(){return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.createLayer();case 2:this.initComposer(),this.animate(),this.addModuleListener(),this.handleEvent("init",this);case 6:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"add",value:function(e){var t=this.createComposer(e),n=this.createPassShader(t,{mode:0,visible:e.getVisible()});this._composerList.push(t);var r=this._composerList.length;this._composer.insertPass(n,r),e.on("visibleChange",this.setLayerVisible)}},{key:"remove",value:function(e){var t=this._composerList.findIndex((function(t){return t.passes[0].scene===e.scene}));t>-1&&(this._composerList.splice(t,1),this._composer.passes.splice(t+1,1)),0===this._composerList.length&&this._composer.renderer.clear(),e.off("visibleChange",this.setLayerVisible)}},{key:"setLayerVisible",value:function(e,t){var n=this._composerList.findIndex((function(e){return e.passes[0].scene===t.scene}));n>-1&&(this._composer.passes[n+1].enabled=e)}},{key:"clear",value:function(){this._composer&&(this._composer.passes.length=0),this._composerList.forEach((function(e){e.dispose()})),this._composerList=[],this._composer.renderer.clear()}},{key:"createComposer",value:function(e){var t=e.scene,n=e.camera,r=new Xt(this._renderer);r.renderToScreen=!1;var i=new Kt(t,n);return i.clear=!0,i.clearDepth=!1,r.addPass(i),r}},{key:"createPassShader",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{mode:0,visible:!0},n=t.mode,r=new jt(new o.ShaderMaterial({uniforms:{baseTexture:{value:null},coverTexture:{value:null},mode:{value:n}},vertexShader:"\n          varying vec2 vUv;\n          void main() {\n              vUv = uv;\n              gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n          }\n      ",fragmentShader:"\n          uniform sampler2D baseTexture;\n          uniform sampler2D coverTexture;\n          uniform int mode;\n          varying vec2 vUv;\n          void main() {\n\n            vec4 baseColor = texture2D(baseTexture, vUv);\n            vec4 bloomColor = texture2D(coverTexture, vUv);\n\n            if(mode == 0){\n              gl_FragColor = ( baseColor + vec4( 1.0 ) * bloomColor );\n            }else if(mode == 1){\n              gl_FragColor = bloomColor * (1.0 - baseColor.a) + baseColor;\n            }else if(mode ==2){\n              gl_FragColor = baseColor * (1.0 - bloomColor.a) + bloomColor;\n            }\n          }\n      ",defines:{}}),"baseTexture");return r.uniforms.coverTexture.value=e.renderTarget2.texture,r.renderToScreen=!0,r.needsSwap=!0,r.enabled=t.visible,r}},{key:"createRenderer",value:function(){var e=this.getScale(),t=e.width,n=e.height,r=new o.WebGLRenderer({context:this._canvas.getContext("webgl"),alpha:!0,depth:!0});return r.autoClear=!0,r.setClearAlpha(0),r.setSize(t,n),r}},{key:"animate",value:function(e){if(void 0!==this){var t=this._composerList,n=this._composer;t&&t.length&&(t.forEach((function(e){e.render()})),n.render()),requestAnimationFrame(this.animate)}}},{key:"initComposer",value:function(){var e=this.createRenderer(),t=new Xt(e),n=new Kt(new o.Scene,new o.Camera);n.clear=!0,t.addPass(n);var r=this.createBloomPass(this._conf.style);t.addPass(r),this._style.fxxa&&t.addPass(this.createFXAAPass()),t.addPass(this.createOutputPass()),this._bloomPass=r,this._composer=t,this._renderer=e}},{key:"createFXAAPass",value:function(){var e=this.getScale(),t=e.width,n=e.height,r=new jt($t);return r.uniforms.resolution.value.set(1/t,1/n),r}},{key:"createBloomPass",value:function(e){var t=e.threshold,n=e.strength,r=e.radius,i=this.getScale(),a=i.width,s=i.height;return new Zt(new o.Vector2(a,s),n,r,t)}},{key:"createOutputPass",value:function(){var e=new Jt;return e.clear=!1,e}},{key:"createLayer",value:function(){var e=this;return new Promise((function(t,n){var r=e.getScale(),i=r.width,a=r.height,o=document.createElement("canvas");o.width=i,o.height=a,o.style.cssText="width: ".concat(i,"px; height: ").concat(a,"px;"),o.setAttribute("belong","effect"),e._canvas=o,e._customLayer=new AMap.CustomLayer(o,{zooms:[2,22],alwaysRender:!0}),e.map.add(e._customLayer),t()}))}},{key:"updatePass",value:function(){this._bloomPass&&(this._bloomPass.threshold=this._style.threshold,this._bloomPass.strength=this._style.strength,this._bloomPass.radius=this._style.radius)}},{key:"setStyle",value:function(e){this._style=s.default.merge(this._style,e),this.updatePass()}},{key:"toggle",value:function(){var e=this._visible;this[e?"hide":"show"](),this._visible=!e}},{key:"show",value:function(){this._canvas&&(this._canvas.style.display="block")}},{key:"hide",value:function(){this._canvas&&(this._canvas.style.display="none")}},{key:"destroy",value:function(){for(var e in this.removeModuleListener(),this.clear(),this._customLayer&&(this.map.remove(this._customLayer),this._customLayer.destroy()),this)delete this[e]}},{key:"addModuleListener",value:function(){window.addEventListener("resize",this.resizeLayer)}},{key:"removeModuleListener",value:function(){window.removeEventListener("resize",this.resizeLayer)}},{key:"resizeLayer",value:function(){var e=this.getScale(),t=e.width,n=e.height;this._canvas&&(this._canvas.width=t,this._canvas.height=n,this._canvas.style.width=t+"px",this._canvas.style.height=n+"px"),this._composer&&this._composer.setSize(t,n),this._renderer&&this._renderer.setSize(t,n)}},{key:"getScale",value:function(){var e=this.map.getContainer();return{width:e.clientWidth,height:e.clientHeight}}}]);var n}(P),tn=function(e,t){var n,r,i,a,o,s,l,u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,c=t&&t.length,h=c?t[0]*u:e.length,d=nn(e,0,h,u,!0),f=[];if(!d||d.next===d.prev)return f;if(c&&(d=function(e,t,n,r){var i,a,o,s=[];for(i=0,a=t.length;i<a;i++)(o=nn(e,t[i]*r,i<a-1?t[i+1]*r:e.length,r,!1))===o.next&&(o.steiner=!0),s.push(pn(o));for(s.sort(cn),i=0;i<s.length;i++)n=hn(s[i],n);return n}(e,t,d,u)),e.length>80*u){n=i=e[0],r=a=e[1];for(var p=u;p<h;p+=u)(o=e[p])<n&&(n=o),(s=e[p+1])<r&&(r=s),o>i&&(i=o),s>a&&(a=s);l=0!==(l=Math.max(i-n,a-r))?32767/l:0}return an(d,f,u,n,r,l,0),f};function nn(e,t,n,r,i){var a,o;if(i===function(e,t,n,r){for(var i=0,a=t,o=n-r;a<n;a+=r)i+=(e[o]-e[a])*(e[a+1]+e[o+1]),o=a;return i}(e,t,n,r)>0)for(a=t;a<n;a+=r)o=An(a,e[a],e[a+1],o);else for(a=n-r;a>=t;a-=r)o=An(a,e[a],e[a+1],o);return o&&yn(o,o.next)&&(Tn(o),o=o.next),o}function rn(e,t){if(!e)return e;t||(t=e);var n,r=e;do{if(n=!1,r.steiner||!yn(r,r.next)&&0!==gn(r.prev,r,r.next))r=r.next;else{if(Tn(r),(r=t=r.prev)===r.next)break;n=!0}}while(n||r!==t);return t}function an(e,t,n,r,i,a,o){if(e){!o&&a&&function(e,t,n,r){var i=e;do{0===i.z&&(i.z=fn(i.x,i.y,t,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==e);i.prevZ.nextZ=null,i.prevZ=null,function(e){var t,n,r,i,a,o,s,l,u=1;do{for(n=e,e=null,a=null,o=0;n;){for(o++,r=n,s=0,t=0;t<u&&(s++,r=r.nextZ);t++);for(l=u;s>0||l>0&&r;)0!==s&&(0===l||!r||n.z<=r.z)?(i=n,n=n.nextZ,s--):(i=r,r=r.nextZ,l--),a?a.nextZ=i:e=i,i.prevZ=a,a=i;n=r}a.nextZ=null,u*=2}while(o>1)}(i)}(e,r,i,a);for(var s,l,u=e;e.prev!==e.next;)if(s=e.prev,l=e.next,a?sn(e,r,i,a):on(e))t.push(s.i/n|0),t.push(e.i/n|0),t.push(l.i/n|0),Tn(e),e=l.next,u=l.next;else if((e=l)===u){o?1===o?an(e=ln(rn(e),t,n),t,n,r,i,a,2):2===o&&un(e,t,n,r,i,a):an(rn(e),t,n,r,i,a,1);break}}}function on(e){var t=e.prev,n=e,r=e.next;if(gn(t,n,r)>=0)return!1;for(var i=t.x,a=n.x,o=r.x,s=t.y,l=n.y,u=r.y,c=i<a?i<o?i:o:a<o?a:o,h=s<l?s<u?s:u:l<u?l:u,d=i>a?i>o?i:o:a>o?a:o,f=s>l?s>u?s:u:l>u?l:u,p=r.next;p!==t;){if(p.x>=c&&p.x<=d&&p.y>=h&&p.y<=f&&vn(i,s,a,l,o,u,p.x,p.y)&&gn(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function sn(e,t,n,r){var i=e.prev,a=e,o=e.next;if(gn(i,a,o)>=0)return!1;for(var s=i.x,l=a.x,u=o.x,c=i.y,h=a.y,d=o.y,f=s<l?s<u?s:u:l<u?l:u,p=c<h?c<d?c:d:h<d?h:d,v=s>l?s>u?s:u:l>u?l:u,m=c>h?c>d?c:d:h>d?h:d,g=fn(f,p,t,n,r),y=fn(v,m,t,n,r),_=e.prevZ,x=e.nextZ;_&&_.z>=g&&x&&x.z<=y;){if(_.x>=f&&_.x<=v&&_.y>=p&&_.y<=m&&_!==i&&_!==o&&vn(s,c,l,h,u,d,_.x,_.y)&&gn(_.prev,_,_.next)>=0)return!1;if(_=_.prevZ,x.x>=f&&x.x<=v&&x.y>=p&&x.y<=m&&x!==i&&x!==o&&vn(s,c,l,h,u,d,x.x,x.y)&&gn(x.prev,x,x.next)>=0)return!1;x=x.nextZ}for(;_&&_.z>=g;){if(_.x>=f&&_.x<=v&&_.y>=p&&_.y<=m&&_!==i&&_!==o&&vn(s,c,l,h,u,d,_.x,_.y)&&gn(_.prev,_,_.next)>=0)return!1;_=_.prevZ}for(;x&&x.z<=y;){if(x.x>=f&&x.x<=v&&x.y>=p&&x.y<=m&&x!==i&&x!==o&&vn(s,c,l,h,u,d,x.x,x.y)&&gn(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}function ln(e,t,n){var r=e;do{var i=r.prev,a=r.next.next;!yn(i,a)&&_n(i,r,r.next,a)&&bn(i,a)&&bn(a,i)&&(t.push(i.i/n|0),t.push(r.i/n|0),t.push(a.i/n|0),Tn(r),Tn(r.next),r=e=a),r=r.next}while(r!==e);return rn(r)}function un(e,t,n,r,i,a){var o=e;do{for(var s=o.next.next;s!==o.prev;){if(o.i!==s.i&&mn(o,s)){var l=Mn(o,s);return o=rn(o,o.next),l=rn(l,l.next),an(o,t,n,r,i,a,0),void an(l,t,n,r,i,a,0)}s=s.next}o=o.next}while(o!==e)}function cn(e,t){return e.x-t.x}function hn(e,t){var n=function(e,t){var n,r=t,i=-1/0,a=e.x,o=e.y;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var s=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=a&&s>i&&(i=s,n=r.x<r.next.x?r:r.next,s===a))return n}r=r.next}while(r!==t);if(!n)return null;var l,u=n,c=n.x,h=n.y,d=1/0;r=n;do{a>=r.x&&r.x>=c&&a!==r.x&&vn(o<h?a:i,o,c,h,o<h?i:a,o,r.x,r.y)&&(l=Math.abs(o-r.y)/(a-r.x),bn(r,e)&&(l<d||l===d&&(r.x>n.x||r.x===n.x&&dn(n,r)))&&(n=r,d=l)),r=r.next}while(r!==u);return n}(e,t);if(!n)return t;var r=Mn(n,e);return rn(r,r.next),rn(n,n.next)}function dn(e,t){return gn(e.prev,e,t.prev)<0&&gn(t.next,e,e.next)<0}function fn(e,t,n,r,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*i|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-r)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function pn(e){var t=e,n=e;do{(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next}while(t!==e);return n}function vn(e,t,n,r,i,a,o,s){return(i-o)*(t-s)>=(e-o)*(a-s)&&(e-o)*(r-s)>=(n-o)*(t-s)&&(n-o)*(a-s)>=(i-o)*(r-s)}function mn(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&_n(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&(bn(e,t)&&bn(t,e)&&function(e,t){var n=e,r=!1,i=(e.x+t.x)/2,a=(e.y+t.y)/2;do{n.y>a!=n.next.y>a&&n.next.y!==n.y&&i<(n.next.x-n.x)*(a-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==e);return r}(e,t)&&(gn(e.prev,e,t.prev)||gn(e,t.prev,t))||yn(e,t)&&gn(e.prev,e,e.next)>0&&gn(t.prev,t,t.next)>0)}function gn(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function yn(e,t){return e.x===t.x&&e.y===t.y}function _n(e,t,n,r){var i=wn(gn(e,t,n)),a=wn(gn(e,t,r)),o=wn(gn(n,r,e)),s=wn(gn(n,r,t));return i!==a&&o!==s||(!(0!==i||!xn(e,n,t))||(!(0!==a||!xn(e,r,t))||(!(0!==o||!xn(n,e,r))||!(0!==s||!xn(n,t,r)))))}function xn(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function wn(e){return e>0?1:e<0?-1:0}function bn(e,t){return gn(e.prev,e,e.next)<0?gn(e,t,e.next)>=0&&gn(e,e.prev,t)>=0:gn(e,t,e.prev)<0||gn(e,e.next,t)<0}function Mn(e,t){var n=new Sn(e.i,e.x,e.y),r=new Sn(t.i,t.x,t.y),i=e.next,a=t.prev;return e.next=t,t.prev=e,n.next=i,i.prev=n,r.next=n,n.prev=r,a.next=r,r.prev=a,r}function An(e,t,n,r){var i=new Sn(e,t,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function Tn(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function Sn(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}var kn=function(e){function t(e){var n;f(this,t);var r=b({data:null,altitude:0,opacity:1,interact:!1,lineWidth:50,lineColor:"#FFFFFF",sizeAttenuation:1},e);return m(n=d(this,t,[r]),"_data",[]),m(n,"_lastPick",{mesh:null,opacity:null}),n.initData(r.data),n}return _(t,e),v(t,[{key:"initData",value:function(e){var t=this;e.features.forEach((function(e){var n=e.geometry,r=e.properties;switch(n.type){case"MultiPolygon":n.coordinates[0].forEach((function(e){t._data.push({path:t.customCoords.lngLatsToCoords(e),properties:r})}));break;case"Polygon":t._data.push({path:t.customCoords.lngLatsToCoords(n.coordinates[0]),properties:r})}})),console.log(this._data)}},{key:"onReady",value:function(){this.createMesh()}},{key:"getParentObject",value:function(e){var t=e.object;do{var n;if(["Scene","Group"].includes(null===(n=t.parent)||void 0===n?void 0:n.type))return t;t=t.parent}while(t)}},{key:"onPicked",value:function(e){var t,n,r=e.targets,i=e.event,a=null;if(r.length>0){var o=this.getParentObject(r[0]);o?(this.setLastPick(o),a=o._attrs):this.removeLastPick()}else this.removeLastPick();this.handleEvent("pick",{screenX:null==i||null===(t=i.pixel)||void 0===t?void 0:t.x,screenY:null==i||null===(n=i.pixel)||void 0===n?void 0:n.y,attrs:a})}},{key:"setLastPick",value:function(e){e&&(this.removeLastPick(),this._lastPick={mesh:e,opacity:e.material.opacity},e.material.opacity=.9)}},{key:"removeLastPick",value:function(){if(this._lastPick.mesh){var e=this._lastPick,t=e.mesh,n=e.opacity;t.material.opacity=n,this._lastPick={mesh:null,opacity:null}}}},{key:"createMesh",value:function(){var e=this;this._data.forEach((function(t){e.drawPolygon(t),e._conf.lineWidth>0&&e.drawLines(t)}))}},{key:"drawPolygon",value:function(e){for(var t=e.path,n=e.properties,r=this._conf,i=r.altitude,a=r.opacity,s=t.map((function(e){return[e[0],e[1],i]})).flat(),l=tn(s,null,3),u=new o.BufferGeometry,c=[],h=0;h<l.length;h++){var d=S(t[l[h]],3),f=d[0],p=d[1];d[2],c=[].concat(k(c),[f,p,i])}u.setAttribute("position",new o.BufferAttribute(new Float32Array(c),3)),u.computeVertexNormals();var v=new o.MeshBasicMaterial({color:n.color||"#0674F1",transparent:!0,opacity:n.opacity||a}),m=new o.Mesh(u,v);(this.group||this.scene).add(m)}},{key:"drawLines",value:function(e){var t=this,n=e.path;e.properties;var r=[];n.forEach((function(e){var n=S(e,3),i=n[0],a=n[1];n[2],r.push(new o.Vector3(i,a,t._conf.altitude+10))}));var i=new Z;i.setPoints(r);var a=new o.Mesh(i,this.getLineMaterial());(this.group||this.scene).add(a)}},{key:"getLineMaterial",value:function(){if(null==this._lineMaterial){var e=this._conf,t=e.sizeAttenuation,n=e.lineWidth,r=e.lineColor;this._lineMaterial=new q({useMap:0,color:new o.Color(r),opacity:1,depthTest:!0,sizeAttenuation:t?1:0,lineWidth:n})}return this._lineMaterial}},{key:"getRandomColor",value:function(){for(var e="#",t=0;t<6;t++)e+="0123456789ABCDEF"[Math.floor(16*Math.random())];return e}},{key:"update",value:function(){}}])}(D);class Cn{constructor(e=.1,t=6){this.maxEdgeLength=e,this.maxIterations=t}modify(t){null!==t.index&&(t=t.toNonIndexed());const n=this.maxIterations,r=this.maxEdgeLength*this.maxEdgeLength,i=new e.Vector3,a=new e.Vector3,o=new e.Vector3,s=new e.Vector3,l=[i,a,o,s],u=new e.Vector3,c=new e.Vector3,h=new e.Vector3,d=new e.Vector3,f=[u,c,h,d],p=new e.Color,v=new e.Color,m=new e.Color,g=new e.Color,y=[p,v,m,g],_=new e.Vector2,x=new e.Vector2,w=new e.Vector2,b=new e.Vector2,M=[_,x,w,b],A=new e.Vector2,T=new e.Vector2,S=new e.Vector2,k=new e.Vector2,C=[A,T,S,k],R=t.attributes,L=void 0!==R.normal,P=void 0!==R.color,E=void 0!==R.uv,I=void 0!==R.uv1;let O=R.position.array,D=L?R.normal.array:null,N=P?R.color.array:null,U=E?R.uv.array:null,F=I?R.uv1.array:null,B=O,z=D,V=N,G=U,j=F,H=0,W=!0;function X(e,t,n){const r=l[e],i=l[t],a=l[n];if(B.push(r.x,r.y,r.z),B.push(i.x,i.y,i.z),B.push(a.x,a.y,a.z),L){const r=f[e],i=f[t],a=f[n];z.push(r.x,r.y,r.z),z.push(i.x,i.y,i.z),z.push(a.x,a.y,a.z)}if(P){const r=y[e],i=y[t],a=y[n];V.push(r.x,r.y,r.z),V.push(i.x,i.y,i.z),V.push(a.x,a.y,a.z)}if(E){const r=M[e],i=M[t],a=M[n];G.push(r.x,r.y),G.push(i.x,i.y),G.push(a.x,a.y)}if(I){const r=C[e],i=C[t],a=C[n];j.push(r.x,r.y),j.push(i.x,i.y),j.push(a.x,a.y)}}for(;W&&H<n;){H++,W=!1,O=B,B=[],L&&(D=z,z=[]),P&&(N=V,V=[]),E&&(U=G,G=[]),I&&(F=j,j=[]);for(let e=0,t=0,n=O.length;e<n;e+=9,t+=6){i.fromArray(O,e+0),a.fromArray(O,e+3),o.fromArray(O,e+6),L&&(u.fromArray(D,e+0),c.fromArray(D,e+3),h.fromArray(D,e+6)),P&&(p.fromArray(N,e+0),v.fromArray(N,e+3),m.fromArray(N,e+6)),E&&(_.fromArray(U,t+0),x.fromArray(U,t+2),w.fromArray(U,t+4)),I&&(A.fromArray(F,t+0),T.fromArray(F,t+2),S.fromArray(F,t+4));const n=i.distanceToSquared(a),l=a.distanceToSquared(o),f=i.distanceToSquared(o);n>r||l>r||f>r?(W=!0,n>=l&&n>=f?(s.lerpVectors(i,a,.5),L&&d.lerpVectors(u,c,.5),P&&g.lerpColors(p,v,.5),E&&b.lerpVectors(_,x,.5),I&&k.lerpVectors(A,T,.5),X(0,3,2),X(3,1,2)):l>=n&&l>=f?(s.lerpVectors(a,o,.5),L&&d.lerpVectors(c,h,.5),P&&g.lerpColors(v,m,.5),E&&b.lerpVectors(x,w,.5),I&&k.lerpVectors(T,S,.5),X(0,1,3),X(3,2,0)):(s.lerpVectors(i,o,.5),L&&d.lerpVectors(u,h,.5),P&&g.lerpColors(p,m,.5),E&&b.lerpVectors(_,w,.5),I&&k.lerpVectors(A,S,.5),X(0,1,3),X(3,1,2))):X(0,1,2)}}const K=new e.BufferGeometry;return K.setAttribute("position",new e.Float32BufferAttribute(B,3)),L&&K.setAttribute("normal",new e.Float32BufferAttribute(z,3)),P&&K.setAttribute("color",new e.Float32BufferAttribute(V,3)),E&&K.setAttribute("uv",new e.Float32BufferAttribute(G,2)),I&&K.setAttribute("uv1",new e.Float32BufferAttribute(j,2)),K}}var Rn=function(e){function t(e){var n;f(this,t);var r=b({data:null,altitude:0,opacity:1,interact:!1,intensity:.9,lineWidth:100,lineColor:"#FFFFFF",sizeAttenuation:1,textureMapURL:null,normalMapURL:null,displacementMapURL:null,segment:15,sideTextureMapURL:"./static/texture/texture_cake_1.png"},e);return m(n=d(this,t,[r]),"_data",[]),m(n,"_lastPick",{mesh:null,opacity:null}),m(n,"_extRange",{minX:0,minY:0,maxX:0,maxY:0}),m(n,"_topMesh",null),m(n,"_topMeshProps",{}),m(n,"_sideMesh",null),m(n,"_sideMeshProps",{}),m(n,"_CANVAS_MAX_LEN",2e3),n.initData(r.data),n}return _(t,e),v(t,[{key:"initData",value:function(e){var t=this;e.features.forEach((function(e){var n=e.geometry,r=e.properties;switch(n.type){case"MultiPolygon":n.coordinates[0].forEach((function(e){t._data.push({path:t.customCoords.lngLatsToCoords(e),properties:r})}));break;case"Polygon":t._data.push({path:t.customCoords.lngLatsToCoords(n.coordinates[0]),properties:r})}})),console.log(this._data)}},{key:"onReady",value:(r=h(A().mark((function e(){return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.initExtRange(),e.next=3,this.initTexture();case 3:this.createTopMesh(),this._conf.altitude>0&&this.createSideMesh({height:this._conf.altitude}),this._conf.lineWidth>0&&this.createEdge(),this.initLight();case 7:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"initLight",value:function(){var e=this._conf.intensity,t=new o.DirectionalLight(16777215,1*e);t.position.set(1,1,1),this.scene.add(t);var n=new o.AmbientLight(4210752,2*e);this.scene.add(n)}},{key:"getParentObject",value:function(e){var t=e.object;do{var n;if("Scene"===(null===(n=t.parent)||void 0===n?void 0:n.type))return t;t=t.parent}while(t)}},{key:"onPicked",value:function(e){var t,n,r=e.targets,i=e.event,a=null;if(r.length>0){var o=this.getParentObject(r[0]);o?(this.setLastPick(o),a=o._attrs):this.removeLastPick()}else this.removeLastPick();this.handleEvent("pick",{screenX:null==i||null===(t=i.pixel)||void 0===t?void 0:t.x,screenY:null==i||null===(n=i.pixel)||void 0===n?void 0:n.y,attrs:a})}},{key:"setLastPick",value:function(e){e&&(this.removeLastPick(),this._lastPick={mesh:e,opacity:e.material.opacity},e.material.opacity=.9)}},{key:"removeLastPick",value:function(){if(this._lastPick.mesh){var e=this._lastPick,t=e.mesh,n=e.opacity;t.material.opacity=n,this._lastPick={mesh:null,opacity:null}}}},{key:"createEdge",value:function(){var e=this,t=this._data[0].path,n=[];t.forEach((function(t){var r=S(t,3),i=r[0],a=r[1];r[2],n.push(new o.Vector3(i,a,e._conf.altitude+20))}));var r=new Z;r.setPoints(n);var i=this._conf,a=i.sizeAttenuation,s=i.lineWidth,l=i.lineColor,u=new q({useMap:0,color:new o.Color(l),opacity:1,depthTest:!0,sizeAttenuation:a?1:0,lineWidth:s}),c=new o.Mesh(r,u);this.scene.add(c),this._edgeMesh=c}},{key:"getLineMaterial",value:function(){return null==this._lineMaterial&&(this._lineMaterial=new q({useMap:0,color:new o.Color(lineColor),opacity:1,depthTest:!0,sizeAttenuation:sizeAttenuation?1:0,lineWidth:lineWidth})),this._lineMaterial}},{key:"createTopMesh",value:function(){var e=this._conf,t=e.normalScale,n=e.displacementScale,r=this._topMeshProps,i=r.textureMap,a=r.normalMap,s=r.displacementMap,l=r.alphaMap;i.encoding=o.sRGBEncoding;var u=new o.MeshStandardMaterial({side:o.DoubleSide,map:i,normalMap:a,normalScale:new o.Vector2(t,t),alphaMap:l,displacementMap:s,displacementScale:n,displacementBias:0,wireframe:!1,transparent:!0,alphaTest:.1}),c=this.generateTopGeometry(),h=new o.Mesh(c,u);h.position.set(0,0,this._conf.altitude),this.scene.add(h),this._topMesh=h}},{key:"generateTopGeometry",value:function(){var e=this._conf.segment,t=this._extRange,n=t.minX,r=t.minY,i=t.maxX,a=t.maxY,s=[[n,r],[n,a],[i,a],[i,r]],l=new o.Shape;s.forEach((function(e,t){var n=S(e,2),r=n[0],i=n[1];0===t?l.moveTo(r,i):l.lineTo(r,i)}));var u=new o.ShapeGeometry(l);u=new Cn(.1,e).modify(u);var c=this.getGeometryUV(u),h=new o.BufferAttribute(c,2);return u.setAttribute("uv",h),u}},{key:"generateAlphaMap",value:function(){var e=this._data[0].path.map((function(e){var t=S(e,2),n=t[0],r=t[1];return new o.Vector3(n,r,0)})),t=this._extRange,n=t.minX,r=t.minY,i=t.maxX,a=t.maxY,s=Math.max(i-n,a-r),l=this._CANVAS_MAX_LEN/s,u=e.map((function(e){var t=(e.x-n)*l,i=(e.y-r)*l;return new o.Vector3(t,i,e.z)})),c=Math.ceil((i-n)*l),h=Math.ceil((a-r)*l),d=this.generateCanvas({width:c,height:h}),f=d.getContext("2d");f.fillStyle="#000000",f.fillRect(0,0,c,h),f.fillStyle="#FFFFFF",f.beginPath(),f.moveTo(u[0].x,u[0].y);for(var p=1;p<u.length;p++)f.lineTo(u[p].x,u[p].y);return f.closePath(),f.fill(),new o.CanvasTexture(d,null,o.RepeatWrapping,o.RepeatWrapping)}},{key:"generateCanvas",value:function(e){var t=e.width,n=e.height,r=document.createElement("canvas");r.width=t,r.height=n;var i=r.getContext("2d");return i.translate(0,n),i.scale(1,-1),r}},{key:"setSegment",value:function(e){this._conf.segment=e,this._topMesh.geometry=this.generateTopGeometry()}},{key:"initTexture",value:(n=h(A().mark((function e(){var t,n,r,i,a,s;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=["textureMap","normalMap","displacementMap"],n=0;case 2:if(!(n<t.length)){e.next=14;break}return r=t[n],i=this._conf["".concat(r,"URL")],e.next=7,(new o.TextureLoader).load(i);case 7:(a=e.sent).wrapS=o.RepeatWrapping,a.wrapT=o.RepeatWrapping,this._topMeshProps[r]=a;case 11:n++,e.next=2;break;case 14:return this._topMeshProps.alphaMap=this.generateAlphaMap(),e.next=17,(new o.TextureLoader).load(this._conf.sideTextureMapURL);case 17:(s=e.sent).wrapS=o.RepeatWrapping,s.wrapT=o.RepeatWrapping,s.offset.set(0,1),this._sideMeshProps.textureMap=s;case 22:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"initExtRange",value:function(){for(var e=this._data[0].path,t=e[0][0],n=e[0][1],r=e[0][0],i=e[0][1],a=0;a<e.length;a+=3){var o=S(e[a],2),s=o[0],l=o[1];s<t?t=s:s>r&&(r=s),l<n?n=l:l>i&&(i=l)}this._extRange={minX:t,minY:n,maxX:r,maxY:i}}},{key:"getGeometryUV",value:function(e){for(var t=e.attributes.position.count,n=new Float32Array(2*t),r=this._extRange,i=r.minX,a=r.minY,o=r.maxX,s=r.maxY,l=0;l<t;l++){var u=2*l,c=(e.attributes.position.getX(l)-i)/(o-i),h=(e.attributes.position.getY(l)-a)/(s-a);n[u]=c,n[u+1]=h}return n}},{key:"createSideGeometry",value:function(e,t){var n=t.height;e[0].toString()!==e[e.length-1].toString()&&e.push(e[0]);for(var r=[],i=[],a=[],s=[0,0],l=[1,0],u=[1,1],c=[0,1],h=0;h<e.length;h++){var d=S(e[h],3),f=d[0],p=d[1],v=d[2];r.push([f,p,0]),r.push([f,p,void 0!==v?v:n])}for(var m=0;m<r.length-2;m++)m%2==0?(i=[].concat(k(i),k(r[m]),k(r[m+2]),k(r[m+1])),a=[].concat(k(a),s,l,c)):(i=[].concat(k(i),k(r[m]),k(r[m+1]),k(r[m+2])),a=[].concat(k(a),c,l,u));var g=new o.BufferGeometry;return g.setAttribute("position",new o.BufferAttribute(new Float32Array(i),3)),g.setAttribute("uv",new o.BufferAttribute(new Float32Array(a),2)),g}},{key:"createSideMesh",value:function(e){var t=e.height,n=void 0===t?0:t;if(e.name,!(n<=0)){var r=this._data[0].path,i=this.createSideGeometry(r,{height:n}),a=new o.MeshBasicMaterial({side:o.DoubleSide,transparent:!0,depthWrite:!0,map:this._sideMeshProps.textureMap}),s=new o.Mesh(i,a);this.scene.add(s),this._sideMesh=s}}},{key:"updateUniforms",value:function(e,t){this._topMesh.material.uniforms[e].value=t}},{key:"updateMaterial",value:function(e,t){this._topMesh.material[e]=t}},{key:"update",value:function(){}}]);var n,r}(D),Ln="\n      varying vec2 vUv;\n      varying vec3 v_position;\n      void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n          v_position = vec3(modelMatrix * vec4(position, 1.0));\n      }\n  ",Pn="   \n     varying vec2 vUv;\n     varying vec3 v_position;\n\n     uniform float innerCircleWidth;\n     uniform float circleWidth;\n     uniform float radius;\n     uniform float opacity;\n     uniform vec3 center;\n     uniform vec3 color;\n     uniform sampler2D textureMap;\n     uniform vec2 repeat;\n\n     void main() {\n       float dis = length(v_position - center);\n\n       // 不超过半径范围，且与波动有交集\n       if( dis < radius && dis < (innerCircleWidth + circleWidth) && dis > innerCircleWidth) {\n          // 计算当前片元的位置占整个圆环宽度的比例\n          float r = (dis - innerCircleWidth) / circleWidth;\n\n          // 透明度衰减起始点和终止点\n          float startDecay = radius * 0.5;\n          float endDecay = radius;\n\n          // 计算透明度\n          float alpha = 1.0;\n          if (dis > startDecay) {\n              alpha = 1.0 - (dis - startDecay) / (endDecay - startDecay);\n          }\n          if (dis >= endDecay) {\n              alpha = 0.0;\n          }         \n          \n          // 方案1： 纹理和颜色混合\n          gl_FragColor = mix(texture2D(textureMap, vUv * repeat), vec4(color, opacity), r);\n          // 叠加 过程透明度 和 位置透明度  \n          gl_FragColor.a *= alpha * r;\n\n          // 方案2：只显示纹理\n          // gl_FragColor = vec4(color, 1.0) * texture2D(textureMap, vUv);\n       }else {\n          // 丢弃片元不渲染\n          discard;\n       }        \n\n     }\n  ",En="\n      varying vec2 vUv;\n      void main() \n      {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n      }\n  ",In="   \n      const float PI = 3.14159265359;\n      const float TWO_PI = 6.28318530718;\n      // 边长数量\n      const int N = 3;\n      // 中间圆心的尺寸\n      const float r0 = 0.01;\n      // 蓝色闪烁点的尺寸\n      const float r_blue = 0.005;\n      // 红色闪烁点的尺寸\n      const float r_red = 0.005;\n      // 雷达完整尺寸占画布的比例\n      const float edge = 0.95;\n      const float offset = 0.05;\n      \n      // 动画时间\n      uniform float time;\n      // 扫描扇形范围叠加的纹理\n      uniform sampler2D textureMap;\n      varying vec2 vUv;\n      \n      // 绘制辐射直径\n      // 参数：当前像素坐标，指定绘制位置， 线宽\n      float plot(const vec2 st, const float pct, const float width)\n      {\n          return smoothstep(pct - width, pct, st.y) -  smoothstep(pct, pct + width, st.y);\n      }\n      \n      // 绘制雷达追踪到的多边形物体\n      // 参数：物体中心 边数  半径 画布位置\n      float drawPolygon(const vec2 polygonCenter, const int N, const float radius, vec2 pos)\n      {\n        pos = pos - polygonCenter;\n        float d = 0.0;\n        float a = atan(pos.x, pos.y);\n        float r = TWO_PI / float(N);\n        d = cos(floor(0.5 + a / r)*r - a)*length(pos);\n        return (1.0 - smoothstep(radius, radius + radius/10.0, d));\n      }\n      \n      // 生成圆盘的刻度\n      // 参数：当前角度 a， 刻度数量 gradNum， 圆盘半径 outRad， 刻度长 tickLen，刻度宽 tickWidth， r, 旋转速度\n      float gradations(const float a, const float gradNum, const float outRad, const float tickLen, const float tickWidth, const float r, const float move)\n      {\n      float f = step(0.0, cos((a + move)*gradNum) - tickWidth)*tickLen + (outRad - tickLen);\n          return 1.0 - step(f, r) * 1.0 - step(r, outRad - tickLen);\n      }\n            \n      void main(  )\n      {\n          // 屏幕像素坐标（从0到1）\n          vec2 uv = vUv;\n          // 圆心位置\n          vec2 pos = uv.xy - vec2(0.5, 0.5) ; \n             \n          // 扫描区域叠加的叠加纹理图\n          vec4 mapcol = texture2D(textureMap,uv) * vec4 (0.0, 0.85, 0.0, 1.0);\n            \n          vec3 color = vec3(0.0, 0.0, 0.0);\n          \n          float r = length(pos) * 2.0;\n          // 当前像素点的角度\n          float a = atan(pos.y, pos.x); \n          // 雷达扫描的角度\n          float an = PI - mod(time/ 1.0, TWO_PI); \n          // 被追踪物体的移动速度\n          float blipSpd = 3.0; \n          vec2 translate1 = vec2(cos(time/ blipSpd), sin(time/ blipSpd));\n          vec2 translate2 = vec2(sin(time/ blipSpd), cos(time/ blipSpd));\n          vec2 left1 = translate1 * 0.35;\n          vec2 right1 = -translate1 * 0.30;\n          vec2 left2 = translate2 * 0.15;\n          vec2 right2 = -translate2 * 0.25;\n                    \n          //  雷达扫描\n          float sn = step(PI/2.0, an) * step(-PI/2.0, (a + an)) * step(r, edge) * (1.0 - 0.55 * (a + (TWO_PI) - an));\n          float sw = step(an, a) * step(r, edge);\n          float s_blade = sw * (1.0 - (a - an) * 20.0);\n          float s = sw * (1.0 - 0.55 * (a - an));\n          s = max(sn,s);\n          float se = step(r, edge - 0.05);\n             \n          // 外圈圆\n          float s1 = smoothstep(edge - 0.00, edge + 0.01, r)* smoothstep(edge + 0.02, edge + 0.01, r);   \n             \n          // 同心圆：中心点 内圈 中圈          \n          float s0 = 1.0 - smoothstep(r0 / 2.0, r0, length(pos));\n          float smb = (1.0 - smoothstep(0.2, 0.2 + 0.01, length(pos))) * (1.0 - smoothstep(0.2 +0.01, 0.2, length(pos)));\n          float smr = (1.0 - smoothstep(0.3, 0.3 + 0.01, length(pos))) * (1.0 - smoothstep(0.3 +0.01, 0.3, length(pos)));\n          \n          // Circular concentric gradations\n          float gradNum = 120.0;\n          float tickWidth = 0.9;\n          const float tickLen = 0.04;\n          float outRad = edge;\n          float move = 0.0;\n          // 绘制外圈刻度\n          float sm = 0.75*gradations(a, gradNum, outRad, tickLen, tickWidth, r, move);   \n                       \n          gradNum = 36.0;\n          tickWidth = 0.95;\n          outRad = 0.6;\n          move = sin(time/10.0);\n          // 绘制中圈刻度\n          smr += 0.5*gradations(a, gradNum, outRad, tickLen, tickWidth, r, move);         \n         \n          outRad = 0.4;\n          move = cos(time/10.0);\n          // 绘制内圈刻度\n          smb += 0.5*gradations(a, gradNum, outRad, tickLen, tickWidth, r, move);\n          \n          // 8条辐射线\n          float sr = plot(pos, pos.x, 0.003) * step(r, edge - 0.06);\n          sr += plot(vec2(0.0, 0.0), pos.x, 0.002) * step(r, edge - 0.06);\n          sr += plot(vec2(0.0, 0.0), pos.y, 0.003) * step(r, edge - 0.06);\n          sr += plot(-pos, pos.x, 0.003) * step(r, edge - 0.06);\n          sr *= 0.75;\n      \n          // 蓝色圆形被追踪物体\n          vec2 st_trace1 = left2;\n          float s_trace1 = s * (1.0 - smoothstep(r_blue / 10.0, r_blue, length(pos - st_trace1)));\n          s_trace1 += s * (1.0 - smoothstep(r_blue / 10.0, r_blue, length(pos - st_trace1 + vec2(+offset, +offset))));\n          s_trace1 += s * (1.0 - smoothstep(r_blue / 10.0, r_blue, length(pos - st_trace1 + vec2(+2.0 *offset, +2.0 *offset))));\n          \n          vec2 st_trace2 = right1;\n          float s_trace2 = s * (1.0 - smoothstep(r_blue / 10.0, r_blue, length(pos - st_trace2)));\n          \n          // 红色三角形被追踪物体\n          vec2 st_trace3 = left1;\n          float st1 = s * (drawPolygon(st_trace3, N, r_red , pos));\n          st1 += s * (drawPolygon(st_trace3 + vec2(-offset, -offset), N, r_red, pos));\n          st1 += s * (drawPolygon(st_trace3 + vec2(+offset, -offset), N, r_red, pos));\n          \n          vec2 st_trace4 = right2;\n          float st2 = s * (drawPolygon(st_trace4, N, r_red, pos));  \n              \n          // 叠加扫描区域和纹理图\n          float s_grn = max(s * mapcol.y, s_blade);\n          // 叠加： 扫描区域， 中心点 辐射线 外圈刻度\n          s_grn = max(s_grn, (s0 +  sr + sm));\n          // 叠加：外 中 内圈  加强颜色：/0.5\n          s_grn += (s1  + smb  + smr) / 0.5 ; \n          \n          // 将被追踪物体置于顶部\n          float s_red = st1*2.0 + st2*2.0 + smr;          \n          float s_blue = max(s_trace1 + s_trace2, s_blade) + smb;\n          \n          if (s_trace1 > 0.0 || s_trace2 > 0.0) { \n            s_blue = max(s, s_blue); \n            s_grn = max(s_grn, s_blue); \n          }\n      \n          color += vec3(s_red , s_grn, s_blue);            \n          vec4 texColor = mapcol * s;\n          \n          // 过滤掉纯黑色背景\n          if (color == vec3(0.0, 0.0, 0.0)) {\n              discard;\n          }else{\n            gl_FragColor = vec4(color, s_red + s_grn + s_blue); \n          }\n      \n      }\n  ",On=function(e){function t(e){var n;f(this,t);var r=b({altitude:0,radius:1e3,duration:2e3,easingFunction:"Easing.Linear.None",textureMapURL:"./static/texture/ring_0.png",color:"#ffffff",opacity:1,mode:"rotate",rotateOptions:{direction:1,initAngle:0},spreadOptions:{initRadius:0,circleWidth:void 0,center:void 0}},e);return m(n=d(this,t,[r]),"_angle",0),m(n,"_spreadStep",0),m(n,"_mesh",null),m(n,"_tweenInstance",null),n.initData(r.data),n}return _(t,e),v(t,[{key:"initData",value:function(e){}},{key:"onReady",value:(l=h(A().mark((function e(){return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.initOptions(),this.initTween(),e.next=4,this.createMesh();case 4:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"initOptions",value:function(){var e=this._conf,t=e.mode,n=e.rotateOptions,r=e.spreadOptions,i=e.radius;switch(t){case"rotate":this._angle=n.initAngle;break;case"spread":this._spreadStep=Math.max(this._conf.radius/240,1);var a=r.circleWidth,o=r.center,s=r.initRadius,l=r.repeat;void 0===a&&(r.circleWidth=Math.max(1,parseInt(i/10))),void 0===s&&(r.initRadius=0),o instanceof Array==!1&&(r.center=[0,0]),l instanceof Array==!1&&(r.repeat=[1,1])}}},{key:"initTween",value:function(){var e=this,t={t:0},n=this._conf,r=n.duration,i=n.radius,a=n.mode,o=n.rotateOptions,s=n.spreadOptions,l=n.easingFunction;this._tweenInstance&&(this._tweenInstance.stop(),this._tweenInstance=null);var u=l.split(".").reduce((function(e,t){return e&&e[t]}),Et);this._tweenInstance=new bt(t).to({t:1},r).easing(u).onUpdate((function(){switch(a){case"rotate":e._angle>360?e._angle=o.initAngle:e._angle=o.initAngle+t.t*(360-o.initAngle)*o.direction,e._mesh.material.map.rotation=e._angle*Math.PI/180;break;case"spread":var n=e._mesh.material.uniforms.innerCircleWidth;n.value=s.initRadius+t.t*(i-s.initRadius),n.value>i&&(n.value=s.initRadius);break;case"radar":e._mesh.material.uniforms.time.value+=12/r}})).onComplete((function(){t.t=0,e._tweenInstance.stop().to({t:1},r).start()})).start()}},{key:"createMesh",value:(s=h(A().mark((function e(){var t,n,r,i,a,s,l;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this._conf,n=t.radius,r=t.altitude,i=t.mode,a=new o.PlaneGeometry(2*n,2*n),s=null,e.t0=i,e.next="rotate"===e.t0?6:"spread"===e.t0?10:"radar"===e.t0?14:18;break;case 6:return e.next=8,this.generateRotateMaterial();case 8:return s=e.sent,e.abrupt("break",19);case 10:return e.next=12,this.generateSpreadMaterial();case 12:return s=e.sent,e.abrupt("break",19);case 14:return e.next=16,this.generateRadarMaterial();case 16:return s=e.sent,e.abrupt("break",19);case 18:return e.abrupt("break",19);case 19:(l=new o.Mesh(a,s)).position.set(0,0,r),this.scene.add(l),this._mesh=l;case 23:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"generateRotateMaterial",value:(a=h(A().mark((function e(){var t,n,r,i,a,s;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._conf,n=t.textureMapURL,r=t.color,i=t.opacity,e.next=3,(new o.TextureLoader).load(n);case 3:return(a=e.sent).wrapS=o.ClampToEdgeWrapping,a.wrapT=o.ClampToEdgeWrapping,a.center=new o.Vector2(.5,.5),s=new o.MeshBasicMaterial({side:o.DoubleSide,map:a,transparent:!0,alphaTest:.01,opacity:i,color:r,depthWrite:!1}),e.abrupt("return",s);case 9:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"generateRadarMaterial",value:(i=h(A().mark((function e(){var t,n,r,i,a;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._conf.textureMapURL,n=En,r=In,e.next=4,(new o.TextureLoader).load(t);case 4:return i=e.sent,a=new o.ShaderMaterial({uniforms:{textureMap:{value:i},time:{value:0}},vertexShader:n,fragmentShader:r,transparent:!0,depthWrite:!1}),e.abrupt("return",a);case 7:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"generateSpreadMaterial",value:(r=h(A().mark((function e(){var t,n,r,i,a,s,l,u,c,h,d,f,p;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._conf,n=t.textureMapURL,r=t.radius,i=t.spreadOptions,a=t.color,s=i.initRadius,l=i.circleWidth,u=i.center,c=i.repeat,e.next=4,(new o.TextureLoader).load(n);case 4:return(h=e.sent).wrapS=o.RepeatWrapping,h.wrapT=o.RepeatWrapping,h.center=new o.Vector2(.5,.5),d=Ln,f=Pn,p=new o.ShaderMaterial({uniforms:{innerCircleWidth:{value:s},circleWidth:{value:l},color:{value:new o.Color(a||16777215)},opacity:{value:.8},center:{value:new o.Vector3(u[0],u[1])},radius:{value:r},textureMap:{value:h},repeat:{value:new o.Vector2(c[0],c[1])}},vertexShader:d,fragmentShader:f,transparent:!0,depthWrite:!1}),e.abrupt("return",p);case 11:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"setRadius",value:function(e){this._conf.radius=e;var t=new o.PlaneGeometry(2*e,2*e);this._mesh.geometry=t}},{key:"setDuration",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;this._conf.duration=e,this.initTween()}},{key:"setEasing",value:function(e){this._conf.easingFunction=e,this.initTween()}},{key:"setAltitude",value:function(e){this._mesh.position.set(0,0,e)}},{key:"updateMaterial",value:function(e,t){this._mesh.material[e]=t,"map"===e&&(this._texture=t)}},{key:"update",value:function(e){var t;void 0!==(null==this||null===(t=this._mesh)||void 0===t?void 0:t.material)&&this._tweenInstance&&this._tweenInstance.update()}},{key:"setMode",value:(n=h(A().mark((function e(t){var n;return A().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._conf.mode=t,this.initOptions(),this.initTween(),n=null,e.t0=t,e.next="rotate"===e.t0?7:"spread"===e.t0?11:"radar"===e.t0?15:19;break;case 7:return e.next=9,this.generateRotateMaterial();case 9:return n=e.sent,e.abrupt("break",20);case 11:return e.next=13,this.generateSpreadMaterial();case 13:return n=e.sent,e.abrupt("break",20);case 15:return e.next=17,this.generateRadarMaterial();case 17:return n=e.sent,e.abrupt("break",20);case 19:return e.abrupt("break",20);case 20:this._mesh.material=n;case 21:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})}]);var n,r,i,a,s,l}(D),Dn={Layer:D,LayerManager:N,BorderLayer:B,BuildingLayer:W,MonoBuildingLayer:X,CakeLayer:J,ModelLayer:Ye,MassModelLayer:Qe,FlowlineLayer:Ze,IconLayer:qe,PointIconLayer:et,PointsLayer:rt,ScatterLayer:it,SpriteLayer:at,TilesLayer:ct,WaterLayer:dt,TerrainLayer:vt,DrivingLayer:It,PolylineEditor:Ot,WeatherLayer:Dt,VideoLayer:Nt,POI3dLayer:Ut,EffectLayer:en,PolygonLayer:kn,TerrainPolygonLayer:Rn,HaloLayer:On,MaskLayer:function(e){function t(e){var n;f(this,t);var r=b({data:null,opacity:0,altitude:1},e);return m(n=d(this,t,[r]),"_paths",[]),void 0===r.data?(console.log("props data is required"),M(n)):(n.initData(r.data),n._data=r.data,n)}return _(t,e),v(t,[{key:"onReady",value:function(){this.createMesh()}},{key:"createMesh",value:function(){var e=this,t=this.getMaterial();this._paths.forEach((function(n){var r=e.generateGeometry(n),i=new o.Mesh(r,t);i.position.z=e._conf.altitude,e.scene.add(i)}))}},{key:"generateGeometry",value:function(e){var t=new o.Shape;return e.forEach((function(e,n){var r=S(e,2),i=r[0],a=r[1];0===n?t.moveTo(i,a):t.lineTo(i,a)})),new o.ShapeGeometry(t)}},{key:"initData",value:function(e){var t=this;e.features.forEach((function(e){e.geometry.coordinates.forEach((function(e){var n=e[0][0]instanceof Array?e[0]:e,r=t.customCoords.lngLatsToCoords(n);t._paths.push(r)}))}))}},{key:"getMaterial",value:function(){return new o.MeshBasicMaterial({color:16777215,opacity:0,side:o.DoubleSide,transparent:!0,alphaTest:0,depthWrite:!0})}},{key:"update",value:function(){}}])}(D),PictureLayer:function(e){function t(e){var n;return f(this,t),m(n=d(this,t,[b({data:null,extent:null,picUrl:null,opacity:1},e)]),"animTime",0),m(n,"_extent",[]),n.initData(),n}return _(t,e),v(t,[{key:"onReady",value:function(){this.createTexture()}},{key:"initData",value:function(){var e,t=this.customCoords.lngLatsToCoords(this._conf.extent);(e=this._extent).push.apply(e,k(t))}},{key:"createTexture",value:function(){var e=this,t=this.scene;(new o.TextureLoader).load(this._conf.picUrl,(function(n){n.encoding=o.sRGBEncoding,n.encoding=o.sRGBEncoding;var r=new o.PlaneGeometry(e._extent[1][0]-e._extent[0][0],e._extent[1][1]-e._extent[0][1]),i=new o.MeshBasicMaterial({transparent:!0,side:o.DoubleSide,depthWrite:!1,map:n,opacity:e._conf.opacity}),a=new o.Mesh(r,i);t.add(a),a.position.set((e._extent[0][0]+e._extent[1][0])/2,(e._extent[0][1]+e._extent[1][1])/2,0)}))}},{key:"update",value:function(){}}])}(D)};return window.GLlayers=Dn,Dn}));
